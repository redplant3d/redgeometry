var xi="{",Pi="}";function Mt(r,...t){let e={value:0},n="",s=0,i=!1,o=!1;for(let a=0;a<r.length;a++){let p=r[a];if(p===xi)if(!o)n+=r.substring(s,a),s=a+1,o=!0;else if(r[a-1]===xi)o=!1;else{i=!0;break}else if(p===Pi)if(o){let c=r.substring(s,a);n+=ua(t,e,c),s=a+1,o=!1}else if(r[a+1]===Pi)n+=r.substring(s,a),s=a+1,a=s;else{i=!0;break}}if(i||o)throw new Error("Invalid format string");return n+=r.substring(s),n}function ua(r,t,e){let n=Number.parseInt(e);return(Number.isNaN(n)||n<0)&&(n=t.value,t.value+=1),String(r[n])}var Ae=class{errorFn;infoFn;warnFn;constructor(t){this.errorFn=t.errorFn,this.infoFn=t.infoFn,this.warnFn=t.warnFn}static getStackTrace(t){let e=t.stack;if(e!==void 0){let n=e.indexOf(`
`);return e.substring(n)}else return}assert(t,e,...n){if(!t){let s=Mt(e,...n);this.errorFn(s)}}assertDebug(t,e,...n){}assertFn(t,e,...n){if(!t()){let s=Mt(e,...n);this.errorFn(s)}}assertFnDebug(t,e,...n){}error(t,...e){let n=Mt(t,...e);this.errorFn(n)}errorDebug(t,...e){}info(t,...e){let n=Mt(t,...e);this.infoFn(n)}infoDebug(t,...e){}warn(t,...e){let n=Mt(t,...e);this.warnFn(n)}warnDebug(t,...e){}};var x=new Ae({errorFn:console.error,warnFn:console.warn,infoFn:console.info});function le(r,t,...e){if(!r){let n=Mt(t??"Assertion failed",...e);throw new Error(n)}}function D(r,t,...e){}function U(r){let t=Mt("Object with value '{}' must not exist",r);throw new Error(t)}function F(r,...t){let e=Mt(r,...t);throw new Error(e)}var De=class{world;worldId;constructor(t,e){this.worldId=t,this.world=e}applyBuffer(t,e){let{world:n}=this;for(let s of t)n.writeData(s);for(let s of e)n.writeEvent(s)}queueData(t,e){this.world.writeData(t)}queueEvent(t,e){this.world.writeEvent(t)}queueEvents(t,e){this.world.writeEvents(t)}queueSchedule(t){this.executorAsync(t)}runScheduleAsync(t){return this.executorAsync(t)}async executorAsync(t){return await Promise.resolve(),this.world.runSchedule(t)}},de=class{remote;worldId;dataBuffer;eventBuffer;transfer;constructor(t,e){this.worldId=t,this.remote=e,this.dataBuffer=[],this.eventBuffer=[],this.transfer=[]}queueData(t,e){this.dataBuffer.push(t),e!==void 0&&this.transfer.push(...e)}queueEvent(t,e){this.eventBuffer.push(t),e!==void 0&&this.transfer.push(...e)}queueEvents(t,e){for(let n of t)this.eventBuffer.push(n);e!==void 0&&this.transfer.push(...e)}queueSchedule(t){let{remote:e,worldId:n,dataBuffer:s,eventBuffer:i,transfer:o}=this;e===void 0&&F("Unable to run stage for parent");let a={worldId:n,dataBuffer:s,eventBuffer:i,scheduleId:t};this.resetBuffer(),e.sendRequest(a,o)}resetBuffer(){this.dataBuffer=[],this.eventBuffer=[],this.transfer=[]}runScheduleAsync(t){let{remote:e,worldId:n,dataBuffer:s,eventBuffer:i,transfer:o}=this;e===void 0&&F("Unable to run stage for parent");let a={worldId:n,dataBuffer:s,eventBuffer:i,scheduleId:t};return this.resetBuffer(),e.sendRequestAsync(a,o)}},we=class{channelMap;children;context;id;parent;constructor(t,e,n,s,i){this.id=t,this.context=e,this.channelMap=n,this.children=s,this.parent=i}init(){let{channelMap:t,children:e,parent:n}=this;for(let{world:o,worldId:a}of t.values()){for(let p of t.values())p.worldId!==a&&o.addChannel(p.worldId,p);for(let p of e)for(let c of p.channelMap.values())o.addChannel(c.worldId,c);if(n!==void 0)for(let p of n.channelMap.values())o.addChannel(p.worldId,p)}let s=this.receiveResponse.bind(this),i=this.receiveRequest.bind(this);for(let o of e)o.remote.setReceiveResponseFn(s);n!==void 0&&n.remote.setReceiveRequestFn(i)}getChannel(t){let e=this.channelMap.get(t);return e===void 0&&F("Unable to find local world channel '{}'",t),e}async receiveRequest(t){let{worldId:e,scheduleId:n,dataBuffer:s,eventBuffer:i}=t.data,o=this.getChannel(e);o.applyBuffer(s,i),await o.world.runSchedule(n),this.sendResponse(t.messageId)}receiveResponse(t){for(let{worldId:e,dataBuffer:n,eventBuffer:s}of t.data)this.getChannel(e).applyBuffer(n,s)}sendResponse(t){let{parent:e}=this;if(e===void 0)return;let n=[],s=[];for(let i of e.channelMap.values())n.push({worldId:i.worldId,dataBuffer:i.dataBuffer,eventBuffer:i.eventBuffer}),s.push(...i.transfer),i.resetBuffer();e.remote.sendResponse(t,n,s)}};var Te=class{callbacks;currentMessageId;worker;requestReceiverId;requestSenderId;constructor(t,e,n){this.requestSenderId=t,this.requestReceiverId=e,this.callbacks=new Map,this.currentMessageId=0,this.worker=new Worker(n,{name:e})}sendRequest(t,e){let n={type:"AppMessageRequest",data:t,messageId:this.currentMessageId,senderId:this.requestSenderId};this.currentMessageId+=1,this.worker.postMessage(n,e)}async sendRequestAsync(t,e){let n={type:"AppMessageRequest",data:t,messageId:this.currentMessageId,senderId:this.requestSenderId},s=new Promise((i,o)=>{this.callbacks.set(this.currentMessageId,{resolve:i,reject:o})});return this.currentMessageId+=1,this.worker.postMessage(n,e),s}setReceiveResponseFn(t){this.worker.addEventListener("message",e=>{let{data:n}=e;t(n);let s=this.callbacks.get(n.messageId);s!==void 0&&(s.resolve(),this.callbacks.delete(n.messageId))})}},Oe=class{workerRef;responseReceiverId;responseSenderId;constructor(t,e){this.responseSenderId=t,this.responseReceiverId=e,this.workerRef=self}sendResponse(t,e,n){let s={type:"AppMessageResponse",data:e,messageId:t,senderId:this.responseSenderId};this.workerRef.postMessage(s,n)}setReceiveRequestFn(t){this.workerRef.addEventListener("message",e=>t(e.data))}};var Si=[{classType:Int8Array,serialize:r=>[...r],deserialize:r=>new Int8Array(r)},{classType:Int16Array,serialize:r=>[...r],deserialize:r=>new Int16Array(r)},{classType:Int32Array,serialize:r=>[...r],deserialize:r=>new Int32Array(r)},{classType:Uint8Array,serialize:r=>[...r],deserialize:r=>new Uint8Array(r)},{classType:Uint8ClampedArray,serialize:r=>[...r],deserialize:r=>new Uint8ClampedArray(r)},{classType:Uint16Array,serialize:r=>[...r],deserialize:r=>new Uint16Array(r)},{classType:Uint32Array,serialize:r=>[...r],deserialize:r=>new Uint32Array(r)},{classType:Float32Array,serialize:r=>[...r],deserialize:r=>new Float32Array(r)},{classType:Float64Array,serialize:r=>[...r],deserialize:r=>new Float64Array(r)},{classType:Set,serialize:r=>[...r],deserialize:r=>new Set(r)},{classType:Map,serialize:r=>[...r],deserialize:r=>new Map(r)}],Re=class{mappings;constructor(t){this.mappings=t??[]}add(t,e,n){this.mappings.push({classType:t,serialize:e,deserialize:n})}clear(){this.mappings=[]}deserialize(t){return JSON.parse(t,(e,n)=>{let s=n.type,i=n.data;if(s===void 0||i===void 0)return n;for(let o of this.mappings)if(o.classType.name===s)return o.deserialize(i);return x.warn("Unable to deserialize type '{}'",s),n})}serialize(t){return JSON.stringify(t,(e,n)=>{if(n==null)return n;let s=n.constructor;if(s===Boolean||s===Number||s===String||s===Object||s===Array)return n;for(let i of this.mappings)if(i.classType===s)return{type:i.classType.name,data:i.serialize(n)};return x.warn("Unable to serialize type '{}'",s.name),n})}};var We=class{entityId;componentEntries;entitiesChanged;entityEntries;constructor(){this.entityEntries=new Map,this.componentEntries=new Map,this.entitiesChanged=new Set,this.entityId=0}cleanup(){for(let t of this.componentEntries.values())t.changeFlags.clear();this.entitiesChanged.clear()}clear(){this.entityEntries.clear(),this.componentEntries.clear(),this.entitiesChanged.clear(),this.entityId=0}createEntity(t,e){let n=this.createEntityId(),s=0;if(t!==void 0){let o=this.getEntityEntryOrThrow(t);o.children===void 0&&(o.children=new Set),o.children.add(n),s=o.depth+1}let i={entityId:n,parent:t,children:void 0,depth:s};for(let o of e){let a=this.getComponentEntry(o.componentId);la(a,n,o)}return this.entityEntries.set(n,i),this.entitiesChanged.add(n),n}createHierarchySelector(){return new Be(this.entityEntries)}deleteComponent(t,e){let n=this.getComponentEntryOrThrow(e);return Ei(n,t)}destroyEntity(t){let e=this.getEntityEntryOrThrow(t);for(let n of this.componentEntries.values())Ei(n,t);if(e.parent!==void 0){let n=this.getEntityEntryOrThrow(e.parent);n.children!==void 0&&n.children.delete(t)}if(e.children!==void 0)for(let n of e.children)this.destroyEntity(n);return this.entityEntries.delete(t),this.entitiesChanged.add(t),!0}getComponent(t,e){let n=this.componentEntries.get(e);if(n!==void 0)return n.components.get(t)}getEntitiesChanged(){return this.entitiesChanged.values()}hasChangeFlag(t,e,n){let i=this.getComponentEntryOrThrow(e).changeFlags.get(t);return i===void 0?!1:(i&n)===n}hasComponent(t,e){return this.getComponentEntryOrThrow(e).components.has(t)}loadEntities(t,e){this.clear();let n=t.deserialize(e);for(let s of n.entityEntries)this.entityEntries.set(s.entityId,s);for(let s of n.componentEntries)this.componentEntries.set(s.componendId,s)}queryEntities(t){let e=[];for(let n of t){let s=this.getComponentEntryOrThrow(n);e.push(s)}return new ze(this.entityEntries.values(),e)}saveEntities(t){return t.serialize({entityEntries:[...this.entityEntries.values()],componentEntries:[...this.componentEntries.values()]})}setComponent(t,e){let n=this.getComponentEntry(e.componentId);n.components.set(t,e),Mi(n,t),this.entitiesChanged.add(t)}setParent(t,e){let n=this.getEntityEntryOrThrow(t);if(n.parent!==void 0){let i=this.getEntityEntryOrThrow(n.parent);i.children!==void 0&&i.children.delete(t)}let s=this.getEntityEntryOrThrow(e);s.children===void 0&&(s.children=new Set),s.children.add(t),n.parent=s.entityId,this.updateHierarchy(n,s.depth)}updateComponent(t,e){let n=this.getComponentEntry(e);Mi(n,t),this.entitiesChanged.add(t)}createEntityId(){let t=this.entityId;return this.entityId+=1,t}getComponentEntry(t){let e=this.componentEntries.get(t);return e===void 0&&(e={componendId:t,components:new Map,changeFlags:new Map},this.componentEntries.set(t,e)),e}getComponentEntryOrThrow(t){let e=this.componentEntries.get(t);return e===void 0&&F("Componend id '{}' not found",t),e}getEntityEntryOrThrow(t){let e=this.entityEntries.get(t);return e===void 0&&F("Entity id '{}'not found",t),e}updateHierarchy(t,e){if(t.depth=e+1,this.entitiesChanged.add(t.entityId),t.children!==void 0)for(let n of t.children){let s=this.getEntityEntryOrThrow(n);this.updateHierarchy(s,t.depth)}}},ze=class{entityEntry;componentEntries;entityEntries;constructor(t,e){this.entityEntries=t,this.componentEntries=e,this.entityEntry=void 0}getEntityId(){let t=this.entityEntry;return t===void 0&&F("Invalid entity entry"),t.entityId}next(){for(let t of this.entityEntries)if(this.hasEntity(t.entityId))return this.entityEntry=t,!0;return!1}hasEntity(t){for(let e of this.componentEntries)if(!e.components.has(t))return!1;return!0}},Be=class{entityEntries;entry;constructor(t){this.entityEntries=t,this.entry=void 0}getChildren(){return this.entry?.children?.values()}getDepth(){return this.entry?.depth??0}getParent(){return this.entry?.parent}select(t){this.entry=this.entityEntries.get(t)}};function la(r,t,e){r.components.set(t,e),r.changeFlags.set(t,3)}function Ei(r,t){let e=r.components.delete(t);return e&&r.changeFlags.set(t,4),e}function Mi(r,t){let e=r.changeFlags.get(t);e!==void 0?e|=2:e=2,r.changeFlags.set(t,e)}var Fe=class{deps;entries;options;constructor(){this.deps=[],this.entries=[],this.options=[]}addDepedency(t){this.deps.push(t)}addSystem(t){this.options.push({stage:t.stage,fn:t.fn,args:void 0,awaitMode:t.awaitMode})}addSystemWithArgs(t){this.options.push({stage:t.stage,fn:t.fn,args:t.args,awaitMode:t.awaitMode})}addSystems(t){for(let e of t.fns)this.options.push({stage:t.stage,fn:e,args:void 0,awaitMode:void 0})}clear(){this.deps=[],this.entries=[],this.options=[]}async execute(t){for(let e of this.entries){let{fn:n,awaitMode:s,args:i}=e.options;for(let o of e.depsAsync)o.promise!==void 0&&(await o.promise,o.promise=void 0);s==="dependency"?i!==void 0?e.promise=n(t,...i):e.promise=n(t):i!==void 0?n(t,...i):n(t)}}toString(){let t="";for(let e=0;e<this.entries.length;e++){let n=this.entries[e],s=n.options.awaitMode??"sync",i=n.options.fn.name,o=n.idx;t+=`#${e} - ${i} (#${o}, ${s})
`;for(let a of n.depsAsync)t+=`    ^ ${a.options.fn.name}
`}return t}update(){let t=this.createNodes(),e=this.connectNodes(t);e.length===0?this.createEntries(t):this.reportDependencyErrors(e)}connectNodes(t){let e=[];for(let n of this.deps){let s=0,i=[];for(let o of n.seq){let a,p=0;for(let c of t)c.options.fn===o&&(a=c,p+=1);a!==void 0&&p===1?i.push(a):p>1?(e.push({dep:n,fn:o,reason:"ambiguous"}),s+=1):n.optional!==!0&&(e.push({dep:n,fn:o,reason:"missing"}),s+=1)}if(!(s>0))for(let o=1;o<i.length;o++){let a=i[o-1],p=i[o-0];a.depsOut.add(p.idx),p.depsIn.add(a.idx)}}return e}createEntries(t){let e=[],n=[];for(let i of t)i.depsIn.size===0&&n.push(i);let s=n.shift();for(;s!==void 0;){let i={depsAsync:s.depsAsync,idx:s.idx,options:s.options,promise:void 0};for(let o of s.depsOut){let a=t[o];s.depsOut.delete(o),a.depsIn.delete(s.idx),s.options.awaitMode==="dependency"&&a.depsAsync.push(i),a.depsIn.size===0&&n.push(a)}e.push(i),s=n.shift()}for(let i of t)D(i.depsIn.size===0),D(i.depsOut.size===0);this.entries=e}createNodes(){let t=[];for(let e=0;e<this.options.length;e++)t.push({idx:e,options:this.options[e],depsIn:new Set,depsOut:new Set,depsAsync:[]});return t}reportDependencyErrors(t){for(let e of t)switch(e.reason){case"missing":{x.error("Missing system dependency '{}' ",e.fn.name);break}case"ambiguous":{x.error("Ambiguous system dependency '{}' found",e.fn.name);break}}}};var T=[{id:"start",stages:[{id:"start-pre"},{id:"start"},{id:"start-post"}]},{id:"update",stages:[{id:"update-pre"},{id:"update"},{id:"update-post"}]},{id:"stop",stages:[{id:"stop-pre"},{id:"stop"},{id:"stop-post"}]}],ke=class{channels;data;ecStorage;events;modules;plugins;schedules;serializationMap;stages;constructor(){this.serializationMap=new Re([...Si]),this.ecStorage=new We,this.channels=new Map,this.data=new Map,this.events=new Map,this.modules=new Map,this.plugins=new Map,this.schedules=new Map,this.stages=new Map}addChannel(t,e){this.channels.has(t)&&x.warn("World channel '{}' already exists and will be overwritten",t),this.channels.set(t,e)}addDependency(t){this.getSchedule(t.stage).addDepedency(t)}addModules(t){for(let e of t)this.modules.set(e.moduleId,e)}addSchedules(t){for(let e of t){let n=[];for(let s of e.stages){let i=new Fe;n.push(i),this.schedules.set(s.id,i)}this.stages.set(e.id,n)}}addSystem(t){this.getSchedule(t.stage).addSystem(t)}addSystemWithArgs(t){this.getSchedule(t.stage).addSystemWithArgs(t)}addSystems(t){this.getSchedule(t.stage).addSystems(t)}clearEntities(){this.ecStorage.clear()}createEntity(t,...e){return this.ecStorage.createEntity(t,e)}createHierarchySelector(){return this.ecStorage.createHierarchySelector()}deleteComponent(t,e){return this.ecStorage.deleteComponent(t,e)}destroyEntity(t){return this.ecStorage.destroyEntity(t)}getChannel(t){let e=this.channels.get(t);return e===void 0&&F("World channel '{}' not available",t),e}getComponent(t,e){return this.ecStorage.getComponent(t,e)}getEntitiesChanged(){return this.ecStorage.getEntitiesChanged()}getPlugin(t){let e=this.plugins.get(t);return e===void 0&&F("World plugin '{}' not available",t),e}getSchedule(t){let e=this.schedules.get(t);return e===void 0&&F("Stage '{}' not found",t),e}hasChangeFlag(t,e,n){return this.ecStorage.hasChangeFlag(t,e,n)}hasComponent(t,e){return this.ecStorage.hasComponent(t,e)}hasEvents(t){let e=this.events.get(t);return e!==void 0?e.length>0:!1}init(){for(let t of this.modules.values())t.setup(this);for(let t of this.schedules.values())t.update()}loadEntities(t){this.ecStorage.loadEntities(this.serializationMap,t)}queryEntities(t){return this.ecStorage.queryEntities(t)}queueEvent(t){let e=this.events.get(t.eventId);e!==void 0?e.push(t):F("World event '{}' is not registered",t.eventId)}readData(t){let e=this.data.get(t);return e===void 0&&F("Cannot read data '{}'",t),e}readEvents(t){let e=this.events.get(t);return e===void 0&&F("Cannot get events '{}'",t),e}readLatestEvent(t){let e=this.events.get(t);if(e===void 0&&F("Cannot get events '{}'",t),e.length!==0)return e[e.length-1]}registerData(t){this.data.has(t)&&x.warn("World already has data '{}' and will be overwritten",t),this.data.set(t,void 0)}registerEvent(t){this.events.has(t)&&x.warn("World already has event '{}' and will be overwritten",t),this.events.set(t,[])}registerPlugin(t){this.plugins.has(t)&&x.warn("World already has plugin '{}' and will be overwritten",t),this.plugins.set(t,void 0)}registerSerializable(t){this.serializationMap.add(t,e=>e.toArray(),e=>t.fromArray(e))}async runSchedule(t){let e=this.stages.get(t);e===void 0&&F("World stage '{}' unavailable",t);for(let n of e)await n.execute(this);t==="start"?this.validate():t==="update"&&this.cleanup()}saveEntities(){return this.ecStorage.saveEntities(this.serializationMap)}setComponent(t,e){this.ecStorage.setComponent(t,e)}setParent(t,e){this.ecStorage.setParent(t,e)}setPlugin(t){this.plugins.has(t.pluginId)||F("World plugin '{}' is not registered",t.pluginId),this.plugins.set(t.pluginId,t)}updateComponent(t,e){this.ecStorage.updateComponent(t,e)}validate(){let t=!0;for(let[e,n]of this.data)n===void 0&&(x.warn("World data '{}' has not been initialized",e),t=!1);return t}writeData(t){this.data.has(t.dataId)||F("World data '{}' is not registered",t.dataId),this.data.set(t.dataId,t)}writeEvent(t){let e=this.events.get(t.eventId);e===void 0&&F("World event '{}' is not registered",t.eventId),e.push(t)}writeEvents(t){for(let e of t)this.writeEvent(e)}cleanup(){this.ecStorage.cleanup();for(let t of this.events.keys())this.events.set(t,[])}};var Le=class{context;groupMap;groupOptionsMap;constructor(t){this.context=t,this.groupOptionsMap=new Map,this.groupMap=new Map}addWorldGroup(t){let{id:e,parent:n}=t;n!==void 0&&!this.groupOptionsMap.has(n)&&F("Unable to find parent '{}'",n),this.groupOptionsMap.has(e)&&x.warn("Group '{}' will be overwritten",e),this.groupOptionsMap.set(e,t)}run(t,e){let{context:n}=this;for(let s of this.groupOptionsMap.values()){if(!n.isValidGroup(s))continue;let i=this.createChannels(n,s),o=this.createChildren(n,s),a=this.createParent(n,s),p=new we(s.id,n,i,o,a);p.init(),this.groupMap.set(s.id,p)}for(let s of this.groupMap.values()){let i=s.channelMap.get(t);i!==void 0&&i.world.runSchedule(e)}}createChannels(t,e){let n=new Map;for(let s of e.worlds){x.infoDebug("{} >> Created local world '{}'",e.id,s.id);let i=new ke;i.addModules(s.modules),i.addSchedules(s.schedules),i.init();let o=new De(s.id,i);n.set(s.id,o)}return n}createChildren(t,e){let n=[];for(let s of this.groupOptionsMap.values()){if(s.parent!==e.id)continue;let i=t.createRemoteChild(e.id,s.id,s.workerScriptURL),o=new Map;for(let a of s.worlds){let p=new de(a.id,i);o.set(a.id,p)}n.push({remote:i,channelMap:o})}return n}createParent(t,e){if(e.parent===void 0)return;let n=this.groupOptionsMap.get(e.parent);D(n!==void 0);let s=t.createRemoteParent(e.id,n.id),i=new Map;for(let o of n.worlds){let a=new de(o.id,void 0);i.set(o.id,a)}return{remote:s,channelMap:i}}};var Ve=class{defaultScriptURL;isMain;isWorker;selfName;constructor(t){this.defaultScriptURL=t;let e=typeof window<"u",n=!e,s=n?self.name:void 0;this.isMain=e,this.isWorker=n,this.selfName=s}createRemoteChild(t,e,n){return new Te(t,e,n??this.defaultScriptURL)}createRemoteParent(t,e){return new Oe(t,e)}isValidGroup(t){let e=t.id;return this.selfName===e||this.selfName===void 0&&t.parent===void 0}};function Ci(r,t,e){let n=Math.min(r,t),s=Math.max(r,t);return G(n,s,e)}function Ii(r,t,e){let n=Math.min(r,t),s=Math.max(r,t);n=Math.ceil(n),s=Math.floor(s);let i=G(n,s,e);return Math.ceil(i)}function j(r,t,e){return r<=t?t:r>=e?e:r}function _(r,t,e){return Math.abs(r-t)<=e}function ot(r,t,e){let n=Math.abs(r),s=Math.abs(t);return Math.abs(r-t)<=Math.max(n,s)*e}function G(r,t,e){return r+e*(t-r)}function ee(r,t){return Math.round(t*r)/t}var E=class r{x;y;constructor(t,e){this.x=t,this.y=e}static createOne(){return new r(1,1)}static createUnitX(){return new r(1,0)}static createUnitY(){return new r(0,1)}static createZero(){return new r(0,0)}static fromArray(t,e=0){return new r(t[e],t[e+1])}static fromObject(t){return new r(t.x,t.y)}static fromXYW(t,e,n){return new r(t/n,e/n)}static isBetweenCcw(t,e,n){return e.cross(n)>0?e.cross(t)>0&&n.cross(t)<0:e.cross(t)>0||n.cross(t)<0}static toObject(t){return{x:t.x,y:t.y}}abs(){let t=Math.abs(this.x),e=Math.abs(this.y);return new r(t,e)}add(t){return new r(this.x+t.x,this.y+t.y)}addMulS(t,e){return new r(this.x+e*t.x,this.y+e*t.y)}addP(t){return t.addV(this)}angle(){return Math.atan2(this.y,this.x)}angleTo(t){let e=this.dot(t),n=this.lenSq()*t.lenSq();if(e*e>=n)return 0;let s=e/Math.sqrt(n);return Math.acos(s)}clamp(t,e){let n=j(this.x,t.x,e.x),s=j(this.y,t.y,e.y);return new r(n,s)}clone(){return new r(this.x,this.y)}copyTo(t,e=0){t[e]=this.x,t[e+1]=this.y}cross(t){return this.x*t.y-this.y*t.x}divS(t){return new r(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}eq(t){return this.x===t.x&&this.y===t.y}eqApproxAbs(t,e){return _(this.x,t.x,e)&&_(this.y,t.y,e)}eqApproxRel(t,e){return ot(this.x,t.x,e)&&ot(this.y,t.y,e)}isFinite(){return Number.isFinite(this.x)&&Number.isFinite(this.y)}isOne(){return this.x===1&&this.y===1}isZero(){return this.x===0&&this.y===0}len(){return Math.sqrt(this.lenSq())}lenSq(){return this.x*this.x+this.y*this.y}lerp(t,e){let n=G(this.x,t.x,e),s=G(this.y,t.y,e);return new r(n,s)}mulS(t){return new r(t*this.x,t*this.y)}neg(){return new r(-this.x,-this.y)}normal(){return new r(this.y,-this.x)}slerp(t,e){let n=this.dot(t),s=this.lenSq()*t.lenSq();if(n*n>=s)return this.lerp(t,e);let i=n/Math.sqrt(s),o=Math.acos(i),a=Math.sin(o-o*e),p=Math.sin(o*e),c=Math.sin(o),u=a/c,l=p/c,d=u*this.x+l*t.x,m=u*this.y+l*t.y;return new r(d,m)}sub(t){return new r(this.x-t.x,this.y-t.y)}toArray(){return[this.x,this.y]}toPoint(){return new f(this.x,this.y)}toString(){return`{x: ${this.x}, y: ${this.y}}`}unit(){return this.divS(this.len())}unitOrZero(){let t=this.len();return t>0?this.divS(t):r.createZero()}},X=class r{x;y;z;constructor(t,e,n){this.x=t,this.y=e,this.z=n}static createOne(){return new r(1,1,1)}static createUnitX(){return new r(1,0,0)}static createUnitY(){return new r(0,1,0)}static createUnitZ(){return new r(0,0,1)}static createZero(){return new r(0,0,0)}static fromArray(t,e=0){return new r(t[e],t[e+1],t[e+2])}static fromObject(t){return new r(t.x,t.y,t.z)}static fromXYW(t,e,n){return new r(n*t,n*e,n)}static fromXYZW(t,e,n,s){return new r(t/s,e/s,n/s)}static toObject(t){return{x:t.x,y:t.y,z:t.z}}abs(){let t=Math.abs(this.x),e=Math.abs(this.y),n=Math.abs(this.z);return new r(t,e,n)}add(t){return new r(this.x+t.x,this.y+t.y,this.z+t.z)}addMulS(t,e){return new r(this.x+e*t.x,this.y+e*t.y,this.z+e*t.z)}addP(t){return t.addV(this)}angleTo(t){let e=this.lenSq()*t.lenSq();if(e===0)return 0;let n=this.dot(t)/Math.sqrt(e);return Math.acos(n)}clamp(t,e){let n=j(this.x,t.x,e.x),s=j(this.y,t.y,e.y),i=j(this.z,t.z,e.z);return new r(n,s,i)}clone(){return new r(this.x,this.y,this.z)}copyTo(t,e=0){t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z}cross(t){let e=this.y*t.z-this.z*t.y,n=this.z*t.x-this.x*t.z,s=this.x*t.y-this.y*t.x;return new r(e,n,s)}divS(t){return new r(this.x/t,this.y/t,this.z/t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}eq(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}eqApproxAbs(t,e){return _(this.x,t.x,e)&&_(this.y,t.y,e)&&_(this.z,t.z,e)}eqApproxRel(t,e){return ot(this.x,t.x,e)&&ot(this.y,t.y,e)&&ot(this.z,t.z,e)}isFinite(){return Number.isFinite(this.x)&&Number.isFinite(this.y)&&Number.isFinite(this.z)}isOne(){return this.x===1&&this.y===1&&this.z===1}isZero(){return this.x===0&&this.y===0&&this.z===0}len(){return Math.sqrt(this.lenSq())}lenSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e){let n=G(this.x,t.x,e),s=G(this.y,t.y,e),i=G(this.z,t.z,e);return new r(n,s,i)}mulS(t){return new r(t*this.x,t*this.y,t*this.z)}neg(){return new r(-this.x,-this.y,-this.z)}normalAround(t){return this.cross(t)}normalAroundAny(){let t=Math.abs(this.x),e=Math.abs(this.y),n=Math.abs(this.z);return t<=e?t<=n?this.normalAroundX():this.normalAroundZ():e<=n?this.normalAroundY():this.normalAroundZ()}normalAroundX(){return new r(0,this.z,-this.y)}normalAroundY(){return new r(-this.z,0,this.x)}normalAroundZ(){return new r(this.y,-this.x,0)}orthonormalBasis(){let{x:t,y:e,z:n}=this,s=n>=0?1:-1,i=-1/(s+n),o=t*e*i,a=new r(1+s*t*t*i,s*o,-s*t),p=new r(o,s+e*e*i,-e);return{n1:a,n2:p}}slerp(t,e){let n=this.dot(t),s=this.lenSq()*t.lenSq();if(n*n>=s)return this.lerp(t,e);let i=n/Math.sqrt(s),o=Math.acos(i),a=Math.sin(o-o*e),p=Math.sin(o*e),c=Math.sin(o),u=a/c,l=p/c,d=u*this.x+l*t.x,m=u*this.y+l*t.y,h=u*this.z+l*t.z;return new r(d,m,h)}sub(t){return new r(this.x-t.x,this.y-t.y,this.z-t.z)}toArray(){return[this.x,this.y,this.z]}toPoint(){return new I(this.x,this.y,this.z)}toString(){return`{x: ${this.x}, y: ${this.y}, z: ${this.z}}`}unit(){return this.divS(this.len())}unitOrZero(){let t=this.len();return t>0?this.divS(t):r.createZero()}},qe=class r{w;x;y;z;constructor(t,e,n,s){this.x=t,this.y=e,this.z=n,this.w=s}static createOne(){return new r(1,1,1,1)}static createUnitW(){return new r(0,0,0,1)}static createUnitX(){return new r(1,0,0,0)}static createUnitY(){return new r(0,1,0,0)}static createUnitZ(){return new r(0,0,1,0)}static createZero(){return new r(0,0,0,0)}static fromArray(t,e=0){return new r(t[e],t[e+1],t[e+2],t[e+3])}static fromObject(t){return new r(t.x,t.y,t.z,t.w)}static toObject(t){return{x:t.x,y:t.y,z:t.z,w:t.w}}abs(){let t=Math.abs(this.x),e=Math.abs(this.y),n=Math.abs(this.z),s=Math.abs(this.w);return new r(t,e,n,s)}add(t){return new r(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addMulS(t,e){return new r(this.x+e*t.x,this.y+e*t.y,this.z+e*t.z,this.w+e*t.w)}clamp(t,e){let n=j(this.x,t.x,e.x),s=j(this.y,t.y,e.y),i=j(this.z,t.z,e.z),o=j(this.w,t.w,e.w);return new r(n,s,i,o)}clone(){return new r(this.x,this.y,this.z,this.w)}copyTo(t,e=0){t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w}divS(t){return new r(this.x/t,this.y/t,this.z/t,this.w/t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}eq(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}eqApproxAbs(t,e){return _(this.x,t.x,e)&&_(this.y,t.y,e)&&_(this.z,t.z,e)&&_(this.w,t.w,e)}eqApproxRel(t,e){return ot(this.x,t.x,e)&&ot(this.y,t.y,e)&&ot(this.z,t.z,e)&&_(this.w,t.w,e)}isFinite(){return Number.isFinite(this.x)&&Number.isFinite(this.y)&&Number.isFinite(this.z)&&Number.isFinite(this.w)}isOne(){return this.x===1&&this.y===1&&this.z===1&&this.w===1}isZero(){return this.x===0&&this.y===0&&this.z===0&&this.w===0}len(){return Math.sqrt(this.lenSq())}lenSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e){let n=G(this.x,t.x,e),s=G(this.y,t.y,e),i=G(this.z,t.z,e),o=G(this.w,t.w,e);return new r(n,s,i,o)}mulS(t){return new r(t*this.x,t*this.y,t*this.z,t*this.w)}neg(){return new r(-this.x,-this.y,-this.z,-this.w)}sub(t){return new r(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}toArray(){return[this.x,this.y,this.z,this.w]}toString(){return`{x: ${this.x}, y: ${this.y}, z: ${this.z}}, w: ${this.w}}`}};var f=class r{x;y;constructor(t,e){this.x=t,this.y=e}static createZero(){return new r(0,0)}static fromArray(t,e=0){return new r(t[e],t[e+1])}static fromObject(t){return new r(t.x,t.y)}static fromXYW(t,e,n){return new r(t/n,e/n)}static isPointInTriangle(t,e,n,s){let i=s.sub(t),o=e.sub(t),a=n.sub(t),p=i.cross(a),c=o.cross(i),u=o.cross(a);return u>0?p>0&&c>0&&p+c<u:p<0&&c<0&&p+c>u}static roundToPrecision(t,e){let n=ee(t.x,e),s=ee(t.y,e);return new r(n,s)}static signedArea(t,e,n){let s=e.sub(t),i=n.sub(t);return s.cross(i)}static toObject(t){return{x:t.x,y:t.y}}addV(t){return new r(this.x+t.x,this.y+t.y)}addVMulS(t,e){return new r(this.x+e*t.x,this.y+e*t.y)}clone(){return new r(this.x,this.y)}copyTo(t,e=0){t[e]=this.x,t[e+1]=this.y}distanceTo(t){let e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}eq(t){return this.x===t.x&&this.y===t.y}eqApproxAbs(t,e){return _(this.x,t.x,e)&&_(this.y,t.y,e)}eqApproxRel(t,e){return ot(this.x,t.x,e)&&ot(this.y,t.y,e)}gt(t){return this.x===t.x?this.y>t.y:this.x>t.x}gte(t){return this.x===t.x?this.y>=t.y:this.x>t.x}isFinite(){return Number.isFinite(this.x)&&Number.isFinite(this.y)}isZero(){return this.x===0&&this.y===0}lerp(t,e){let n=G(this.x,t.x,e),s=G(this.y,t.y,e);return new r(n,s)}lt(t){return this.x===t.x?this.y<t.y:this.x<t.x}lte(t){return this.x===t.x?this.y<=t.y:this.x<t.x}sub(t){return new E(this.x-t.x,this.y-t.y)}subV(t){return new r(this.x-t.x,this.y-t.y)}toArray(){return[this.x,this.y]}toString(){return`{x: ${this.x}, y: ${this.y}}`}toVector(){return new E(this.x,this.y)}},I=class r{x;y;z;constructor(t,e,n){this.x=t,this.y=e,this.z=n}static createZero(){return new r(0,0,0)}static fromArray(t,e=0){return new r(t[e],t[e+1],t[e+2])}static fromObject(t){return new r(t.x,t.y,t.z)}static fromXYW(t,e,n){return new r(n*t,n*e,n)}static fromXYZW(t,e,n,s){return new r(t/s,e/s,n/s)}static roundToPrecision(t,e){let n=ee(t.x,e),s=ee(t.y,e),i=ee(t.z,e);return new r(n,s,i)}static toObject(t){return{x:t.x,y:t.y,z:t.z}}addV(t){return new r(this.x+t.x,this.y+t.y,this.z+t.z)}addVMulS(t,e){return new r(this.x+e*t.x,this.y+e*t.y,this.z+e*t.z)}clone(){return new r(this.x,this.y,this.z)}copyTo(t,e=0){t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z}distanceTo(t){let e=this.x-t.x,n=this.y-t.y,s=this.z-t.z;return Math.sqrt(e*e+n*n+s*s)}eq(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}eqApproxAbs(t,e){return _(this.x,t.x,e)&&_(this.y,t.y,e)&&_(this.z,t.z,e)}eqApproxRel(t,e){return ot(this.x,t.x,e)&&ot(this.y,t.y,e)&&ot(this.z,t.z,e)}isFinite(){return Number.isFinite(this.x)&&Number.isFinite(this.y)&&Number.isFinite(this.z)}isZero(){return this.x===0&&this.y===0&&this.z===0}lerp(t,e){let n=G(this.x,t.x,e),s=G(this.y,t.y,e),i=G(this.z,t.z,e);return new r(n,s,i)}sub(t){return new X(this.x-t.x,this.y-t.y,this.z-t.z)}subV(t){return new r(this.x-t.x,this.y-t.y,this.z-t.z)}toArray(){return[this.x,this.y,this.z]}toString(){return`{x: ${this.x}, y: ${this.y}, z: ${this.z}}`}toVector(){return new X(this.x,this.y,this.z)}};var Q=class r{x0;x1;y0;y1;constructor(t,e,n,s){this.x0=t,this.y0=e,this.x1=n,this.y1=s}static createEmpty(){return new r(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}static fromArray(t,e=0){return new r(t[e],t[e+1],t[e+2],t[e+3])}static fromObject(t){return new r(t.x0,t.y0,t.x1,t.y1)}static fromPoints(t,e){let n=Math.min(t.x,e.x),s=Math.min(t.y,e.y),i=Math.max(t.x,e.x),o=Math.max(t.y,e.y);return new r(n,s,i,o)}static fromXYWH(t,e,n,s){let i=Math.min(t,t+n),o=Math.min(e,e+s),a=Math.max(t,t+n),p=Math.max(e,e+s);return new r(i,o,a,p)}static toObject(t){return{x0:t.x0,y0:t.y0,x1:t.x1,y1:t.y1}}addMinkowski(t){let e=this.x0-t.x1,n=this.y0-t.y1,s=this.x1-t.x0,i=this.y1-t.y0;return new r(e,n,s,i)}clone(){return new r(this.x0,this.y0,this.x1,this.y1)}contains(t){return this.x0<t.x&&this.y0<t.y&&this.x1>t.x&&this.y1>t.y}containsInclusive(t){return this.x0<=t.x&&this.y0<=t.y&&this.x1>=t.x&&this.y1>=t.y}dx(){return this.x1-this.x0}dy(){return this.y1-this.y0}enclose(t){this.x0=Math.min(this.x0,t.x),this.y0=Math.min(this.y0,t.y),this.x1=Math.max(this.x1,t.x),this.y1=Math.max(this.y1,t.y)}encloseWithTransform(t,e){let n=e.mulP(t);this.enclose(n)}getCenter(){return new f(.5*(this.x0+this.x1),.5*(this.y0+this.y1))}intersects(t){return this.x0<t.x1&&this.x1>t.x0&&this.y0<t.y1&&this.y1>t.y0}intersectsInclusive(t){return this.x0<=t.x1&&this.x1>=t.x0&&this.y0<=t.y1&&this.y1>=t.y0}intersectsRay(t){let e=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,s=1/t.v.x,i=(this.x0-t.p.x)*s,o=(this.x1-t.p.x)*s;return e=Math.max(Math.min(i,o),e),n=Math.min(Math.max(i,o),n),s=1/t.v.y,i=(this.y0-t.p.y)*s,o=(this.y1-t.p.y)*s,e=Math.max(Math.min(i,o),e),n=Math.min(Math.max(i,o),n),e<n}isEmpty(){return this.x0>this.x1||this.y0>this.y1}isPoint(){return this.x0===this.x1&&this.y0===this.y1}scale(t,e){let n=.5*(t-1)*this.dx(),s=.5*(e-1)*this.dy();return this.scaleAbsolute(n,s)}scaleAbsolute(t,e){return new r(this.x0-t,this.y0-e,this.x1+t,this.y1+e)}subMinkowski(t){let e=this.x0+t.x1,n=this.y0+t.y1,s=this.x1+t.x0,i=this.y1+t.y0;return new r(e,n,s,i)}toArray(){return[this.x0,this.y0,this.x1,this.y1]}toString(){return`{x0: ${this.x0}, y0: ${this.y0}, x1: ${this.x1}, y1: ${this.y1}}`}transform(t){let e=r.createEmpty();return e.encloseWithTransform(new f(this.x0,this.y0),t),e.encloseWithTransform(new f(this.x0,this.y1),t),e.encloseWithTransform(new f(this.x1,this.y0),t),e.encloseWithTransform(new f(this.x1,this.y1),t),e}union(t){this.x0=Math.min(this.x0,t.x0),this.y0=Math.min(this.y0,t.y0),this.x1=Math.max(this.x1,t.x1),this.y1=Math.max(this.y1,t.y1)}},Ne=class r{x0;x1;y0;y1;z0;z1;constructor(t,e,n,s,i,o){this.x0=t,this.y0=e,this.z0=n,this.x1=s,this.y1=i,this.z1=o}static createEmpty(){return new r(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}static fromArray(t,e=0){return new r(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5])}static fromObject(t){return new r(t.x0,t.y0,t.z0,t.x1,t.y1,t.z1)}static fromPoints(t,e){let n=Math.min(t.x,e.x),s=Math.min(t.y,e.y),i=Math.min(t.z,e.z),o=Math.max(t.x,e.x),a=Math.max(t.y,e.y),p=Math.max(t.z,e.z);return new r(n,s,i,o,a,p)}static fromXYZWHD(t,e,n,s,i,o){let a=Math.min(t,t+s),p=Math.min(e,e+i),c=Math.min(n,n+o),u=Math.max(t,t+s),l=Math.max(e,e+i),d=Math.max(n,n+o);return new r(a,p,c,u,l,d)}static toObject(t){return{x0:t.x0,y0:t.y0,z0:t.z0,x1:t.x1,y1:t.y1,z1:t.z1}}addMinkowski(t){let e=this.x0-t.x1,n=this.y0-t.y1,s=this.z0-t.z1,i=this.x1-t.x0,o=this.y1-t.y0,a=this.z1-t.z0;return new r(e,n,s,i,o,a)}clone(){return new r(this.x0,this.y0,this.z0,this.x1,this.y1,this.z1)}contains(t){return this.x0<t.x&&this.y0<t.y&&this.z0<t.z&&this.x1>t.x&&this.y1>t.y&&this.z1>t.z}containsInclusive(t){return this.x0<=t.x&&this.y0<=t.y&&this.z0<=t.z&&this.x1>=t.x&&this.y1>=t.y&&this.z1>=t.z}dx(){return this.x1-this.x0}dy(){return this.y1-this.y0}dz(){return this.z1-this.z0}enclose(t){this.x0=Math.min(this.x0,t.x),this.y0=Math.min(this.y0,t.y),this.z0=Math.min(this.z0,t.z),this.x1=Math.max(this.x1,t.x),this.y1=Math.max(this.y1,t.y),this.z1=Math.max(this.z1,t.z)}encloseWithTransform(t,e){let n=e.mulP(t);this.enclose(n)}getCenter(){return new I(.5*(this.x0+this.x1),.5*(this.y0+this.y1),.5*(this.z0+this.z1))}intersects(t){return this.x0<t.x1&&this.x1>t.x0&&this.y0<t.y1&&this.y1>t.y0&&this.z0<t.z1&&this.z1>t.z0}intersectsInclusive(t){return this.x0<=t.x1&&this.x1>=t.x0&&this.y0<=t.y1&&this.y1>=t.y0&&this.z0<=t.z1&&this.z1>=t.z0}intersectsRay(t){let e=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,s=1/t.v.x,i=(this.x0-t.p.x)*s,o=(this.x1-t.p.x)*s;return e=Math.max(Math.min(i,o),e),n=Math.min(Math.max(i,o),n),s=1/t.v.y,i=(this.y0-t.p.y)*s,o=(this.y1-t.p.y)*s,e=Math.max(Math.min(i,o),e),n=Math.min(Math.max(i,o),n),s=1/t.v.z,i=(this.z0-t.p.z)*s,o=(this.z1-t.p.z)*s,e=Math.max(Math.min(i,o),e),n=Math.min(Math.max(i,o),n),e<n}isEmpty(){return this.x0>this.x1||this.y0>this.y1||this.z0>this.z1}isPoint(){return this.x0===this.x1&&this.y0===this.y1&&this.z0===this.z1}scale(t,e,n){let s=.5*(t-1)*this.dx(),i=.5*(e-1)*this.dy(),o=.5*(n-1)*this.dz();return this.scaleAbsolute(s,i,o)}scaleAbsolute(t,e,n){return new r(this.x0-t,this.y0-e,this.z0-n,this.x1+t,this.y1+e,this.z1+n)}subMinkowski(t){let e=this.x0+t.x1,n=this.y0+t.y1,s=this.z0+t.z1,i=this.x1+t.x0,o=this.y1+t.y0,a=this.z1+t.z0;return new r(e,n,s,i,o,a)}toArray(){return[this.x0,this.y0,this.z0,this.x1,this.y1,this.z1]}toString(){return`{x0: ${this.x0}, y0: ${this.y0}, z0: ${this.z0}, x1: ${this.x1}, y1: ${this.y1}}, z1: ${this.z1}}`}transform(t){let e=r.createEmpty();return e.encloseWithTransform(new I(this.x0,this.y0,this.z0),t),e.encloseWithTransform(new I(this.x0,this.y0,this.z1),t),e.encloseWithTransform(new I(this.x0,this.y1,this.z0),t),e.encloseWithTransform(new I(this.x0,this.y1,this.z1),t),e.encloseWithTransform(new I(this.x1,this.y0,this.z0),t),e.encloseWithTransform(new I(this.x1,this.y0,this.z1),t),e.encloseWithTransform(new I(this.x1,this.y1,this.z0),t),e.encloseWithTransform(new I(this.x1,this.y1,this.z1),t),e}union(t){this.x0=Math.min(this.x0,t.x0),this.y0=Math.min(this.y0,t.y0),this.z0=Math.min(this.z0,t.z0),this.x1=Math.max(this.x1,t.x1),this.y1=Math.max(this.y1,t.y1),this.z1=Math.max(this.z1,t.z1)}};var Ai=2**-32,ma=2**-53,q=class r{state;constructor(t){le(t.length===4,"Array length of 'state' must be equal to 4"),this.state=t}static fromSeedLcg(t){let e=ha(t,4);return new r(e)}nextFloat(){let t=wi(this.state),e=fa(this.state);return Di(this.state),Ai*(t>>>0)+ma*(e>>>11)}nextFloatBetween(t,e){let n=this.nextFloat();return Ci(t,e,n)}nextInt(){let t=wi(this.state);return Di(this.state),t|0}nextIntBetween(t,e){let n=this.nextInt(),s=Ai*(n>>>0);return Ii(t,e,s)}};function ha(r,t){let e=r??4294967296*Math.random(),n=new Int32Array(t),s=e|0;for(let i=0;i<t;i++)s=Math.imul(1549681957,s)|0,s=s+387420489|0,n[i]=s;return n}function Di(r){let t=r[1]<<9;r[2]^=r[0],r[3]^=r[1],r[1]^=r[2],r[0]^=r[3],r[2]^=t,r[3]=r[3]<<11|r[3]>>>21}function fa(r){return r[0]+r[3]}function wi(r){let t=r[1]*5;return t=t<<7|t>>>25,t*9}var Ct=class r{a;b;constructor(t,e){this.a=t,this.b=e}static fromUnordered(t,e){return t<=e?new r(t,e):new r(e,t)}clamp(t,e){let n=Math.max(this.a,t),s=Math.min(this.b,e);return new r(n,s)}contains(t){return this.a<t&&this.b>t}diameter(){return this.b-this.a}encloseInterval(t){let e=Math.min(this.a,t.a),n=Math.max(this.b,t.b);return new r(e,n)}encloseValue(t){let e=Math.min(this.a,t),n=Math.max(this.b,t);return new r(e,n)}intersects(t){return this.a<t.b&&this.b>t.a}isDegenerate(){return this.a===this.b}isEmpty(){return this.a>this.b}mid(){return .5*(this.a+this.b)}widen(t){return new r(this.a-t,this.b+t)}withEnd(t){return new r(this.a,t)}withStart(t){return new r(t,this.b)}};function Rt(r,t){return-t/r}function st(r,t,e){let n=t*t-r*e;if(n<0)return{type:0};{let s,i;return n=Math.sqrt(n),t>0?(n=-t-n,s=e/n,i=n/r):t<0?(n=-t+n,s=n/r,i=e/n):r*r>=e*e?(s=n/r,i=-n/r):(s=e/-n,i=e/n),{type:2,x1:s,x2:i}}}function Ue(r,t,e,n){let s=r*e-t*t,i=r*n-t*e,o=t*n-e*e,a=4*s*o-i*i;if(a<0){let p;if(t*t*t*n>=r*e*e*e){let c=2*t*s-r*i,l=(c<0?-1:1)*Math.abs(r)*Math.sqrt(-a),d=l+c,m=Math.cbrt(.5*d),h=l===d?-m:-s/m;p=((s<=0?m+h:c/(m*m+h*h+s))-t)/r}else{let c=n*i-2*e*o,l=(c<0?-1:1)*Math.abs(n)*Math.sqrt(-a),d=l+c,m=Math.cbrt(.5*d),h=l===d?-m:-o/m,g=o<=0?m+h:c/(m*m+h*h+o);p=-n/(g+e)}return{type:1,x:p}}else{let p=Math.sqrt(a),c=2*t*s-r*i,u=n*i-2*e*o,l=Math.abs(Math.atan2(r*p,c)/3),d=Math.abs(Math.atan2(n*p,u)/3),m=2*Math.sqrt(-s),h=2*Math.sqrt(-o),g=Math.cos(l),y=Math.cos(d),v=m*g,P=h*y,M=-m*(.5*g+.8660254037844386*Math.sin(l)),S=-h*(.5*y+.8660254037844386*Math.sin(d)),C=v+M>2*t?v-t:M-t,z=r,V=-n,b=P+S<2*e?P+e:S+e,ft=z*b,ut=-C*b-z*V,bt=C*V,gt=e*ut-t*bt,yt=e*ft-t*ut;return{type:3,x1:C/z,x2:V/b,x3:gt/yt}}}function vt(r,t,e){if(!ne(e))return;let n=r.getValueAt(e);t.enclose(n)}function me(r,t,e,n){if(!ne(e))return;let s=r.getValueAt(e).sub(t).lenSq();s<n.distSq&&(n.param=e,n.distSq=s)}function Ti(r,t,e){if(!ne(t))return 0;let n=G(r.p0.x,r.p1.x,t),s=r.p0.y-r.p1.y;return Ge(t,e,n,s)}function Yn(r,t,e){if(!ne(t))return 0;let n=r.p0.lerp(r.p1,t),s=r.p1.lerp(r.p2,t),i=G(n.x,s.x,t),o=n.y-s.y;return Ge(t,e,i,o)}function he(r,t,e){if(!ne(t))return 0;let n=r.p0.lerp(r.p1,t),s=r.p1.lerp(r.p2,t),i=r.p2.lerp(r.p3,t),o=n.lerp(s,t),a=s.lerp(i,t),p=G(o.x,a.x,t),c=o.y-a.y;return Ge(t,e,p,c)}function Xn(r,t,e){if(!ne(t))return 0;let[n,s,i]=r.getProjectivePoints(),o=n.lerp(s,t),a=s.lerp(i,t),p=o.lerp(a,t),c=p.x/p.z,u=p.y*(a.z-o.z)-p.z*(a.y-o.y);return Ge(t,e,c,u)}function je(r,t,e,n,s,i){let o=8881784197001252e-31;if(!s.intersects(t))return;let a=s.clamp(t.a,t.b);x.infoDebug("Intersection candidate: [{}, {}]",a.a,a.b),a.diameter()<o?(x.infoDebug("Intersection found at t = {} (Diam: {})",a.mid(),a.diameter()),i.push(r.getValueAt(a.mid()))):Zn(e,n,r,a,i)}function Zn(r,t,e,n,s){let i=e.splitBetween(n.a,n.b),o=.5*f.signedArea(i.p0,i.p2,i.p1),a=f.signedArea(i.p0,i.p2,r.p0),p=f.signedArea(i.p0,i.p2,r.p1),c=f.signedArea(i.p0,i.p2,r.p2),u=p-a,l=c-p,d=Math.min(0,o),m=Math.max(0,o),h=st(l-u,u,a-d),g=st(l-u,u,a-m);if(h.type===2&&g.type===2){let y=Ct.fromUnordered(h.x1,g.x1),v=Ct.fromUnordered(h.x2,g.x2);je(r,t,e,n,y,s),je(r,t,e,n,v,s)}else if(h.type===2){let y=Ct.fromUnordered(h.x1,h.x2);je(r,t,e,n,y,s)}else if(g.type===2){let y=Ct.fromUnordered(g.x1,g.x2);je(r,t,e,n,y,s)}}function Oi(r){let t=0,[e,n]=r.getDerivativeCoefficients();return t+=Qe(.1739274225687269,.06943184420297371,e,n),t+=Qe(.3260725774312731,.3300094782075719,e,n),t+=Qe(.3260725774312731,.6699905217924281,e,n),t+=Qe(.1739274225687269,.9305681557970263,e,n),t}function Hn(r,t){let e=r.p1.distanceTo(r.p0),n=r.p2.distanceTo(r.p1),s=st(n-e,e,-t);return s.type===2?s.x1:1}function ne(r){return r>=0&&r<=1}function Ge(r,t,e,n){return t<e?0:n<0?r!==0?-1:0:n>0&&r!==1?1:0}function Qe(r,t,e,n){let s=e.mulS(t).add(n);return r*s.len()}var Ye=class r{p;v;constructor(t,e){this.p=t,this.v=e}static fromArray(t,e=0){let n=f.fromArray(t,e),s=E.fromArray(t,e+2);return new r(n,s)}static fromObject(t){let e=f.fromObject(t.p),n=E.fromObject(t.v);return new r(e,n)}static fromPoints(t,e){let n=e.sub(t);return new r(t,n)}static fromXY(t,e,n,s){let i=new f(t,e),o=new E(n,s);return new r(i,o)}static getIntersection(t,e){let n=t.v,s=e.v,i=n.cross(s);if(i===0)return;let a=e.p.sub(t.p).cross(e.v)/i;return t.getValueAt(a)}static getIntersectionParameter(t,e){let n=t.v,s=e.v,i=n.cross(s);if(i===0)return[Number.NaN,Number.NaN];let o=e.p.sub(t.p),a=o.cross(s)/i,p=o.cross(n)/i;return[a,p]}static toObject(t){let e=f.toObject(t.p),n=E.toObject(t.v);return{p:e,v:n}}clone(){return new r(this.p.clone(),this.v.clone())}getParameterFromPoint(t){let e=this.v,n=t.sub(this.p);return e.dot(n)/e.lenSq()}getSignedDistanceFromPoint(t){let e=this.v,n=this.p.sub(t);return e.cross(n)/e.len()}getValueAt(t){return this.p.addVMulS(this.v,t)}normal(){return new r(this.p,this.v.normal())}reverse(){return new r(this.p,this.v.neg())}toArray(){return[this.p.x,this.p.y,this.v.x,this.v.y]}toString(){return`{p: ${this.p}, p: ${this.p}}`}translate(t){let e=this.p.addV(t);return new r(e,this.v)}},Xe=class r{p;v;constructor(t,e){this.p=t,this.v=e}static fromArray(t,e=0){let n=I.fromArray(t,e),s=X.fromArray(t,e+3);return new r(n,s)}static fromObject(t){let e=I.fromObject(t.p),n=X.fromObject(t.v);return new r(e,n)}static fromPoints(t,e){let n=e.sub(t);return new r(t,n)}static fromXYZ(t,e,n,s,i,o){let a=new I(t,e,n),p=new X(s,i,o);return new r(a,p)}static getClosestParameter(t,e){let n=t.v.cross(e.v),s=n.lenSq();if(s===0)return;let i=e.p.sub(t.p),o=i.cross(e.v).dot(n)/s,a=i.cross(t.v).dot(n)/s;return[o,a]}static toObject(t){let e=I.toObject(t.p),n=X.toObject(t.v);return{p:e,v:n}}clone(){return new r(this.p.clone(),this.v.clone())}getDistanceFromPoint(t){let e=this.v,n=this.p.sub(t);return e.cross(n).len()/e.len()}getNormalAround(t){return new r(this.p,this.v.cross(t))}getParameterFromPoint(t){let e=this.v,n=t.sub(this.p);return e.dot(n)/e.lenSq()}getValueAt(t){return this.p.addVMulS(this.v,t)}isFinite(){return this.p.isFinite()&&this.v.isFinite()}reverse(){return new r(this.p,this.v.neg())}toArray(){return[this.p.x,this.p.y,this.p.z,this.v.x,this.v.y,this.v.z]}toString(){return`{p: ${this.p}, p: ${this.p}}`}translate(t){let e=this.p.addV(t);return new r(e,this.v)}};var O=class r{p0;p1;constructor(t,e){this.p0=t,this.p1=e}static clip(t,...e){let n=t;for(let s of e){let[i]=r.getIntersectionParameter(n,s),o=f.signedArea(s.p0,s.p1,n.p0);if(i>0&&i<1){let a=n.getValueAt(i);o<=0?n=new r(a,n.p1):n=new r(n.p0,a)}else if(o<=0)return}if(!n.isPoint())return n}static fromArray(t,e=0){let n=f.fromArray(t,e),s=f.fromArray(t,e+2);return new r(n,s)}static fromObject(t){let e=f.fromObject(t.p0),n=f.fromObject(t.p1);return new r(e,n)}static fromXY(t,e,n,s){let i=new f(t,e),o=new f(n,s);return new r(i,o)}static getCircleIntersectionParameter(t,e,n){let s=t.p1.sub(t.p0),i=e.sub(t.p0),o=s.dot(s),a=s.dot(i.neg()),p=i.dot(i)-n*n,c=st(o,a,p);if(c.type===2){let u=c.x1,l=c.x2;return[u,l]}else return}static getClosestDistance(t,e){let[n,s]=r.getClosestParameter(t,e),i=t.getValueAt(n),o=e.getValueAt(s);return i.distanceTo(o)}static getClosestParameter(t,e){let n=t.vector(),s=e.vector(),i=t.p0.sub(e.p0),o=n.dot(n),a=n.dot(s),p=s.dot(s),c=n.dot(i),u=s.dot(i),l=o*p-a*a,d,m;if(l>0){let h=a*u-p*c,g=o*u-a*c;h<=0?u<=0?(d=j(-c/o,0,1),m=0):u<p?(d=0,m=u/p):(d=j((a-c)/o,0,1),m=1):l<=h?a+u<=0?(d=j(-c/o,0,1),m=0):a+u<p?(d=1,m=(a+u)/p):(d=j((a-c)/o,0,1),m=1):g<=0?(d=j(-c/o,0,1),m=0):g<l?(d=h/l,m=g/l):(d=j((a-c)/o,0,1),m=1)}else u<=0?(d=j(-c/o,0,1),m=0):u<p?(d=0,m=u/p):(d=j((a-c)/o,0,1),m=1);return[d,m]}static getIntersection(t,e){let n=t.vector(),s=e.vector(),i=n.cross(s);if(i===0)return;let o=e.p0.sub(t.p0),a=o.cross(s)/i,p=o.cross(n)/i;if(!(a<0||a>1||p<0||p>1))return t.getValueAt(a)}static getIntersectionParameter(t,e){let n=t.vector(),s=e.vector(),i=n.cross(s);if(i===0)return[Number.NaN,Number.NaN];let o=e.p0.sub(t.p0),a=o.cross(s)/i,p=o.cross(n)/i;return[a,p]}static isAdjacent(t,e){return t.p0.eq(e.p0)||t.p0.eq(e.p1)||t.p1.eq(e.p0)||t.p1.eq(e.p1)}static isEqual(t,e){return t.p0.eq(e.p0)&&t.p1.eq(e.p1)}static isIntersection(t,e){let n=f.signedArea(t.p0,t.p1,e.p0),s=f.signedArea(t.p0,t.p1,e.p1),i=n*s;if(i>0)return!1;let o=f.signedArea(e.p0,e.p1,t.p0),a=f.signedArea(e.p0,e.p1,t.p1),p=o*a;return p>0?!1:i*p>0?!0:!!(n===0&&t.isPointInside(e.p0)||s===0&&t.isPointInside(e.p1)||o===0&&e.isPointInside(t.p0)||a===0&&e.isPointInside(t.p1))}static isOpposite(t,e){return t.p0.eq(e.p1)&&t.p1.eq(e.p0)}static toObject(t){let e=f.toObject(t.p0),n=f.toObject(t.p1);return{p0:e,p1:n}}clone(){return new r(this.p0.clone(),this.p1.clone())}eq(t){return this.p0.eq(t.p0)&&this.p1.eq(t.p1)}getBounds(){return Q.fromPoints(this.p0,this.p1)}getClosestPoint(t){let e=this.getParameterFromPoint(t);return e<=0?this.p0:e>=1?this.p1:this.getValueAt(e)}getClosestPointDistance(t){return this.getClosestPoint(t).distanceTo(t)}getParameterFromPoint(t){let e=this.vector(),n=t.sub(this.p0);return e.dot(n)/e.lenSq()}getSignedDistanceFromPoint(t){let e=this.vector(),n=this.p0.sub(t);return e.cross(n)/e.len()}getValueAt(t){return this.p0.lerp(this.p1,t)}isFinite(){return this.p0.isFinite()&&this.p1.isFinite()}isPoint(){return this.p0.eq(this.p1)}isPointInside(t){let e=this.getParameterFromPoint(t);return e>=0&&e<=1}normal(){let t=this.vector().normal(),e=this.p0.addV(t);return new r(this.p0,e)}reverse(){return new r(this.p1,this.p0)}toArray(){return[this.p0.x,this.p0.y,this.p1.x,this.p1.y]}toBezier(){return new R(this.p0,this.p1)}toRay(){return new Ye(this.p0,this.vector())}toString(){return`{p0: ${this.p0}, p1: ${this.p1}}`}translate(t){let e=this.p0.addV(t),n=this.p1.addV(t);return new r(e,n)}vector(){return this.p1.sub(this.p0)}},at=class r{p0;p1;constructor(t,e){this.p0=t,this.p1=e}static fromArray(t,e=0){let n=I.fromArray(t,e),s=I.fromArray(t,e+3);return new r(n,s)}static fromObject(t){let e=I.fromObject(t.p0),n=I.fromObject(t.p1);return new r(e,n)}static fromXYZ(t,e,n,s,i,o){let a=new I(t,e,n),p=new I(s,i,o);return new r(a,p)}static isAdjacent(t,e){return t.p0.eq(e.p0)||t.p0.eq(e.p1)||t.p1.eq(e.p0)||t.p1.eq(e.p1)}static isEqual(t,e){return t.p0.eq(e.p0)&&t.p1.eq(e.p1)}static isOpposite(t,e){return t.p0.eq(e.p1)&&t.p1.eq(e.p0)}static toObject(t){let e=I.toObject(t.p0),n=I.toObject(t.p1);return{p0:e,p1:n}}clone(){return new r(this.p0.clone(),this.p1.clone())}eq(t){return this.p0.eq(t.p0)&&this.p1.eq(t.p1)}getBounds(){return Ne.fromPoints(this.p0,this.p1)}getClosestPoint(t){let e=this.getParameterFromPoint(t);return e<=0?this.p0:e>=1?this.p1:this.getValueAt(e)}getClosestPointDistance(t){return this.getClosestPoint(t).distanceTo(t)}getDistanceFromPoint(t){let e=this.vector(),n=this.p0.sub(t);return e.cross(n).len()/e.len()}getNormalAround(t){let e=this.vector().cross(t),n=this.p0.addV(e);return new r(this.p0,n)}getParameterFromPoint(t){let e=this.vector(),n=t.sub(this.p0);return e.dot(n)/e.lenSq()}getProjectedEdge(t,e){let n=O.fromXY(this.p0.x,this.p0.y,this.p1.x,this.p1.y),s=n.getParameterFromPoint(t),i=n.getParameterFromPoint(e);return new r(this.getValueAt(s),this.getValueAt(i))}getValueAt(t){return this.p0.lerp(this.p1,t)}isFinite(){return this.p0.isFinite()&&this.p1.isFinite()}reverse(){return new r(this.p1,this.p0)}toArray(){return[this.p0.x,this.p0.y,this.p0.z,this.p1.x,this.p1.y,this.p1.z]}toRay(){return new Xe(this.p0,this.vector())}toString(){return`{p0: ${this.p0}, p1: ${this.p1}}`}translate(t){let e=this.p0.addV(t),n=this.p1.addV(t);return new r(e,n)}vector(){return this.p1.sub(this.p0)}};var R=class r{p0;p1;constructor(t,e){this.p0=t,this.p1=e}get pn(){return this.p1}get type(){return 0}static fromArray(t,e=0){let n=f.fromArray(t,e),s=f.fromArray(t,e+2);return new r(n,s)}static fromObject(t){let e=f.fromObject(t.p0),n=f.fromObject(t.p1);return new r(e,n)}static fromXY(t,e,n,s){let i=new f(t,e),o=new f(n,s);return new r(i,o)}static toObject(t){let e=f.toObject(t.p0),n=f.toObject(t.p1);return{p0:e,p1:n}}clone(){return new r(this.p0.clone(),this.p1.clone())}getBounds(){return Q.fromPoints(this.p0,this.p1)}getControlBounds(){return Q.fromPoints(this.p0,this.p1)}getDerivative(){return this.p1.sub(this.p0)}getSignedArea(){let t=this.p0.toVector(),e=this.p1.toVector();return t.cross(e)/2}getTangentEnd(){return this.getDerivative()}getTangentStart(){return this.getDerivative()}getValueAt(t){return this.p0.lerp(this.p1,t)}getWindingAt(t){let e=this.p0.y-t.y,n=this.p1.y-this.p0.y,s=Rt(n,e);return Ti(this,s,t.x)}getWindingFracAt(t,e){let n=this.getDerivative(),s=0;for(let i=0;i<1;i+=e){let o=this.getValueAt(i).sub(t);s+=o.cross(n)/o.dot(o)}return e*s}isFinite(){return this.p0.isFinite()&&this.p1.isFinite()}isPoint(){return this.p0.eq(this.p1)}reverse(){return new r(this.p1,this.p0)}splitAfter(t){let e=this.p0.lerp(this.p1,t);return new r(e,this.p1)}splitAt(t){let e=this.p0.lerp(this.p1,t),n=new r(this.p0,e),s=new r(e,this.p1);return[n,s]}splitBefore(t){let e=this.p0.lerp(this.p1,t);return new r(this.p0,e)}splitBetween(t,e){let n=this.p0.lerp(this.p1,t),s=this.p0.lerp(this.p1,e);return new r(n,s)}toArray(){return[this.p0.x,this.p0.y,this.p1.x,this.p1.y]}toEdge(){return new O(this.p0,this.p1)}toString(){return`{p0: ${this.p0}, p1: ${this.p1}}`}},W=class r{p0;p1;p2;constructor(t,e,n){this.p0=t,this.p1=e,this.p2=n}get pn(){return this.p2}get type(){return 1}static fromArray(t,e=0){let n=f.fromArray(t,e),s=f.fromArray(t,e+2),i=f.fromArray(t,e+4);return new r(n,s,i)}static fromObject(t){let e=f.fromObject(t.p0),n=f.fromObject(t.p1),s=f.fromObject(t.p2);return new r(e,n,s)}static fromXY(t,e,n,s,i,o){let a=new f(t,e),p=new f(n,s),c=new f(i,o);return new r(a,p,c)}static toObject(t){let e=f.toObject(t.p0),n=f.toObject(t.p1),s=f.toObject(t.p2);return{p0:e,p1:n,p2:s}}clone(){return new r(this.p0.clone(),this.p1.clone(),this.p2.clone())}getBounds(){let t=Q.fromPoints(this.p0,this.p2),[e,n]=this.getDerivativeCoefficients(),s=Rt(e.x,n.x),i=Rt(e.y,n.y);return vt(this,t,s),vt(this,t,i),t}getClosestParameter(t){let e=this.p0.sub(t),n=this.p1.sub(this.p0),s=this.p2.sub(this.p1),i=n.dot(e),o=n.dot(n),a=s.dot(e),p=s.dot(n),u=2*(s.dot(s)-p-p+o),l=2*(p-o),d=2/3*(a+o+o-i),m=2*i,h=Ue(u,l,d,m),g=this.p0.sub(t).lenSq(),y=this.p2.sub(t).lenSq(),v=g<y?{param:0,distSq:g}:{param:1,distSq:y};return h.type===3?(me(this,t,h.x1,v),me(this,t,h.x2,v),me(this,t,h.x3,v)):me(this,t,h.x,v),v.param}getCoefficients(){let t=this.p1.sub(this.p0),n=this.p2.sub(this.p1).sub(t),s=t.add(t),i=this.p0;return[n,s,i]}getControlBounds(){let t=Q.fromPoints(this.p0,this.p2);return t.enclose(this.p1),t}getCurvatureAt(t){let[e,n]=this.getDerivativeCoefficients(),s=e.mulS(t).add(n),i=e,o=s.len();return s.cross(i)/(o*o*o)}getCurvatureMetric(){let[t,e]=this.getDerivativeCoefficients();return t.cross(e)}getDerivativeAt(t){let e=this.p0.lerp(this.p1,t);return this.p1.lerp(this.p2,t).sub(e).mulS(2)}getDerivativeCoefficients(){let t=this.p1.sub(this.p0),n=this.p2.sub(this.p1).sub(t).mulS(2),s=t.add(t);return[n,s]}getEvoluteAt(t){let[e,n,s]=this.getCoefficients(),i=e.mulS(t).add(n).mulS(t).addP(s),o=e.mulS(2*t).add(n),a=e.mulS(2),p=o.normal(),c=o.lenSq()/o.cross(a);return i.addVMulS(p,c)}getOffsetCuspParameter(t){let[e,n]=this.getDerivativeCoefficients(),s=e.lenSq(),i=n.lenSq(),o=e.cross(n),a=e.dot(n),p=1/s,c=p*-a,u=0;if(o!==0){let l=Math.cbrt(t*t*o*o),d=Math.sqrt(a*a-s*(i-l));u=p*d}return[c,u]}getSignedArea(){let t=this.p0.toVector(),e=this.p1.toVector(),n=this.p2.toVector(),s=2*t.cross(e),i=2*e.cross(n),o=t.cross(n);return(s+o+i)/6}getTangentEnd(){return this.p2.eq(this.p1)?this.p1.sub(this.p0):this.p2.sub(this.p1)}getTangentStart(){return this.p1.eq(this.p0)?this.p2.sub(this.p1):this.p1.sub(this.p0)}getValueAt(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t);return e.lerp(n,t)}getVertexParameter(){let[t,e]=this.getDerivativeCoefficients();return t.dot(e.neg())/t.lenSq()}getWindingAt(t){let e=this.p0.y-t.y,n=this.p1.y-this.p0.y,s=this.p2.y-this.p1.y,i=st(s-n,n,e),o=0;return i.type===2&&(o+=Yn(this,i.x1,t.x),o+=Yn(this,i.x2,t.x)),o}getWindingFracAt(t,e){let n=0;for(let s=0;s<1;s+=e){let i=this.getValueAt(s).sub(t),o=this.getDerivativeAt(s);n+=i.cross(o)/i.dot(i)}return e*n}intersectLine(t,e){let n=f.signedArea(t.p0,t.p1,this.p0),s=f.signedArea(t.p0,t.p1,this.p1),i=f.signedArea(t.p0,t.p1,this.p2),o=s-n,a=i-s,p=st(a-o,o,n);p.type===2&&(p.x1>=0&&p.x1<=1&&e.push(p.x1),p.x2>=0&&p.x2<=1&&e.push(p.x2))}intersectQuad(t,e){let n=new Ct(0,1),s=new Ct(0,1);Zn(this,n,t,s,e)}isCollinear(){return this.getCurvatureMetric()===0}isFinite(){return this.p0.isFinite()&&this.p1.isFinite()&&this.p2.isFinite()}isPoint(){return this.p0.eq(this.p1)&&this.p1.eq(this.p2)}reverse(){return new r(this.p2,this.p1,this.p0)}splitAfter(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=e.lerp(n,t);return new r(s,n,this.p2)}splitAt(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=e.lerp(n,t),i=new r(this.p0,e,s),o=new r(s,n,this.p2);return[i,o]}splitBefore(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=e.lerp(n,t);return new r(this.p0,e,s)}splitBetween(t,e){let n=this.p0.lerp(this.p1,t),s=this.p0.lerp(this.p1,e),i=this.p1.lerp(this.p2,t),o=this.p1.lerp(this.p2,e),a=n.lerp(i,t),p=s.lerp(o,t),c=s.lerp(o,e);return new r(a,p,c)}toArray(){return[this.p0.x,this.p0.y,this.p1.x,this.p1.y,this.p2.x,this.p2.y]}toString(){return`{p0: ${this.p0}, p1: ${this.p1}, p2: ${this.p2}}`}},$=class r{p0;p1;p2;p3;constructor(t,e,n,s){this.p0=t,this.p1=e,this.p2=n,this.p3=s}get pn(){return this.p3}get type(){return 2}static fromArray(t,e=0){let n=f.fromArray(t,e),s=f.fromArray(t,e+2),i=f.fromArray(t,e+4),o=f.fromArray(t,e+6);return new r(n,s,i,o)}static fromObject(t){let e=f.fromObject(t.p0),n=f.fromObject(t.p1),s=f.fromObject(t.p2),i=f.fromObject(t.p3);return new r(e,n,s,i)}static fromXY(t,e,n,s,i,o,a,p){let c=new f(t,e),u=new f(n,s),l=new f(i,o),d=new f(a,p);return new r(c,u,l,d)}static toObject(t){let e=f.toObject(t.p0),n=f.toObject(t.p1),s=f.toObject(t.p2),i=f.toObject(t.p3);return{p0:e,p1:n,p2:s,p3:i}}clone(){return new r(this.p0.clone(),this.p1.clone(),this.p2.clone(),this.p3.clone())}getBounds(){let t=Q.fromPoints(this.p0,this.p3),[e,n,s]=this.getDerivativeCoefficients(),i=st(e.x,.5*n.x,s.x),o=st(e.y,.5*n.y,s.y);return i.type===2&&(vt(this,t,i.x1),vt(this,t,i.x2)),o.type===2&&(vt(this,t,o.x1),vt(this,t,o.x2)),t}getCoefficients(){let t=this.p1.sub(this.p0),e=this.p2.sub(this.p1),s=this.p3.sub(this.p2).sub(e).sub(e).add(t),i=e.sub(t).mulS(3),o=t.mulS(3),a=this.p0;return[s,i,o,a]}getControlBounds(){let t=Q.fromPoints(this.p0,this.p3);return t.enclose(this.p1),t.enclose(this.p2),t}getCurvatureAt(t){let[e,n,s]=this.getDerivativeCoefficients(),i=e.mulS(t).add(n).mulS(t).add(s),o=e.mulS(2*t).add(n),a=i.len();return i.cross(o)/(a*a*a)}getCurvatureMetric(){let[t,e]=this.getDerivativeCoefficients();return t.cross(e)}getDerivativeAt(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=this.p2.lerp(this.p3,t),i=e.lerp(n,t);return n.lerp(s,t).sub(i).mulS(3)}getDerivativeCoefficients(){let t=this.p1.sub(this.p0),e=this.p2.sub(this.p1),s=this.p3.sub(this.p2).sub(e).sub(e).add(t).mulS(3),i=e.sub(t).mulS(6),o=t.mulS(3);return[s,i,o]}getEvoluteAt(t){let[e,n,s,i]=this.getCoefficients(),o=e.mulS(t).add(n).mulS(t).add(s).mulS(t).addP(i),a=e.mulS(3*t).addMulS(n,2).mulS(t).add(s),p=e.mulS(6*t).addMulS(n,2),c=a.normal(),u=a.lenSq()/a.cross(p);return o.addVMulS(c,u)}getInflectionParameter(){let[t,e,n]=this.getDerivativeCoefficients(),s,i,o=e.cross(t);return o!==0?(s=t.cross(n)/o,i=s*s+e.cross(n)/o,i>0&&(i=Math.sqrt(i))):(s=-.5*n.cross(e)/n.cross(t),i=Number.NaN),[s,i]}getSignedArea(){let t=this.p0.toVector(),e=this.p1.toVector(),n=this.p2.toVector(),s=this.p3.toVector(),i=6*t.cross(e),o=6*n.cross(s),a=3*t.cross(n),p=3*e.cross(n),c=3*e.cross(s),u=t.cross(s);return(i+a+u+p+c+o)/20}getTangentEnd(){return this.p3.eq(this.p2)?this.p2.eq(this.p1)?this.p1.sub(this.p0):this.p2.sub(this.p1):this.p3.sub(this.p2)}getTangentStart(){return this.p1.eq(this.p0)?this.p2.eq(this.p1)?this.p3.sub(this.p2):this.p2.sub(this.p1):this.p1.sub(this.p0)}getValueAt(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=this.p2.lerp(this.p3,t),i=e.lerp(n,t),o=n.lerp(s,t);return i.lerp(o,t)}getWindingAt(t){let e=this.p0.y-t.y,n=this.p1.y-this.p0.y,s=this.p2.y-this.p1.y,i=this.p3.y-this.p2.y,o=Ue(i-s-s+n,s-n,n,e),a=0;return o.type===3?(a+=he(this,o.x1,t.x),a+=he(this,o.x2,t.x),a+=he(this,o.x3,t.x)):a+=he(this,o.x,t.x),a}getWindingFracAt(t,e){let n=0;for(let s=0;s<1;s+=e){let i=this.getValueAt(s).sub(t),o=this.getDerivativeAt(s);n+=i.cross(o)/i.dot(i)}return e*n}isCollinear(){return this.getCurvatureMetric()===0}isFinite(){return this.p0.isFinite()&&this.p1.isFinite()&&this.p2.isFinite()&&this.p3.isFinite()}isPoint(){return this.p0.eq(this.p1)&&this.p1.eq(this.p2)&&this.p2.eq(this.p3)}reverse(){return new r(this.p3,this.p2,this.p1,this.p0)}splitAfter(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=this.p2.lerp(this.p3,t),i=e.lerp(n,t),o=n.lerp(s,t),a=i.lerp(o,t);return new r(this.p0,e,i,a)}splitAt(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=this.p2.lerp(this.p3,t),i=e.lerp(n,t),o=n.lerp(s,t),a=i.lerp(o,t),p=new r(this.p0,e,i,a),c=new r(a,o,s,this.p3);return[p,c]}splitBefore(t){let e=this.p0.lerp(this.p1,t),n=this.p1.lerp(this.p2,t),s=this.p2.lerp(this.p3,t),i=e.lerp(n,t),o=n.lerp(s,t),a=i.lerp(o,t);return new r(a,o,s,this.p3)}splitBetween(t,e){let n=this.p0.lerp(this.p1,t),s=this.p0.lerp(this.p1,e),i=this.p1.lerp(this.p2,t),o=this.p1.lerp(this.p2,e),a=this.p2.lerp(this.p3,t),p=this.p2.lerp(this.p3,e);return n=n.lerp(i,t),i=i.lerp(a,t),p=o.lerp(p,e),o=s.lerp(o,e),n=n.lerp(i,t),s=n.lerp(i,e),a=o.lerp(p,t),p=o.lerp(p,e),new r(n,s,a,p)}toArray(){return[this.p0.x,this.p0.y,this.p1.x,this.p1.y,this.p2.x,this.p2.y,this.p3.x,this.p3.y]}toString(){return`{p0: ${this.p0}, p1: ${this.p1}, p2: ${this.p2},p2: ${this.p3}}`}},Z=class r{p0;p1;p2;w;constructor(t,e,n,s){this.p0=t,this.p1=e,this.p2=n,this.w=s}get pn(){return this.p2}get type(){return 3}static fromArray(t,e=0){let n=f.fromArray(t,e),s=f.fromArray(t,e+2),i=f.fromArray(t,e+4),o=t[e+6];return new r(n,s,i,o)}static fromCenterPoint(t,e,n,s){let o=t.lerp(n,.5).distanceTo(s),a=e.distanceTo(s),p=Math.sqrt(o/a);return new r(t,e,n,p)}static fromObject(t){let e=f.fromObject(t.p0),n=f.fromObject(t.p1),s=f.fromObject(t.p2);return new r(e,n,s,t.w)}static fromProjectivePoints(t,e,n){let s=f.fromXYW(t.x,t.y,t.z),i=f.fromXYW(e.x,e.y,e.z),o=f.fromXYW(n.x,n.y,n.z),a=r.getNormalizedWeight(t.z,e.z,n.z);return new r(s,i,o,a)}static fromXY(t,e,n,s,i,o,a){let p=new f(t,e),c=new f(n,s),u=new f(i,o);return new r(p,c,u,a)}static getNormalizedWeight(t,e,n){return e/Math.sqrt(t*n)}static getWeightFromVectors(t,e,n){let s=e.sub(t),i=n.sub(t);return s.dot(i)/Math.sqrt(s.lenSq()*i.lenSq())}static toObject(t){let e=f.toObject(t.p0),n=f.toObject(t.p1),s=f.toObject(t.p2);return{p0:e,p1:n,p2:s,w:t.w}}clone(){return new r(this.p0.clone(),this.p1.clone(),this.p2.clone(),this.w)}getBounds(){let t=Q.fromPoints(this.p0,this.p2),[e,n,s]=this.getDerivativeCoefficients(),i=st(e.x,.5*n.x,s.x),o=st(e.y,.5*n.y,s.y);return i.type===2&&(vt(this,t,i.x1),vt(this,t,i.x2)),o.type===2&&(vt(this,t,o.x1),vt(this,t,o.x2)),t}getControlBounds(){let t=Q.fromPoints(this.p0,this.p2);return t.enclose(this.p1),t}getDerivativeAt(t){let[e,n,s]=this.getProjectivePoints(),i=e.lerp(n,t),o=n.lerp(s,t),a=i.lerp(o,t),p=o.sub(i).mulS(2),c=p.x*a.z-a.x*p.z,u=p.y*a.z-a.y*p.z,l=a.z*a.z;return E.fromXYW(c,u,l)}getDerivativeCoefficients(){let[t,e,n]=this.getProjectivePoints(),s=n.x*e.z-e.x*n.z,i=n.y*e.z-e.y*n.z,o=n.x*t.z-t.x*n.z,a=n.y*t.z-t.y*n.z,p=e.x*t.z-t.x*e.z,c=e.y*t.z-t.y*e.z,u=new I(2*s,2*i,n.z),l=new I(o,a,e.z),d=new I(2*p,2*c,t.z),m=u.sub(l),h=l.sub(d),g=m.sub(h),y=h.mulS(2);return[g,y,d]}getProjectivePoints(){let t=I.fromXYW(this.p0.x,this.p0.y,1),e=I.fromXYW(this.p1.x,this.p1.y,this.w),n=I.fromXYW(this.p2.x,this.p2.y,1);return[t,e,n]}getSignedArea(){let t=this.p0.toVector(),e=this.p1.toVector(),n=this.p2.toVector(),s=this.w,i=t.cross(e),o=t.cross(n),a=e.cross(n),p=2**-23;if(s<1-p){if(s<=-1+p)return o/2;{let c=1-s*s,u=(1-s)/(1+s),l=Math.sqrt(c),d=Math.sqrt(u),m=s*s*(i+a)-o,h=2*s*(i+a-o),g=2*l*c;return(h*Math.atan(d)-m*l)/g}}else if(s<=1+p){let c=(2*i+o+2*a)/6,u=2/15*(o-i-a)*(s-1);return c-u}else{let c=s*s-1,u=(s-1)/(s+1),l=Math.sqrt(c),d=Math.sqrt(u),m=s*s*(i+a)-o,h=2*s*(i+a-o),g=2*l*c;return(m*l-h*Math.atanh(d))/g}}getTangentEnd(){return this.p2.eq(this.p1)?this.p1.sub(this.p0):this.p2.sub(this.p1)}getTangentStart(){return this.p1.eq(this.p0)?this.p2.sub(this.p1):this.p1.sub(this.p0)}getValueAt(t){let[e,n,s]=this.getProjectivePoints(),i=e.lerp(n,t),o=n.lerp(s,t),a=i.lerp(o,t);return f.fromXYW(a.x,a.y,a.z)}getWindingAt(t){let e=this.w*this.p1.y-this.w*t.y+t.y,n=this.p0.y-t.y,s=e-this.p0.y,i=this.p2.y-e,o=st(i-s,s,n),a=0;return o.type===2&&(a+=Xn(this,o.x1,t.x),a+=Xn(this,o.x2,t.x)),a}getWindingFracAt(t,e){let n=0;for(let s=0;s<1;s+=e){let i=this.getValueAt(s).sub(t),o=this.getDerivativeAt(s);n+=i.cross(o)/i.dot(i)}return e*n}isFinite(){return this.p0.isFinite()&&this.p1.isFinite()&&this.p2.isFinite()&&Number.isFinite(this.w)}isPoint(){return this.p0.eq(this.p1)&&this.p1.eq(this.p2)}reverse(){return new r(this.p2,this.p1,this.p0,this.w)}splitAfter(t){let[e,n,s]=this.getProjectivePoints(),i=e.lerp(n,t),o=n.lerp(s,t),a=i.lerp(o,t);return r.fromProjectivePoints(e,i,a)}splitAt(t){let[e,n,s]=this.getProjectivePoints(),i=e.lerp(n,t),o=n.lerp(s,t),a=i.lerp(o,t),p=r.fromProjectivePoints(e,i,a),c=r.fromProjectivePoints(a,o,s);return[p,c]}splitBefore(t){let[e,n,s]=this.getProjectivePoints(),i=n.lerp(s,t),a=e.lerp(n,t).lerp(i,t);return r.fromProjectivePoints(a,i,s)}splitBetween(t,e){let[n,s,i]=this.getProjectivePoints(),o=n.lerp(s,t),a=n.lerp(s,e),p=s.lerp(i,t),c=s.lerp(i,e),u=o.lerp(p,t),l=a.lerp(c,t),d=a.lerp(c,e);return r.fromProjectivePoints(u,l,d)}toArray(){return[this.p0.x,this.p0.y,this.p1.x,this.p1.y,this.p2.x,this.p2.y,this.w]}toString(){return`{p0: ${this.p0}, p1: ${this.p1}, p2: ${this.p2}, w: ${this.w}}`}};var se=class{curr;last;wasLast;constructor(t,e){this.curr=t,this.last=e,this.wasLast=!1}[Symbol.iterator](){return this}next(){let t=this.wasLast,e=this.curr;return this.wasLast=this.last===e||t,this.curr=e.lnext,{done:t,value:e}}},Ze=class{curr;last;wasLast;constructor(t,e){this.curr=t,this.last=e,this.wasLast=!1}[Symbol.iterator](){return this}next(){let t=this.wasLast,e=this.curr;return this.wasLast=this.last===e||t,this.curr=e.onext,{done:t,value:e}}},He=class{cIdx;commands;p0;pIdx;points;ps;constructor(t,e){this.commands=t,this.points=e,this.cIdx=0,this.pIdx=0,this.ps=f.createZero(),this.p0=f.createZero()}[Symbol.iterator](){return this}next(){let t=this.commands,e=this.points;for(;this.cIdx<t.length;){let n=t[this.cIdx++];switch(n.type){case 0:{this.ps=e[this.pIdx++],this.p0=this.ps;break}case 1:{let s=new R(this.p0,e[this.pIdx++]);return this.p0=s.p1,{done:!1,value:s}}case 2:{let s=new W(this.p0,e[this.pIdx++],e[this.pIdx++]);return this.p0=s.p2,{done:!1,value:s}}case 3:{let s=new $(this.p0,e[this.pIdx++],e[this.pIdx++],e[this.pIdx++]);return this.p0=s.p3,{done:!1,value:s}}case 4:{let s=new Z(this.p0,e[this.pIdx++],e[this.pIdx++],n.w);return this.p0=s.p2,{done:!1,value:s}}case 5:{let s=new R(this.p0,this.ps);if(this.p0=s.p1,!s.isPoint())return{done:!1,value:s};break}default:U(n)}}return{done:!0,value:void 0}}},Ke=class{idx;points;constructor(t){this.points=t,this.idx=1}[Symbol.iterator](){return this}next(){let t=this.points,e=this.idx;if(e<t.length){let n=new O(t[e-1],t[e]);return this.idx+=1,{done:!1,value:n}}else if(e===t.length){let n=new O(t[e-1],t[0]);return this.idx+=1,{done:!1,value:n}}else return{done:!0,value:void 0}}};var fe=class{currentIndex;currentLength;currentPhase;dashArray;isFirst;output;path;pathFirst;startAdvancedLength;startIndex;startPhase;constructor(){this.currentIndex=0,this.currentLength=0,this.currentPhase=!1,this.dashArray=[],this.isFirst=!0,this.output=w.createEmpty(),this.startAdvancedLength=0,this.startIndex=0,this.startPhase=!1;let t=w.createEmpty();this.path=t,this.pathFirst=t}dashDegenerateQuad(t,e,n){let s=new W(t,e,e),i=new W(e,e,n);this.dashQuadraticSimple(s),this.dashQuadraticSimple(i)}dashFirst(t,e){this.currentPhase&&e.isZero()&&this.insertMove(t)}dashLinear(t){let e=this.getDashLength()-this.currentLength,n=ie(t),s=t;for(;e<n;){let i=$n(s,e),o=s.splitAfter(i);this.currentPhase?this.insertLinear(o.p0):this.insertMove(o.p0),this.advance(),e=this.getDashLength(),n=ie(o),s=o}this.currentLength+=n,this.currentPhase&&this.insertLinear(s.p1)}dashQuadraticSimple(t){let e=this.getDashLength()-this.currentLength,n=re(t),s=t;for(;e<n;){let i=Jn(s,e),[o,a]=s.splitAt(i);this.currentPhase?this.insertQuadratic(o.p1,o.p2):this.insertMove(o.p2),this.advance(),e=this.getDashLength(),n=re(a),s=a}this.currentLength+=n,this.currentPhase&&this.insertQuadratic(s.p1,s.p2)}finalizeClosed(t){this.startPhase&&t.addPath(this.pathFirst,this.currentPhase),this.reset()}finalizeOpen(t){this.startPhase&&t.addPath(this.pathFirst,!1),this.reset()}initialize(t,e){this.dashArray=e.array;let[n,s,i]=Kn(e.array,e.offset);this.startAdvancedLength=n,this.startIndex=s,this.startPhase=i,this.output=t,this.reset()}advance(){let t=$e(this.dashArray,this.currentIndex);this.currentLength=0,this.currentIndex=t,this.currentPhase=!this.currentPhase,this.isFirst&&(this.isFirst=!1,this.path=this.output)}getDashLength(){return this.dashArray[this.currentIndex]}insertLinear(t){this.path.lineTo(t)}insertMove(t){this.path.moveTo(t)}insertQuadratic(t,e){this.path.quadTo(t,e)}reset(){this.pathFirst.clear(),this.currentIndex=this.startIndex,this.currentLength=this.startAdvancedLength,this.startPhase?(this.path=this.pathFirst,this.currentPhase=!0,this.isFirst=!0):(this.path=this.output,this.currentPhase=!1,this.isFirst=!1)}};function $e(r,t){return(t+1)%r.length}function Kn(r,t){let e=2*ba(r),n=t%e;n<0&&(n+=e);let s=0,i=!0;for(e=r[s];n>=e;)n-=e,s=$e(r,s),i=!i,e=r[s];return e=n,[e,s,i]}function ie(r){return r.p1.distanceTo(r.p0)}function $n(r,t){return t/ie(r)}function re(r){return Oi(r)}function Jn(r,t){let e=Hn(r,t);if(e>=1)return 1;let[n,s]=r.splitAt(e),i=t-re(n),o=(1-e)*Hn(s,i);return e+o}function ba(r){let t=0;for(let e of r)t+=e;return t}function oe(r,t){let e=r.p1.sub(r.p0),n=r.p2.sub(r.p1);return e.dot(n)>t*Math.sqrt(e.lenSq()*n.lenSq())}function Wt(r,t){let[e,n]=r.getDerivativeCoefficients();return t*n.lenSq()/(Math.abs(e.cross(n))-t*e.dot(n))}function qt(r){let t=r.p1.sub(r.p0),e=r.p2.sub(r.p1);return r.p3.sub(r.p2).sub(e).sub(e).add(t).len()}function It(r,t,e){let n=r.p1.sub(r.p0),s=r.p2.sub(r.p1),o=r.p3.sub(r.p2).sub(s).sub(s).add(n),a=t*e;return Math.pow(a*a/o.lenSq(),1/6)}function Nt(r,t){let e=r.p1.sub(r.p0),n=r.p2.sub(r.p1);return Math.abs(r.w-1)*n.sub(e).len()<t*(r.w+1)}function At(r,t,e){let n=r.p1.sub(r.p0),i=r.p2.sub(r.p1).sub(n),o=t*e*(r.w+1);return Math.pow(o/(Math.abs(r.w-1)*i.len()),1/4)}function _n(r){let t=r.p0.lerp(r.p1,1.5),e=r.p3.lerp(r.p2,1.5),n=t.lerp(e,.5);return new W(r.p0,n,r.p3)}function it(r){let t=r.p0.lerp(r.p1,.75),e=r.p3.lerp(r.p2,.75),n=t.lerp(e,.5),s=new W(r.p0,t,n),i=new W(n,e,r.p3);return[s,i]}function J(r){return new W(r.p0,r.p1,r.p2)}function zt(r){let t=r.p1.sub(r.p0),e=r.p2.sub(r.p1);return t.dot(e)<Je*Math.sqrt(t.lenSq()*e.lenSq())}var _e=class{state;simplifyTolerance;tanOffsetTolerance;constructor(t){this.simplifyTolerance=t.simplifyTolerance,this.tanOffsetTolerance=Math.tan(t.offsetTolerance),this.state=new fe}process(t,e,n){if(!t.isValid())return;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=f.createZero(),c=f.createZero(),u=E.createZero();for(this.initialize(e,n);o<s.length;){let l=s[o++];switch(l.type){case 0:{u.isZero()||this.state.finalizeOpen(e),c=i[a++],u=E.createZero(),p=c;break}case 1:{let d=new R(c,i[a++]),m=d.getDerivative();m.isZero()||(this.state.dashFirst(c,u),this.state.dashLinear(d),c=d.p1,u=m);break}case 2:{let d=new W(c,i[a++],i[a++]);d.getTangentStart().isZero()||(this.state.dashFirst(c,u),this.dashQuadratic(d),c=d.p2,u=d.getTangentEnd());break}case 3:{let d=new $(c,i[a++],i[a++],i[a++]);d.getTangentStart().isZero()||(this.state.dashFirst(c,u),this.dashCubic(d),c=d.p3,u=d.getTangentEnd());break}case 4:{let d=new Z(c,i[a++],i[a++],l.w);d.getTangentStart().isZero()||(this.state.dashFirst(c,u),this.dashConic(d),c=d.p2,u=d.getTangentEnd());break}case 5:{let d=new R(c,p);d.getDerivative().isZero()||this.state.dashLinear(d),u.isZero()||this.state.finalizeClosed(e),c=p,u=E.createZero();break}default:U(l)}}u.isZero()||this.state.finalizeOpen(e)}setQualityOptions(t){this.simplifyTolerance=t.simplifyTolerance,this.tanOffsetTolerance=Math.tan(t.offsetTolerance)}dashConic(t){let e=At(t,4,this.simplifyTolerance),n=t;for(;e<1;){let[i,o]=n.splitAt(e),a=J(i);this.dashQuadratic(a),e=e/(1-e),n=o}let s=J(n);this.dashQuadratic(s)}dashCubic(t){let e=It(t,54,this.simplifyTolerance),n=t;for(;e<1;){let[o,a]=n.splitAt(e),[p,c]=it(o);this.dashQuadratic(p),this.dashQuadratic(c),e=e/(1-e),n=a}let[s,i]=it(n);this.dashQuadratic(s),this.dashQuadratic(i)}dashQuadratic(t){let e=t.getVertexParameter();e>0&&e<1&&zt(t)?this.state.dashDegenerateQuad(t.p0,t.getValueAt(e),t.p2):this.dashQuadraticSimplify(t)}dashQuadraticSimplify(t){let e=Wt(t,this.tanOffsetTolerance),n=t;for(;e>0&&e<pt;){let[s,i]=n.splitAt(e);this.state.dashQuadraticSimple(s),e=Wt(i,this.tanOffsetTolerance),n=i}this.state.dashQuadraticSimple(n)}initialize(t,e){this.state.initialize(t,e)}},tn=class{state;cosOffsetTolerance;simplifyTolerance;constructor(t){this.simplifyTolerance=t.simplifyTolerance,this.cosOffsetTolerance=Math.cos(t.offsetTolerance),this.state=new fe}process(t,e,n){if(!t.isValid())return;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=f.createZero(),c=f.createZero(),u=E.createZero();for(this.state.initialize(e,n);o<s.length;){let l=s[o++];switch(l.type){case 0:{u.isZero()||this.state.finalizeOpen(e),c=i[a++],u=E.createZero(),p=c;break}case 1:{let d=new R(c,i[a++]),m=d.getDerivative();m.isZero()||(this.state.dashFirst(c,u),this.state.dashLinear(d),c=d.p1,u=m);break}case 2:{let d=new W(c,i[a++],i[a++]);d.getTangentStart().isZero()||(this.state.dashFirst(c,u),this.dashQuadratic(d),c=d.p2,u=d.getTangentEnd());break}case 3:{let d=new $(c,i[a++],i[a++],i[a++]);d.getTangentStart().isZero()||(this.state.dashFirst(c,u),this.dashCubic(d),c=d.p3,u=d.getTangentEnd());break}case 4:{let d=new Z(c,i[a++],i[a++],l.w);d.getTangentStart().isZero()||(this.state.dashFirst(c,u),this.dashConic(d),c=d.p2,u=d.getTangentEnd());break}case 5:{let d=new R(c,p);d.getDerivative().isZero()||this.state.dashLinear(d),u.isZero()||this.state.finalizeClosed(e),c=p,u=E.createZero();break}default:U(l)}}u.isZero()||this.state.finalizeOpen(e)}setQualityOptions(t){this.simplifyTolerance=t.simplifyTolerance,this.cosOffsetTolerance=Math.cos(t.offsetTolerance)}dashConic(t){let e=4*this.simplifyTolerance,n=s=>{if(Nt(s,e)){let i=J(s);this.dashQuadratic(i)}else{let[i,o]=s.splitAt(.5);n(i),n(o)}};n(t)}dashCubic(t){let e=54*this.simplifyTolerance,n=qt(t),s=(i,o)=>{if(e>o){let[a,p]=it(i);this.dashQuadratic(a),this.dashQuadratic(p)}else{let[a,p]=i.splitAt(.5);s(a,.125*o),s(p,.125*o)}};s(t,n)}dashQuadratic(t){let e=t.getVertexParameter();e>0&&e<1&&zt(t)?this.state.dashDegenerateQuad(t.p0,t.getValueAt(e),t.p2):this.dashQuadraticSimplify(t)}dashQuadraticSimplify(t){let e=this.cosOffsetTolerance,n=s=>{if(oe(s,e))this.state.dashQuadraticSimple(s);else{let[i,o]=s.splitAt(.5);n(i),n(o)}};n(t)}};var en=class{simplifyTolerance;tolerance;constructor(t){this.tolerance=t.flattenTolerance,this.simplifyTolerance=t.simplifyTolerance}process(t,e,n){if(!t.isValid())return;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=f.createZero(),c=f.createZero();for(;o<s.length;){let u=s[o++];switch(u.type){case 0:{n&&!c.eq(p)&&e.lineTo(p),p=i[a++],e.moveTo(p),c=p;break}case 1:{let l=i[a++];e.lineTo(l),c=l;break}case 2:{let l=new W(c,i[a++],i[a++]);this.flattenQuadratic(l,e),c=l.p2;break}case 3:{let l=new $(c,i[a++],i[a++],i[a++]);this.flattenCubic(l,e),c=l.p3;break}case 4:{let l=new Z(c,i[a++],i[a++],u.w);this.flattenConic(l,e),c=l.p2;break}case 5:{c.eq(p)||e.lineTo(p),e.close();break}default:U(u)}}n&&!c.eq(p)&&(e.lineTo(p),e.close())}setQualityOptions(t){this.tolerance=t.flattenTolerance,this.simplifyTolerance=t.simplifyTolerance}flattenConic(t,e){let n=At(t,4,this.simplifyTolerance),s=t;for(;n<1;){let[i,o]=s.splitAt(n);this.flattenQuadratic(J(i),e),n=n/(1-n),s=o}this.flattenQuadratic(J(s),e)}flattenCubic(t,e){let n=It(t,54,this.simplifyTolerance),s=t;for(;n<1;){let[i,o]=s.splitAt(n);this.flattenQuadratic(_n(i),e),n=n/(1-n),s=o}this.flattenQuadratic(_n(s),e)}flattenQuadratic(t,e){let[n,s,i]=t.getCoefficients(),o=Math.sqrt(4*this.tolerance/n.len());for(let a=o;a<1;a+=o){let p=n.mulS(a).add(s).mulS(a).addP(i);e.lineTo(p)}e.lineTo(t.p2)}},nn=class{tolerance;constructor(t){this.tolerance=t.flattenTolerance}process(t,e,n){if(!t.isValid())return;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=f.createZero(),c=f.createZero();for(;o<s.length;){let u=s[o++];switch(u.type){case 0:{n&&!c.eq(p)&&e.lineTo(p),p=i[a++],e.moveTo(p),c=p;break}case 1:{let l=i[a++];e.lineTo(l),c=l;break}case 2:{let l=new W(c,i[a++],i[a++]);this.flattenQuadratic(l,e),c=l.p2;break}case 3:{let l=new $(c,i[a++],i[a++],i[a++]);this.flattenCubic(l,e),c=l.p3;break}case 4:{let l=new Z(c,i[a++],i[a++],u.w);this.flattenConic(l,e),c=l.p2;break}case 5:{c.eq(p)||e.lineTo(p),e.close();break}default:U(u)}}n&&!c.eq(p)&&(e.lineTo(p),e.close())}setQualityOptions(t){this.tolerance=t.flattenTolerance}flattenConic(t,e){let n=this.tolerance*this.tolerance,s=i=>{let o=i.p2.sub(i.p0),p=i.w/(i.w+1)*o.cross(i.p1.sub(i.p0));if(p*p>n*o.lenSq()){let[c,u]=i.splitAt(.5);s(c),s(u)}else e.lineTo(i.p2)};s(t)}flattenCubic(t,e){let s=1.7777777777777777*this.tolerance*this.tolerance,i=o=>{let a=o.p3.sub(o.p0);a.isZero()&&(a=o.p2.sub(o.p1));let p=a.cross(o.p1.sub(o.p0)),c=a.cross(o.p2.sub(o.p0));if(Math.max(p*p,c*c)>s*a.lenSq()){let[u,l]=o.splitAt(.5);i(u),i(l)}else e.lineTo(o.p3)};i(t)}flattenQuadratic(t,e){let s=4*this.tolerance*this.tolerance,i=o=>{let a=o.p2.sub(o.p0),p=a.cross(o.p1.sub(o.p0));if(p*p>s*a.lenSq()){let[c,u]=o.splitAt(.5);i(c),i(u)}else e.lineTo(o.p2)};i(t)}};function ae(r,t,e){let n=t.getTangentStart(),s=t.getTangentEnd();n.isZero()||(n=n.unit().normal(),s=s.unit().normal(),n=n.add(s),n=n.mulS(2*e).divS(n.lenSq()),s=s.mulS(e),r.quadTo(t.p1.addV(n),t.p2.addV(s)))}function ts(r,t,e,n,s){let i=new W(t,e,e),o=new W(e,e,n),a=e.sub(t).unit().normal(),p=n.sub(e).unit().normal();ae(r,i,s),Bt(r,e,a,p,s,0,3),ae(r,o,s)}function es(r,t,e,n,s,i,o){let a=e.unit().normal(),p=n.unit().normal();a.dot(p)<on&&(s*a.cross(p)>=0?Bt(r,t,a,p,s,i,o):sn(r,t,p,s))}function Bt(r,t,e,n,s,i,o){let a=i*Math.abs(s);switch(o){case 0:{r.lineTo(t.addVMulS(n,s));break}case 1:{let p=e.add(n);p=p.mulS(2*s).divS(p.lenSq()),p.lenSq()<=a*a&&r.lineTo(t.addV(p)),r.lineTo(t.addVMulS(n,s));break}case 2:{let p=e.add(n);p=p.mulS(2*s).divS(p.lenSq());let c=t.addVMulS(e,s),u=t.addVMulS(n,s);if(p.lenSq()<=a*a)r.lineTo(t.addV(p));else if(e.dot(n)<=Je)r.lineTo(c.addVMulS(e.normal(),-a)),r.lineTo(u.addVMulS(n.normal(),a));else{let l=p.dot(t.sub(c)),d=p.dot(p),m=(l+a*Math.sqrt(d))/(l+d);if(m>0){let h=t.addV(p);r.lineTo(c.lerp(h,m)),r.lineTo(u.lerp(h,m))}}r.lineTo(u);break}case 3:{let p=t.addVMulS(e,s),c=t.addVMulS(n,s);if(e.dot(n)<0){let u=c.sub(p).unitOrZero().normal(),l=e.add(u);l=l.mulS(2*s).divS(l.lenSq());let d=t.addV(l),m=t.addVMulS(u,s),h=d.lerp(m,2),g=Z.getWeightFromVectors(t,d,m);r.conicTo(d,m,g),r.conicTo(h,c,g)}else{let u=e.add(n);u=u.mulS(2*s).divS(u.lenSq());let l=t.addV(u),d=Z.getWeightFromVectors(t,l,c);r.conicTo(l,c,d)}break}default:U(o)}}function sn(r,t,e,n){r.lineTo(t),r.lineTo(t.addVMulS(e,n))}var an=class{buffer;d;join;miterLimit;ms;ps;simplifyTolerance;tanOffsetTolerance;constructor(t){this.simplifyTolerance=t.simplifyTolerance,this.tanOffsetTolerance=Math.tan(t.offsetTolerance),this.buffer=w.createEmpty(),this.d=0,this.join=0,this.miterLimit=0,this.ms=E.createZero(),this.ps=f.createZero()}process(t,e,n){if(!t.isValid())return;this.join=n.join,this.miterLimit=n.miterLimit,this.d=n.distance;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=this.ps,c=E.createZero();for(this.buffer.clear();o<s.length;){let u=s[o++];switch(u.type){case 0:{c.isZero()||this.finalizeOpenOffset(e),p=i[a++],c=E.createZero(),this.ps=p;break}case 1:{let l=new R(p,i[a++]),d=l.getDerivative();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetLinear(l.p1,d),p=l.p1,c=d);break}case 2:{let l=new W(p,i[a++],i[a++]),d=l.getTangentStart();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetQuadratic(l),p=l.p2,c=l.getTangentEnd());break}case 3:{let l=new $(p,i[a++],i[a++],i[a++]),d=l.getTangentStart();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetCubic(l),p=l.p3,c=l.getTangentEnd());break}case 4:{let l=new Z(p,i[a++],i[a++],u.w),d=l.getTangentStart();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetConic(l),p=l.p2,c=l.getTangentEnd());break}case 5:{let l=new R(p,this.ps),d=l.getDerivative();d.isZero()||(this.offsetFirstOrJoin(l.p0,c,d),this.offsetLinear(l.p1,d),c=d),c.isZero()||(this.offsetFirstOrJoin(this.ps,c,this.ms),this.finalizeClosed(e)),p=this.ps,c=E.createZero();break}default:U(u)}}c.isZero()||this.finalizeOpenOffset(e)}setQualityOptions(t){this.simplifyTolerance=t.simplifyTolerance,this.tanOffsetTolerance=Math.tan(t.offsetTolerance)}finalizeClosed(t){this.buffer.close(),t.addPath(this.buffer,!1),this.buffer.clear()}finalizeOpenOffset(t){t.addPath(this.buffer,!1),this.buffer.clear()}offsetConic(t){let e=At(t,4,this.simplifyTolerance),n=t;for(;e<1;){let[i,o]=n.splitAt(e),a=J(i);this.offsetQuadratic(a),e=e/(1-e),n=o}let s=J(n);this.offsetQuadratic(s)}offsetCubic(t){let e=It(t,54,this.simplifyTolerance),n=t;for(;e<1;){let[o,a]=n.splitAt(e),[p,c]=it(o);this.offsetQuadratic(p),this.offsetQuadratic(c),e=e/(1-e),n=a}let[s,i]=it(n);this.offsetQuadratic(s),this.offsetQuadratic(i)}offsetFirstOrJoin(t,e,n){e.isZero()?(this.offsetMove(t,n),this.ms=n):es(this.buffer,t,e,n,this.d,this.miterLimit,this.join)}offsetLinear(t,e){let n=e.unit().normal().mulS(this.d);this.buffer.lineTo(t.addV(n))}offsetMove(t,e){let n=e.unit().normal().mulS(this.d);this.buffer.moveTo(t.addV(n))}offsetQuadratic(t){let[e,n]=t.getOffsetCuspParameter(this.d),s=e-n,i=e+n;if(s<1&&i>0)if(zt(t))ts(this.buffer,t.p0,t.getValueAt(e),t.p2,this.d);else{let o=0;s>o&&s<pt&&(this.offsetQuadraticSimplify(t.splitBefore(s),this.d),o=s),i>o&&i<pt&&(this.offsetQuadraticSimplify(t.splitBetween(o,i),this.d),o=i),o>0?this.offsetQuadraticSimplify(t.splitAfter(o),this.d):this.offsetQuadraticSimplify(t,this.d)}else this.offsetQuadraticSimplify(t,this.d)}offsetQuadraticSimplify(t,e){let n=Wt(t,this.tanOffsetTolerance),s=t;for(;n>0&&n<pt;){let[i,o]=s.splitAt(n);ae(this.buffer,i,e),n=Wt(o,this.tanOffsetTolerance),s=o}ae(this.buffer,s,e)}},pn=class{buffer;cosOffsetTolerance;d;join;miterLimit;ms;ps;simplifyTolerance;constructor(t){this.simplifyTolerance=t.simplifyTolerance,this.cosOffsetTolerance=Math.cos(t.offsetTolerance),this.buffer=w.createEmpty(),this.d=0,this.join=0,this.miterLimit=0,this.ms=E.createZero(),this.ps=f.createZero()}process(t,e,n){if(!t.isValid())return;this.join=n.join,this.miterLimit=n.miterLimit,this.d=n.distance;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=this.ps,c=E.createZero();for(this.buffer.clear();o<s.length;){let u=s[o++];switch(u.type){case 0:{c.isZero()||this.finalizeOpenOffset(e),p=i[a++],c=E.createZero(),this.ps=p;break}case 1:{let l=new R(p,i[a++]),d=l.getDerivative();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetLinear(l.p1,d),p=l.p1,c=d);break}case 2:{let l=new W(p,i[a++],i[a++]),d=l.getTangentStart();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetQuadratic(l),p=l.p2,c=l.getTangentEnd());break}case 3:{let l=new $(p,i[a++],i[a++],i[a++]),d=l.getTangentStart();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetCubic(l),p=l.p3,c=l.getTangentEnd());break}case 4:{let l=new Z(p,i[a++],i[a++],u.w),d=l.getTangentStart();d.isZero()||(this.offsetFirstOrJoin(p,c,d),this.offsetConic(l),p=l.p2,c=l.getTangentEnd());break}case 5:{let l=new R(p,this.ps),d=l.getDerivative();d.isZero()||(this.offsetFirstOrJoin(l.p0,c,d),this.offsetLinear(l.p1,d),c=d),c.isZero()||(this.offsetFirstOrJoin(this.ps,c,this.ms),this.finalizeClosed(e)),p=this.ps,c=E.createZero();break}default:U(u)}}c.isZero()||this.finalizeOpenOffset(e)}setQualityOptions(t){this.simplifyTolerance=t.simplifyTolerance,this.cosOffsetTolerance=Math.tan(t.offsetTolerance)}finalizeClosed(t){this.buffer.close(),t.addPath(this.buffer,!1),this.buffer.clear()}finalizeOpenOffset(t){t.addPath(this.buffer,!1),this.buffer.clear()}offsetConic(t){let e=4*this.simplifyTolerance,n=s=>{if(Nt(s,e)){let i=J(s);this.offsetQuadratic(i)}else{let[i,o]=s.splitAt(.5);n(i),n(o)}};n(t)}offsetCubic(t){let e=54*this.simplifyTolerance,n=qt(t),s=(i,o)=>{if(e>o){let[a,p]=it(i);this.offsetQuadratic(a),this.offsetQuadratic(p)}else{let[a,p]=i.splitAt(.5);s(a,.125*o),s(p,.125*o)}};s(t,n)}offsetFirstOrJoin(t,e,n){e.isZero()?(this.offsetMove(t,n),this.ms=n):es(this.buffer,t,e,n,this.d,this.miterLimit,this.join)}offsetLinear(t,e){let n=e.unit().normal().mulS(this.d);this.buffer.lineTo(t.addV(n))}offsetMove(t,e){let n=e.unit().normal().mulS(this.d);this.buffer.moveTo(t.addV(n))}offsetQuadratic(t){let[e,n]=t.getOffsetCuspParameter(this.d),s=e-n,i=e+n;if(s<1&&i>0)if(zt(t))ts(this.buffer,t.p0,t.getValueAt(e),t.p2,this.d);else{let o=0;s>o&&s<pt&&(this.offsetQuadraticSimplify(t.splitBefore(s),this.d),o=s),i>o&&i<pt&&(this.offsetQuadraticSimplify(t.splitBetween(o,i),this.d),o=i),o>0?this.offsetQuadraticSimplify(t.splitAfter(o),this.d):this.offsetQuadraticSimplify(t,this.d)}else this.offsetQuadraticSimplify(t,this.d)}offsetQuadraticSimplify(t,e){let n=this.cosOffsetTolerance,s=i=>{if(oe(i,n))ae(this.buffer,i,e);else{let[o,a]=i.splitAt(.5);s(o),s(a)}};s(t)}};var cn=class{tolerance;constructor(t){this.tolerance=t.simplifyTolerance}process(t,e){if(!t.isValid())return;let n=t.getCommands(),s=t.getPoints(),i=0,o=0,a=f.createZero();for(;i<n.length;){let p=n[i++];switch(p.type){case 0:{a=s[o++],e.moveTo(a);break}case 1:{let c=s[o++];e.lineTo(c),a=c;break}case 2:{let c=new W(a,s[o++],s[o++]);e.quadTo(c.p1,c.p2),a=c.p2;break}case 3:{let c=new $(a,s[o++],s[o++],s[o++]);this.simplifyCubic(e,c),a=c.p3;break}case 4:{let c=new Z(a,s[o++],s[o++],p.w);this.simplifyConic(e,c),a=c.p2;break}case 5:{e.close();break}default:U(p)}}}setQualityOptions(t){this.tolerance=t.simplifyTolerance}simplifyConic(t,e){let n=At(e,4,this.tolerance),s=e;for(;n<1;){let[o,a]=s.splitAt(n),p=J(o);t.quadTo(p.p1,p.p2),n=n/(1-n),s=a}let i=J(s);t.quadTo(i.p1,i.p2)}simplifyCubic(t,e){let n=It(e,54,this.tolerance),s=e;for(;n<1;){let[a,p]=s.splitAt(n),[c,u]=it(a);t.quadTo(c.p1,c.p2),t.quadTo(u.p1,u.p2),n=n/(1-n),s=p}let[i,o]=it(s);t.quadTo(i.p1,i.p2),t.quadTo(o.p1,o.p2)}},un=class{tolerance;constructor(t){this.tolerance=t.simplifyTolerance}process(t,e){if(!t.isValid())return;let n=t.getCommands(),s=t.getPoints(),i=0,o=0,a=f.createZero();for(;i<n.length;){let p=n[i++];switch(p.type){case 0:{a=s[o++],e.moveTo(a);break}case 1:{let c=s[o++];e.lineTo(c),a=c;break}case 2:{let c=new W(a,s[o++],s[o++]);e.quadTo(c.p1,c.p2),a=c.p2;break}case 3:{let c=new $(a,s[o++],s[o++],s[o++]);this.simplifyCubic(e,c),a=c.p3;break}case 4:{let c=new Z(a,s[o++],s[o++],p.w);this.simplifyConic(e,c),a=c.p2;break}case 5:{e.close();break}default:U(p)}}}setQualityOptions(t){this.tolerance=t.simplifyTolerance}simplifyConic(t,e){let n=4*this.tolerance,s=i=>{if(Nt(i,n)){let o=J(i);t.quadTo(o.p1,o.p2)}else{let[o,a]=i.splitAt(.5);s(o),s(a)}};s(e)}simplifyCubic(t,e){let n=54*this.tolerance,s=qt(e),i=(o,a)=>{if(n>a){let[p,c]=it(o);t.quadTo(p.p1,p.p2),t.quadTo(c.p1,c.p2)}else{let[p,c]=o.splitAt(.5);i(p,.125*a),i(c,.125*a)}};i(e,s)}};var be=class{caps;currentIndex;currentLength;currentPhase;dashArray;dashCaps;distance;isDash;isFirstDash;join;left;leftFirst;leftMain;miterLimit;ms;output;right;rightFirst;rightMain;startAdvancedLength;startIndex;startPhase;constructor(){this.caps=Ft.caps,this.dashArray=Ft.dashArray,this.dashCaps=Ft.dashCaps,this.distance=.5*Ft.width,this.join=Ft.join,this.miterLimit=Ft.miterLimit,this.currentIndex=0,this.currentLength=0,this.currentPhase=!1,this.isDash=!1,this.isFirstDash=!0,this.ms=E.createZero(),this.output=w.createEmpty(),this.startAdvancedLength=0,this.startIndex=0,this.startPhase=!1;let t=w.createEmpty(),e=w.createEmpty(),n=w.createEmpty(),s=w.createEmpty();this.left=t,this.leftFirst=t,this.leftMain=n,this.right=e,this.rightFirst=e,this.rightMain=s}finalizeClosed(){this.isDash?this.finalizeClosedDashStroke():this.finalizeClosedStroke()}finalizeOpen(){this.isDash?this.finalizeOpenDashStroke():this.finalizeOpenStroke()}finalizePoint(t){let e=E.createUnitX();this.insertMoveStroke(t,e),this.finalizeOpen()}initialize(t,e){this.output=t,e.dashArray.length>0?(this.initializeStroke(e),this.initializeDashStroke(e),this.resetDash(),this.isDash=!0):(this.initializeStroke(e),this.resetStroke(),this.left=this.leftMain,this.right=this.rightMain,this.isDash=!1)}strokeFirstOrJoin(t,e,n){this.isDash?this.insertFirstOrJoinDashStroke(t,e,n):this.insertFirstOrJoinStroke(t,e,n)}strokeLinear(t,e){this.isDash?this.insertLinearDashStroke(t):this.insertLinearStroke(t.p1,e)}strokeQuadraticDegenerate(t,e,n){this.isDash?this.insertQuadraticDegenerateDashStroke(t,e,n):this.insertQuadraticDegenerateStroke(t,e,n)}strokeQuadraticSimple(t){this.isDash?this.insertQuadraticSimpleDashStroke(t):this.insertQuadraticSimpleStroke(t)}advanceDash(){let t=$e(this.dashArray,this.currentIndex);this.isFirstDash?(this.isFirstDash=!1,this.left=this.leftMain,this.right=this.rightMain):this.currentPhase&&($t(this.output,this.leftMain,this.rightMain,this.dashCaps.start,this.dashCaps.end),this.resetStroke()),this.currentLength=0,this.currentIndex=t,this.currentPhase=!this.currentPhase}finalizeClosedDashStroke(){this.startPhase&&this.currentPhase?this.isFirstDash?(this.leftFirst.close(),this.rightFirst.close(),this.output.addPath(this.leftFirst,!1),this.output.addPathReversed(this.rightFirst,!1)):(this.leftMain.addPath(this.leftFirst,!0),this.rightMain.addPath(this.rightFirst,!0),$t(this.output,this.leftMain,this.rightMain,this.dashCaps.start,this.dashCaps.end)):($t(this.output,this.leftMain,this.rightMain,this.dashCaps.start,this.caps.end),$t(this.output,this.leftFirst,this.rightFirst,this.caps.start,this.dashCaps.end)),this.resetDash()}finalizeClosedStroke(){this.left.close(),this.right.close(),this.output.addPath(this.left,!1),this.output.addPathReversed(this.right,!1),this.resetStroke()}finalizeOpenDashStroke(){this.isFirstDash||$t(this.output,this.leftMain,this.rightMain,this.dashCaps.start,this.caps.end),this.startPhase&&$t(this.output,this.leftFirst,this.rightFirst,this.caps.start,this.dashCaps.end),this.resetDash()}finalizeOpenStroke(){$t(this.output,this.left,this.right,this.caps.start,this.caps.end),this.resetStroke()}getDashLength(){return this.dashArray[this.currentIndex]}initializeDashStroke(t){this.dashArray=t.dashArray,this.dashCaps=t.dashCaps;let[e,n,s]=Kn(t.dashArray,t.dashOffset);this.startAdvancedLength=e,this.startIndex=n,this.startPhase=s}initializeStroke(t){this.caps=t.caps,this.distance=.5*t.width,this.join=t.join,this.miterLimit=t.miterLimit}insertFirstOrJoinDashStroke(t,e,n){this.currentPhase&&this.insertFirstOrJoinStroke(t,e,n)}insertFirstOrJoinStroke(t,e,n){e.isZero()?(this.insertMoveStroke(t,n),this.ms=n):ga(this.left,this.right,t,e,n,this.distance,this.miterLimit,this.join)}insertLinearDashStroke(t){let e=this.getDashLength()-this.currentLength,n=ie(t),s=t;for(;e<n;){let i=$n(s,e),o=s.splitAfter(i),a=o.getDerivative();this.currentPhase?this.insertLinearStroke(o.p0,a):this.insertMoveStroke(o.p0,a),this.advanceDash(),e=this.getDashLength(),n=ie(o),s=o}if(this.currentLength+=n,this.currentPhase){let i=s.getTangentStart();this.insertLinearStroke(s.p1,i)}}insertLinearStroke(t,e){let n=e.unit().normal().mulS(this.distance);this.left.lineTo(t.addV(n)),this.right.lineTo(t.subV(n))}insertMoveStroke(t,e){let n=e.unit().normal().mulS(this.distance);this.left.moveTo(t.addV(n)),this.right.moveTo(t.subV(n))}insertQuadraticDegenerateDashStroke(t,e,n){let s=new W(t,e,e),i=new W(e,e,n),o=e.sub(t).unit().normal(),a=n.sub(e).unit().normal();this.insertQuadraticSimpleStroke(s),this.currentPhase&&(Bt(this.left,e,o,a,this.distance,0,3),Bt(this.right,e,o.neg(),a.neg(),this.distance,0,3)),this.insertQuadraticSimpleStroke(i)}insertQuadraticDegenerateStroke(t,e,n){let s=new W(t,e,e),i=new W(e,e,n),o=e.sub(t).unit().normal(),a=n.sub(e).unit().normal();this.insertQuadraticSimpleStroke(s),Bt(this.left,e,o,a,this.distance,0,3),Bt(this.right,e,o.neg(),a.neg(),this.distance,0,3),this.insertQuadraticSimpleStroke(i)}insertQuadraticSimpleDashStroke(t){let e=this.getDashLength()-this.currentLength,n=re(t),s=t;for(;e<n;){let i=Jn(s,e),[o,a]=s.splitAt(i);if(this.currentPhase)this.insertQuadraticSimpleStroke(o);else{let p=a.getTangentStart();this.insertMoveStroke(a.p0,p)}this.advanceDash(),e=this.getDashLength(),n=re(a),s=a}this.currentLength+=n,this.currentPhase&&this.insertQuadraticSimpleStroke(s)}insertQuadraticSimpleStroke(t){let e=t.getTangentStart(),n=t.getTangentEnd();if(!e.isZero()){let s=this.distance;e=e.unit().normal(),n=n.unit().normal(),e=e.add(n),e=e.mulS(2*s).divS(e.lenSq()),n=n.mulS(s),this.left.quadTo(t.p1.addV(e),t.p2.addV(n)),this.right.quadTo(t.p1.subV(e),t.p2.subV(n))}}resetDash(){this.leftFirst.clear(),this.rightFirst.clear(),this.leftMain.clear(),this.rightMain.clear(),this.currentIndex=this.startIndex,this.currentLength=this.startAdvancedLength,this.startPhase?(this.left=this.leftFirst,this.right=this.rightFirst,this.currentPhase=!0,this.isFirstDash=!0):(this.left=this.leftMain,this.right=this.rightMain,this.currentPhase=!1,this.isFirstDash=!1)}resetStroke(){this.leftMain.clear(),this.rightMain.clear()}};function ga(r,t,e,n,s,i,o,a){let p=n.unit().normal(),c=s.unit().normal();p.dot(c)<on&&(p.cross(c)>=0?(Bt(r,e,p,c,i,o,a),sn(t,e,c,-i)):(Bt(t,e,p,c,-i,o,a),sn(r,e,c,i)))}function Ri(r,t,e){switch(e){case 0:{r.lineTo(t);break}case 1:{let n=r.getLastPoint();if(n===void 0)break;let s=t.sub(n).mulS(.5).normal();r.lineTo(n.addV(s)),r.lineTo(t.addV(s)),r.lineTo(t);break}case 2:{let n=r.getLastPoint();if(n===void 0)break;let s=t.sub(n).mulS(.5).normal(),i=s.sub(s.normal());r.arcTo(n.addV(s),n.addV(i)),r.arcTo(t.addV(s),t);break}default:{let n=r.getLastPoint();if(n===void 0||(e(r,n,t),r.getLastPoint()?.eq(t)===!0))break;r.lineTo(t)}}}function $t(r,t,e,n,s){let i=e.getLastPoint(),o=t.getFirstPoint();i!==void 0&&o!==void 0&&(r.addPath(t,!1),Ri(r,i,s),r.addPathReversed(e,!0),Ri(r,o,n),r.close())}var ln=class{state;simplifyTolerance;tanOffsetTolerance;constructor(t){this.simplifyTolerance=t.simplifyTolerance,this.tanOffsetTolerance=Math.tan(t.offsetTolerance),this.state=new be}process(t,e,n){if(!t.isValid())return;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=0,c=f.createZero(),u=f.createZero(),l=E.createZero();for(this.state.initialize(e,n);o<s.length;){let d=s[o++],m=d.type;switch(m){case 0:{l.isZero()?p!==0&&p!==5&&this.state.finalizePoint(c):this.state.finalizeOpen(),c=i[a++],u=c,l=E.createZero();break}case 1:{let h=new R(u,i[a++]),g=h.getDerivative();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.state.strokeLinear(h,g),u=h.p1,l=g);break}case 2:{let h=new W(u,i[a++],i[a++]),g=h.getTangentStart();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.strokeQuadratic(h),u=h.p2,l=h.getTangentEnd());break}case 3:{let h=new $(u,i[a++],i[a++],i[a++]),g=h.getTangentStart();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.strokeCubic(h),u=h.p3,l=h.getTangentEnd());break}case 4:{let h=new Z(u,i[a++],i[a++],d.w),g=h.getTangentStart();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.strokeConic(h),u=h.p2,l=h.getTangentEnd());break}case 5:{let h=new R(u,c),g=h.getDerivative();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.state.strokeLinear(h,g),l=g),l.isZero()?p!==5&&this.state.finalizePoint(c):(this.state.strokeFirstOrJoin(c,l,this.state.ms),this.state.finalizeClosed()),u=c,l=E.createZero();break}default:U(d)}p=m}l.isZero()?p!==0&&p!==5&&this.state.finalizePoint(c):this.state.finalizeOpen()}setQualityOptions(t){this.simplifyTolerance=t.simplifyTolerance,this.tanOffsetTolerance=Math.tan(t.offsetTolerance)}strokeConic(t){let e=At(t,4,this.simplifyTolerance),n=t;for(;e>0&&e<1;){let[i,o]=n.splitAt(e),a=J(i);this.strokeQuadratic(a),e=e/(1-e),n=o}let s=J(n);this.strokeQuadratic(s)}strokeCubic(t){let e=It(t,54,this.simplifyTolerance),n=t;for(;e<1;){let[o,a]=n.splitAt(e),[p,c]=it(o);this.strokeQuadratic(p),this.strokeQuadratic(c),e=e/(1-e),n=a}let[s,i]=it(n);this.strokeQuadratic(s),this.strokeQuadratic(i)}strokeQuadratic(t){let[e,n]=t.getOffsetCuspParameter(this.state.distance),s=e-n,i=e+n;if(s<1&&i>0)if(zt(t))this.state.strokeQuadraticDegenerate(t.p0,t.getValueAt(e),t.p2);else{let o=0;s>o&&s<pt&&(this.strokeQuadraticSimplify(t.splitBefore(s)),o=s),i>o&&i<pt&&(this.strokeQuadraticSimplify(t.splitBetween(o,i)),o=i),o>0?this.strokeQuadraticSimplify(t.splitAfter(o)):this.strokeQuadraticSimplify(t)}else this.strokeQuadraticSimplify(t)}strokeQuadraticSimplify(t){let e=Wt(t,this.tanOffsetTolerance),n=t;for(;e>0&&e<pt;){let[s,i]=n.splitAt(e);this.state.strokeQuadraticSimple(s),e=Wt(i,this.tanOffsetTolerance),n=i}this.state.strokeQuadraticSimple(n)}},dn=class{state;cosOffsetTolerance;simplifyTolerance;constructor(t){this.simplifyTolerance=t.simplifyTolerance,this.cosOffsetTolerance=Math.cos(t.offsetTolerance),this.state=new be}process(t,e,n){if(!t.isValid())return;let s=t.getCommands(),i=t.getPoints(),o=0,a=0,p=0,c=f.createZero(),u=f.createZero(),l=E.createZero();for(this.state.initialize(e,n);a<s.length;){let d=s[a++],m=d.type;switch(d.type){case 0:{l.isZero()?o!==0&&o!==5&&this.state.finalizePoint(c):this.state.finalizeOpen(),c=i[p++],u=c,l=E.createZero();break}case 1:{let h=new R(u,i[p++]),g=h.getDerivative();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.state.strokeLinear(h,g),u=h.p1,l=g);break}case 2:{let h=new W(u,i[p++],i[p++]),g=h.getTangentStart();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.strokeQuadratic(h),u=h.p2,l=h.getTangentEnd());break}case 3:{let h=new $(u,i[p++],i[p++],i[p++]),g=h.getTangentStart();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.strokeCubic(h),u=h.p3,l=h.getTangentEnd());break}case 4:{let h=new Z(u,i[p++],i[p++],d.w),g=h.getTangentStart();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.strokeConic(h),u=h.p2,l=h.getTangentEnd());break}case 5:{let h=new R(u,c),g=h.getDerivative();g.isZero()||(this.state.strokeFirstOrJoin(u,l,g),this.state.strokeLinear(h,g),l=g),l.isZero()?o!==5&&this.state.finalizePoint(c):(this.state.strokeFirstOrJoin(c,l,this.state.ms),this.state.finalizeClosed()),u=c,l=E.createZero();break}default:U(d)}o=m}l.isZero()?o!==0&&o!==5&&this.state.finalizePoint(c):this.state.finalizeOpen()}setQualityOptions(t){this.simplifyTolerance=t.simplifyTolerance,this.cosOffsetTolerance=Math.cos(t.offsetTolerance)}strokeConic(t){let e=4*this.simplifyTolerance,n=s=>{if(Nt(s,e)){let i=J(s);this.strokeQuadratic(i)}else{let[i,o]=s.splitAt(.5);n(i),n(o)}};n(t)}strokeCubic(t){let e=54*this.simplifyTolerance,n=qt(t),s=(i,o)=>{if(e>o){let[a,p]=it(i);this.strokeQuadratic(a),this.strokeQuadratic(p)}else{let[a,p]=i.splitAt(.5);s(a,.125*o),s(p,.125*o)}};s(t,n)}strokeQuadratic(t){let[e,n]=t.getOffsetCuspParameter(this.state.distance),s=e-n,i=e+n;if(s<1&&i>0)if(zt(t))this.state.strokeQuadraticDegenerate(t.p0,t.getValueAt(e),t.p2);else{let o=0;s>o&&s<pt&&(this.strokeQuadraticSimplify(t.splitBefore(s)),o=s),i>o&&i<pt&&(this.strokeQuadraticSimplify(t.splitBetween(o,i)),o=i),o>0?this.strokeQuadraticSimplify(t.splitAfter(o)):this.strokeQuadraticSimplify(t)}else this.strokeQuadraticSimplify(t)}strokeQuadraticSimplify(t){let e=this.cosOffsetTolerance,n=s=>{if(oe(s,e))this.state.strokeQuadraticSimple(s);else{let[i,o]=s.splitAt(.5);n(i),n(o)}};n(t)}};var ge={start:0,end:0},ns={start:2,end:2};var H={clipPrecision:65536,dashMode:0,flattenMode:0,flattenTolerance:.2,offsetMode:0,offsetTolerance:.39269908169,simplifyMode:0,simplifyTolerance:.05,strokeMode:0},Wi={array:[],offset:0},zi={join:1,miterLimit:4,distance:1},Ft={caps:ge,dashArray:[],dashCaps:ge,dashOffset:0,join:1,miterLimit:4,width:1},xt={booleanOperator:0,windingOperatorA:0,windingOperatorB:0},Je=-.9999999999984769,on=.9999999999984769,ya=5e-7,pt=1-ya;function mn(r){switch(r.flattenMode){case 0:return new en(r);case 1:return new nn(r);default:return r.flattenMode}}function Bi(r){switch(r.simplifyMode){case 0:return new cn(r);case 1:return new un(r);default:return r.simplifyMode}}function Fi(r){switch(r.offsetMode){case 0:return new an(r);case 1:return new pn(r);default:return r.offsetMode}}function ki(r){switch(r.dashMode){case 0:return new _e(r);case 1:return new tn(r);default:return r.dashMode}}function hn(r){switch(r.strokeMode){case 0:return new ln(r);case 1:return new dn(r);default:return r.strokeMode}}function ss(r,t,e,n,s){D(s<=r.length-t,"Parameter 'length' must be smaller or equal to length of 'src' to avoid over-read");let i=t,o=t+s-1,a=n,p=!1;for(r[t]?.type===0&&(e[a++]={type:0},i+=1),r[o]?.type===5&&(p=!0,o-=1);o>=i;){let c=r[o--];c.type===0?(p&&(e[a++]={type:5}),e[a++]={type:0},p=!1):c.type===5?(e[a++]={type:0},p=!0):e[a++]=c}p&&(e[a++]={type:5})}function is(r,t){switch(t){case 0:return r!==0;case 1:return(r&1)!==0;case 2:return r>0;case 3:return r<0;default:return t(r)}}var ye=class r{a;b;constructor(t,e){this.a=t,this.b=e}static createIdentity(){return new r(1,0)}static fromArray(t,e=0){return new r(t[e],t[e+1])}static fromObject(t){return new r(t.a,t.b)}static fromRotationAngle(t){let e=Math.sin(t),n=Math.cos(t);return new r(n,e)}static toObject(t){return{a:t.a,b:t.b}}add(t){return new r(this.a+t.a,this.b+t.b)}clone(){return new r(this.a,this.b)}conjugate(){return new r(this.a,-this.b)}cross(t){return new r(0,this.a*t.b-this.b*t.a)}dot(t){return this.a*t.a+this.b*t.b}eq(t){return this.a===t.a&&this.b===t.b}inverse(){let t=this.lenSq();return new r(this.a/t,-this.b/t)}isIdentity(){return this.a===1&&this.b===0}len(){return Math.sqrt(this.lenSq())}lenSq(){return this.a*this.a+this.b*this.b}mul(t){return new r(this.a*t.a-this.b*t.b,this.a*t.b+this.b*t.a)}mulP(t){return new f(this.a*t.x-this.b*t.y,this.a*t.y+this.b*t.x)}mulV(t){return new E(this.a*t.x-this.b*t.y,this.a*t.y+this.b*t.x)}rotate(t){let e=Math.sin(t),n=Math.cos(t),s=this.a,i=this.b;this.a=n*s-e*i,this.b=n*i+e*s}sub(t){return new r(this.a-t.a,this.b-t.b)}toArray(){return[this.a,this.b]}toString(){return`{a: ${this.a}, b: ${this.b}}`}unit(){let t=this.len();return new r(this.a/t,this.b/t)}};var lt=class r{a;b;c;d;constructor(t,e,n,s){this.a=t,this.b=e,this.c=n,this.d=s}static createIdentity(){return new r(1,0,0,0)}static fromArray(t,e=0){return new r(t[e],t[e+1],t[e+2],t[e+3])}static fromObject(t){return new r(t.a,t.b,t.c,t.d)}static fromRotationAngleX(t){let e=Math.sin(.5*t),n=Math.cos(.5*t);return new r(n,e,0,0)}static fromRotationAngleY(t){let e=Math.sin(.5*t),n=Math.cos(.5*t);return new r(n,0,e,0)}static fromRotationAngleZ(t){let e=Math.sin(.5*t),n=Math.cos(.5*t);return new r(n,0,0,e)}static fromRotationAxis(t,e){let n=Math.sin(.5*e),s=Math.cos(.5*e);return new r(s*t.len(),n*t.x,n*t.y,n*t.z)}static fromRotationBetween(t,e){let n=t.unit(),s=e.unit(),i=n.add(s).unitOrZero(),o=n.dot(i),a=i.isZero()?n.normalAroundAny():n.normalAround(i);return new r(o,a.x,a.y,a.z)}static fromRotationEuler(t,e,n,s){let i=Math.sin(.5*t),o=Math.cos(.5*t),a=Math.sin(.5*e),p=Math.cos(.5*e),c=Math.sin(.5*n),u=Math.cos(.5*n),l=o*p*u,d=i*a*c,m=i*p*u,h=o*a*c,g=o*a*u,y=i*p*c,v=o*p*c,P=i*a*u;switch(s){case 0:return new r(l-d,m+h,g-y,v+P);case 1:return new r(l+d,m-h,g-y,v+P);case 2:return new r(l+d,m+h,g-y,v-P);case 3:return new r(l-d,m+h,g+y,v-P);case 4:return new r(l-d,m-h,g+y,v+P);case 5:return new r(l+d,m-h,g+y,v-P);default:U(s)}}static fromRotationMatrix(t,e,n,s,i,o,a,p,c){if(t>=0)if(i+c>=0){let u=1+t+i+c,l=o-p,d=a-n,m=e-s,h=.5/Math.sqrt(u);return new r(h*u,h*l,h*d,h*m)}else{let u=o-p,l=1+t-i-c,d=s+e,m=a+n,h=.5/Math.sqrt(l);return new r(h*u,h*l,h*d,h*m)}else if(i-c>=0){let u=a-n,l=s+e,d=1-t+i-c,m=p+o,h=.5/Math.sqrt(d);return new r(h*u,h*l,h*d,h*m)}else{let u=e-s,l=a+n,d=p+o,m=1-t-i+c,h=.5/Math.sqrt(m);return new r(h*u,h*l,h*d,h*m)}}static fromXYZW(t,e,n,s){return new r(s,t,e,n)}static toObject(t){return{a:t.a,b:t.b,c:t.c,d:t.d}}add(t){return new r(this.a+t.a,this.b+t.b,this.c+t.c,this.d+t.d)}angleTo(t){let e=this.a*t.a+this.b*t.b+this.c*t.c+this.d*t.d,n=this.lenSq()*t.lenSq();if(e*e>=n)return 0;let s=e/Math.sqrt(n);return 2*Math.acos(s)}axis(){return new X(this.b,this.c,this.d)}clone(){return new r(this.a,this.b,this.c,this.d)}conjugate(){return new r(this.a,-this.b,-this.c,-this.d)}cross(t){let e=this.c*t.d-this.d*t.c,n=this.d*t.b-this.b*t.d,s=this.b*t.c-this.c*t.b;return new r(0,e,n,s)}dot(t){return this.b*t.b+this.c*t.c+this.d*t.d}eq(t){return this.a===t.a&&this.b===t.b&&this.c===t.c&&this.d===t.d}getEulerAngles(t){let e=this.a*this.a,n=this.b*this.b,s=this.c*this.c,i=this.d*this.d,o=2*this.a*this.b,a=2*this.a*this.c,p=2*this.a*this.d,c=2*this.b*this.c,u=2*this.b*this.d,l=2*this.c*this.d;switch(t){case 0:return{x:Math.atan2(o-l,e-n-s+i),y:Math.asin(u+a),z:Math.atan2(p-c,e+n-s-i)};case 1:return{x:Math.atan2(l+o,e-n+s-i),y:Math.atan2(u+a,e+n-s-i),z:Math.asin(p-c)};case 2:return{x:Math.asin(o-l),y:Math.atan2(u+a,e-n-s+i),z:Math.atan2(c+p,e-n+s-i)};case 3:return{x:Math.atan2(o-l,e-n+s-i),y:Math.atan2(a-u,e+n-s-i),z:Math.asin(c+p)};case 4:return{x:Math.asin(l+o),y:Math.atan2(a-u,e-n-s+i),z:Math.atan2(p-c,e-n+s-i)};case 5:return{x:Math.atan2(l+o,e-n-s+i),y:Math.asin(a-u),z:Math.atan2(c+p,e+n-s-i)};default:U(t)}}inverse(){let t=this.lenSq();return new r(this.a/t,-this.b/t,-this.c/t,-this.d/t)}isIdentity(){return this.a===1&&this.b===0&&this.c===0&&this.d===0}len(){return Math.sqrt(this.lenSq())}lenSq(){return this.a*this.a+this.b*this.b+this.c*this.c+this.d*this.d}lerp(t,e){let n=G(this.a,t.a,e),s=G(this.b,t.b,e),i=G(this.c,t.c,e),o=G(this.d,t.d,e);return new r(n,s,i,o)}mul(t){return new r(this.a*t.a-this.b*t.b-this.c*t.c-this.d*t.d,this.a*t.b+this.b*t.a+this.c*t.d-this.d*t.c,this.a*t.c-this.b*t.d+this.c*t.a+this.d*t.b,this.a*t.d+this.b*t.c-this.c*t.b+this.d*t.a)}mulP(t){let e=this.b*t.x+this.c*t.y+this.d*t.z,n=this.a*t.x+this.c*t.z-this.d*t.y,s=this.a*t.y-this.b*t.z+this.d*t.x,i=this.a*t.z+this.b*t.y-this.c*t.x;return new I(e*this.b+n*this.a-s*this.d+i*this.c,e*this.c+n*this.d+s*this.a-i*this.b,e*this.d-n*this.c+s*this.b+i*this.a)}mulV(t){let e=this.b*t.x+this.c*t.y+this.d*t.z,n=this.a*t.x+this.c*t.z-this.d*t.y,s=this.a*t.y-this.b*t.z+this.d*t.x,i=this.a*t.z+this.b*t.y-this.c*t.x;return new X(e*this.b+n*this.a-s*this.d+i*this.c,e*this.c+n*this.d+s*this.a-i*this.b,e*this.d-n*this.c+s*this.b+i*this.a)}pow(t){let e=this.len(),n=Math.pow(e,t),s=t*Math.acos(this.a/e),i=n*Math.sin(s),o=n*Math.cos(s),a=this.axis().unit();return new r(o,i*a.x,i*a.y,i*a.z)}rotateX(t){let e=Math.sin(.5*t),n=Math.cos(.5*t),s=this.a,i=this.b,o=this.c,a=this.d;this.a=n*s-e*i,this.b=n*i+e*s,this.c=n*o-e*a,this.d=n*a+e*o}rotateXPre(t){let e=Math.sin(.5*t),n=Math.cos(.5*t),s=this.a,i=this.b,o=this.c,a=this.d;this.a=s*n-i*e,this.b=i*n+s*e,this.c=o*n+a*e,this.d=a*n-o*e}rotateY(t){let e=Math.sin(.5*t),n=Math.cos(.5*t),s=this.a,i=this.b,o=this.c,a=this.d;this.a=n*s-e*o,this.b=n*i+e*a,this.c=n*o+e*s,this.d=n*a-e*i}rotateYPre(t){let e=Math.sin(.5*t),n=Math.cos(.5*t),s=this.a,i=this.b,o=this.c,a=this.d;this.a=s*n-o*e,this.b=i*n-a*e,this.c=o*n+s*e,this.d=a*n+i*e}rotateZ(t){let e=Math.sin(.5*t),n=Math.cos(.5*t),s=this.a,i=this.b,o=this.c,a=this.d;this.a=n*s-e*a,this.b=n*i-e*o,this.c=n*o+e*i,this.d=n*a+e*s}rotateZPre(t){let e=Math.sin(.5*t),n=Math.cos(.5*t),s=this.a,i=this.b,o=this.c,a=this.d;this.a=s*n-a*e,this.b=i*n+o*e,this.c=o*n-i*e,this.d=a*n+s*e}slerp(t,e){let n=this.a*t.a+this.b*t.b+this.c*t.c+this.d*t.d,s=this.lenSq()*t.lenSq();if(n*n>=s)return this.lerp(t,e);let i=n/Math.sqrt(s),o=Math.acos(i),a=Math.sin(o-o*e),p=Math.sin(o*e),c=Math.sin(o),u=a/c,l=p/c,d=u*this.a+l*t.a,m=u*this.b+l*t.b,h=u*this.c+l*t.c,g=u*this.d+l*t.d;return new r(d,m,h,g)}sub(t){return new r(this.a-t.a,this.b-t.b,this.c-t.c,this.d-t.d)}toArray(){return[this.a,this.b,this.c,this.d]}toString(){return`{a: ${this.a}, b: ${this.b}, c: ${this.c}, d: ${this.d}}`}unit(){let t=this.len();return new r(this.a/t,this.b/t,this.c/t,this.d/t)}};var Jt=class r{elements;constructor(t){this.elements=t}get type(){return 0}static createIdentity(){return new r([1,0,0,1,0,0])}static fromArray(t,e=0){let n=t,s=e;return new r([n[s+0],n[s+1],n[s+2],n[s+3],n[s+4],n[s+5]])}static fromRotation(t,e){let n=t,s=e,i=-e,o=t;return new r([n,s,i,o,0,0])}static fromScale(t,e){return new r([t,0,0,e,0,0])}static fromTranslation(t,e){return new r([1,0,0,1,t,e])}clone(){return new r([...this.elements])}copyFromMat3(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=n[3],e[3]=n[4],e[4]=n[6],e[5]=n[7]}copyFromMat3A(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5]}determinant(){let t=this.elements;return t[0]*t[3]-t[1]*t[2]}eq(t){let e=this.elements,n=t.elements;return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]}extractSRT(){let t=this.elements,e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),n=Math.sqrt(t[2]*t[2]+t[3]*t[3]);this.determinant()<0&&(e=-e);let s=1/e,i=new E(e,n),o=new ye(s*t[0],s*t[1]),a=new f(t[4],t[5]);return{s:i,r:o,t:a}}inverse(){let t=this.determinant();if(t===0)return r.createIdentity();let e=1/t,n=this.elements,s=e*n[3],i=e*-n[1],o=e*-n[2],a=e*n[0],p=-(n[4]*s+n[5]*o),c=-(n[4]*i+n[5]*a);return new r([s,i,o,a,p,c])}mul(t){let e=this.elements,n=t.elements,s=e[0]*n[0]+e[2]*n[1],i=e[1]*n[0]+e[3]*n[1],o=e[0]*n[2]+e[2]*n[3],a=e[1]*n[2]+e[3]*n[3],p=e[0]*n[4]+e[2]*n[5]+e[4],c=e[1]*n[4]+e[3]*n[5]+e[5];return new r([s,i,o,a,p,c])}mulP(t){let e=this.elements,n=e[0]*t.x+e[2]*t.y+e[4],s=e[1]*t.x+e[3]*t.y+e[5];return new f(n,s)}mulSet(t,e){let n=t.elements,s=e.elements,i=n[0]*s[0]+n[2]*s[1],o=n[1]*s[0]+n[3]*s[1],a=n[0]*s[2]+n[2]*s[3],p=n[1]*s[2]+n[3]*s[3],c=n[0]*s[4]+n[2]*s[5]+n[4],u=n[1]*s[4]+n[3]*s[5]+n[5];this.set(i,o,a,p,c,u)}mulV(t){let e=this.elements,n=e[0]*t.x+e[2]*t.y+e[4],s=e[1]*t.x+e[3]*t.y+e[5];return new E(n,s)}rotate(t,e){let n=t,s=e,i=-e,o=t,a=this.elements,p=n*a[0]+i*a[1],c=s*a[0]+o*a[1];a[0]=p,a[1]=c;let u=n*a[2]+i*a[3],l=s*a[2]+o*a[3];a[2]=u,a[3]=l;let d=n*a[4]+i*a[5],m=s*a[4]+o*a[5];a[4]=d,a[5]=m}rotatePre(t,e){let n=t,s=e,i=-e,o=t,a=this.elements,p=a[0]*n+a[2]*s,c=a[0]*i+a[2]*o;a[0]=p,a[2]=c;let u=a[1]*n+a[3]*s,l=a[1]*i+a[3]*o;a[1]=u,a[3]=l}rotateSet(t,e){let n=t,s=e,i=-e,o=t;this.set(n,s,i,o,0,0)}scale(t,e){let n=this.elements;n[0]*=t,n[1]*=e,n[2]*=t,n[3]*=e,n[4]*=t,n[5]*=e}scalePre(t,e){let n=this.elements;n[0]*=t,n[1]*=t,n[2]*=e,n[3]*=e}scaleSet(t,e){this.set(t,0,0,e,0,0)}set(t,e,n,s,i,o){let a=this.elements;a[0]=t,a[1]=e,a[2]=n,a[3]=s,a[4]=i,a[5]=o}toArray(){return[...this.elements]}toString(){let t=this.elements;return`{e0: ${t[0]}, e2: ${t[2]}, e4: ${t[3]},
 e1: ${t[1]}, e3: ${t[3]}, e5: ${t[5]}}`}translate(t,e){let n=this.elements;n[4]+=t,n[5]+=e}translatePre(t,e){let n=this.elements;n[4]+=n[0]*t+n[2]*e,n[5]+=n[1]*t+n[3]*e}translateSet(t,e){this.set(1,0,0,1,t,e)}transpose(){let t=this.elements;return new rs([t[0],t[2],t[4],t[1],t[3],t[5],0,0,1])}},rs=class r{elements;constructor(t){this.elements=t}get type(){return 1}static createIdentity(){return new r([1,0,0,0,1,0,0,0,1])}static createZero(){return new r([0,0,0,0,0,0,0,0,0])}static fromArray(t,e=0){let n=t,s=e;return new r([n[s+0],n[s+1],n[s+2],n[s+3],n[s+4],n[s+5],n[s+6],n[s+7],n[s+8]])}static fromMat4(t){let e=t.elements;return new r([e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]])}static fromMat4A(t){let e=t.elements;return new r([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]])}static fromRotation(t,e){let n=t,s=e,i=-e,o=t;return new r([n,s,0,i,o,0,0,0,1])}static fromScale(t,e){return new r([t,0,0,0,e,0,0,0,1])}static fromTranslation(t,e){return new r([1,0,0,0,1,0,t,e,1])}add(t){let e=this.elements,n=t.elements,s=e[0]+n[0],i=e[1]+n[1],o=e[2]+n[2],a=e[3]+n[3],p=e[4]+n[4],c=e[5]+n[5],u=e[6]+n[6],l=e[7]+n[7],d=e[8]+n[8];return new r([s,i,o,a,p,c,u,l,d])}addSet(t,e){let n=t.elements,s=e.elements,i=n[0]+s[0],o=n[1]+s[1],a=n[2]+s[2],p=n[3]+s[3],c=n[4]+s[4],u=n[5]+s[5],l=n[6]+s[6],d=n[7]+s[7],m=n[8]+s[8];this.set(i,o,a,p,c,u,l,d,m)}clone(){return new r([...this.elements])}copyFromMat3(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8]}copyFromMat3A(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=0,e[3]=n[2],e[4]=n[3],e[5]=0,e[6]=n[4],e[7]=n[5],e[8]=1}determinant(){let t=this.elements,e=t[8]*(t[0]*t[4]-t[1]*t[3]),n=t[5]*(t[0]*t[7]-t[1]*t[6]),s=t[2]*(t[3]*t[7]-t[4]*t[6]);return e-n+s}eq(t){let e=this.elements,n=t.elements;return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]}extractSRT(){let t=this.elements,e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),n=Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);this.determinant()<0&&(e=-e);let s=1/e,i=new E(e,n),o=new ye(s*t[0],s*t[1]),a=new f(t[6],t[7]);return{s:i,r:o,t:a}}inverse(){let t=this.determinant();if(t===0)return r.createIdentity();let e=1/t,n=this.elements,s=e*(n[4]*n[8]-n[5]*n[7]),i=e*(n[2]*n[7]-n[1]*n[8]),o=e*(n[1]*n[5]-n[2]*n[4]),a=e*(n[5]*n[6]-n[3]*n[8]),p=e*(n[0]*n[8]-n[2]*n[6]),c=e*(n[2]*n[3]-n[0]*n[5]),u=e*(n[3]*n[7]-n[4]*n[6]),l=e*(n[1]*n[6]-n[0]*n[7]),d=e*(n[0]*n[4]-n[1]*n[3]);return new r([s,i,o,a,p,c,u,l,d])}mul(t){let e=this.elements,n=t.elements,s=e[0]*n[0]+e[3]*n[1]+e[6]*n[2],i=e[1]*n[0]+e[4]*n[1]+e[7]*n[2],o=e[2]*n[0]+e[5]*n[1]+e[8]*n[2],a=e[0]*n[3]+e[3]*n[4]+e[6]*n[5],p=e[1]*n[3]+e[4]*n[4]+e[7]*n[5],c=e[2]*n[3]+e[5]*n[4]+e[8]*n[5],u=e[0]*n[6]+e[3]*n[7]+e[6]*n[8],l=e[1]*n[6]+e[4]*n[7]+e[7]*n[8],d=e[2]*n[6]+e[5]*n[7]+e[8]*n[8];return new r([s,i,o,a,p,c,u,l,d])}mulP(t){let e=this.elements,n=e[0]*t.x+e[3]*t.y+e[6],s=e[1]*t.x+e[4]*t.y+e[7],i=e[2]*t.x+e[5]*t.y+e[8];return f.fromXYW(n,s,i)}mulSet(t,e){let n=t.elements,s=e.elements,i=n[0]*s[0]+n[3]*s[1]+n[6]*s[2],o=n[1]*s[0]+n[4]*s[1]+n[7]*s[2],a=n[2]*s[0]+n[5]*s[1]+n[8]*s[2],p=n[0]*s[3]+n[3]*s[4]+n[6]*s[5],c=n[1]*s[3]+n[4]*s[4]+n[7]*s[5],u=n[2]*s[3]+n[5]*s[4]+n[8]*s[5],l=n[0]*s[6]+n[3]*s[7]+n[6]*s[8],d=n[1]*s[6]+n[4]*s[7]+n[7]*s[8],m=n[2]*s[6]+n[5]*s[7]+n[8]*s[8];this.set(i,o,a,p,c,u,l,d,m)}mulV(t){let e=this.elements,n=e[0]*t.x+e[3]*t.y+e[6]*t.z,s=e[1]*t.x+e[4]*t.y+e[7]*t.z,i=e[2]*t.x+e[5]*t.y+e[8]*t.z;return new X(n,s,i)}rotate(t,e){let n=t,s=e,i=-e,o=t,a=this.elements,p=n*a[0]+i*a[1],c=s*a[0]+o*a[1];a[0]=p,a[1]=c;let u=n*a[3]+i*a[4],l=s*a[3]+o*a[4];a[3]=u,a[4]=l;let d=n*a[6]+i*a[7],m=s*a[6]+o*a[7];a[6]=d,a[7]=m}rotatePre(t,e){let n=t,s=e,i=-e,o=t,a=this.elements,p=a[0]*n+a[3]*s,c=a[0]*i+a[3]*o;a[0]=p,a[3]=c;let u=a[1]*n+a[4]*s,l=a[1]*i+a[4]*o;a[1]=u,a[4]=l;let d=a[2]*n+a[5]*s,m=a[2]*i+a[5]*o;a[2]=d,a[5]=m}rotateSet(t,e){let n=t,s=e,i=-e,o=t;this.set(n,s,0,i,o,0,0,0,1)}scale(t,e){let n=this.elements;n[0]*=t,n[1]*=e,n[3]*=t,n[4]*=e,n[6]*=t,n[7]*=e}scalePre(t,e){let n=this.elements;n[0]*=t,n[1]*=t,n[2]*=t,n[3]*=e,n[4]*=e,n[5]*=e}scaleSet(t,e){this.set(t,0,0,0,e,0,0,0,1)}set(t,e,n,s,i,o,a,p,c){let u=this.elements;u[0]=t,u[1]=e,u[2]=n,u[3]=s,u[4]=i,u[5]=o,u[6]=a,u[7]=p,u[8]=c}sub(t){let e=this.elements,n=t.elements,s=e[0]-n[0],i=e[1]-n[1],o=e[2]-n[2],a=e[3]-n[3],p=e[4]-n[4],c=e[5]-n[5],u=e[6]-n[6],l=e[7]-n[7],d=e[8]-n[8];return new r([s,i,o,a,p,c,u,l,d])}subSet(t,e){let n=t.elements,s=e.elements,i=n[0]-s[0],o=n[1]-s[1],a=n[2]-s[2],p=n[3]-s[3],c=n[4]-s[4],u=n[5]-s[5],l=n[6]-s[6],d=n[7]-s[7],m=n[8]-s[8];this.set(i,o,a,p,c,u,l,d,m)}toArray(){return[...this.elements]}toString(){let t=this.elements;return`{e0: ${t[0]}, e3: ${t[3]}, e6: ${t[6]},
 e1: ${t[1]}, e4: ${t[4]}, e7: ${t[7]},
 e2: ${t[2]}, e5: ${t[5]}, e8: ${t[8]}}`}translate(t,e){let n=this.elements;n[0]+=t*n[2],n[1]+=e*n[2],n[3]+=t*n[5],n[4]+=e*n[5],n[6]+=t*n[8],n[7]+=e*n[8]}translatePre(t,e){let n=this.elements;n[6]+=n[0]*t+n[3]*e,n[7]+=n[1]*t+n[4]*e,n[8]+=n[2]*t+n[5]*e}translateSet(t,e){this.set(1,0,0,0,1,0,t,e,1)}transpose(){let t=this.elements;return new r([t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]])}},bn=class r{elements;constructor(t){this.elements=t}get type(){return 0}static createIdentity(){return new r([1,0,0,0,1,0,0,0,1,0,0,0])}static fromArray(t,e=0){let n=t,s=e;return new r([n[s+0],n[s+1],n[s+2],n[s+3],n[s+4],n[s+5],n[s+6],n[s+7],n[s+8],n[s+9],n[s+10],n[s+11]])}static fromMat3(t){let e=t.elements;return new r([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],0,0,0])}static fromMat4(t){let e=t.elements;return new r([e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10],e[12],e[13],e[14]])}static fromOrthographicFrustum(t,e,n,s,i,o){let a=2/(e-t),p=2/(s-n),c=1/(i-o),u=(t+e)/(t-e),l=(n+s)/(n-s),d=i/(i-o);return new r([a,0,0,0,p,0,0,0,c,u,l,d])}static fromOrthographicFrustumGL(t,e,n,s,i,o){let a=2/(e-t),p=2/(s-n),c=2/(i-o),u=(t+e)/(t-e),l=(n+s)/(n-s),d=(i+o)/(i-o);return new r([a,0,0,0,p,0,0,0,c,u,l,d])}static fromRotation(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C;return new r([c,h,P,g,u,z,M,V,l,0,0,0])}static fromScale(t,e,n){return new r([t,0,0,0,e,0,0,0,n,0,0,0])}static fromTranslation(t,e,n){return new r([1,0,0,0,1,0,0,0,1,t,e,n])}static fromView(t,e,n){let s=e.neg().unit(),i=n.cross(s).unit(),o=s.cross(i),a=i.x,p=o.x,c=s.x,u=i.y,l=o.y,d=s.y,m=i.z,h=o.z,g=s.z,y=-t.dot(i),v=-t.dot(o),P=-t.dot(s);return new r([a,p,c,u,l,d,m,h,g,y,v,P])}clone(){return new r([...this.elements])}copyFromMat4(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[4],e[4]=n[5],e[5]=n[6],e[6]=n[8],e[7]=n[9],e[8]=n[10],e[9]=n[12],e[10]=n[13],e[11]=n[14]}copyFromMat4A(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11]}determinant(){let t=this.elements,e=t[8]*(t[0]*t[4]-t[1]*t[3]),n=t[5]*(t[0]*t[7]-t[1]*t[6]),s=t[2]*(t[3]*t[7]-t[4]*t[6]);return e-n+s}eq(t){let e=this.elements,n=t.elements;return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]}extractSRT(){let t=this.elements,e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),n=Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]),s=Math.sqrt(t[6]*t[6]+t[7]*t[7]+t[8]*t[8]);this.determinant()<0&&(e=-e);let i=1/e,o=1/n,a=1/s,p=new X(e,n,s),c=lt.fromRotationMatrix(i*t[0],i*t[1],i*t[2],o*t[3],o*t[4],o*t[5],a*t[6],a*t[7],a*t[8]),u=new I(t[9],t[10],t[11]);return{s:p,r:c,t:u}}inverse(){let t=this.determinant();if(t===0)return r.createIdentity();let e=1/t,n=this.elements,s=e*(n[4]*n[8]-n[5]*n[7]),i=e*(n[2]*n[7]-n[1]*n[8]),o=e*(n[1]*n[5]-n[2]*n[4]),a=e*(n[5]*n[6]-n[3]*n[8]),p=e*(n[0]*n[8]-n[2]*n[6]),c=e*(n[2]*n[3]-n[0]*n[5]),u=e*(n[3]*n[7]-n[4]*n[6]),l=e*(n[1]*n[6]-n[0]*n[7]),d=e*(n[0]*n[4]-n[1]*n[3]),m=-(n[9]*s+n[10]*a+n[11]*u),h=-(n[9]*i+n[10]*p+n[11]*l),g=-(n[9]*o+n[10]*c+n[11]*d);return new r([s,i,o,a,p,c,u,l,d,m,h,g])}mul(t){let e=this.elements,n=t.elements,s=e[0]*n[0]+e[3]*n[1]+e[6]*n[2],i=e[1]*n[0]+e[4]*n[1]+e[7]*n[2],o=e[2]*n[0]+e[5]*n[1]+e[8]*n[2],a=e[0]*n[3]+e[3]*n[4]+e[6]*n[5],p=e[1]*n[3]+e[4]*n[4]+e[7]*n[5],c=e[2]*n[3]+e[5]*n[4]+e[8]*n[5],u=e[0]*n[6]+e[3]*n[7]+e[6]*n[8],l=e[1]*n[6]+e[4]*n[7]+e[7]*n[8],d=e[2]*n[6]+e[5]*n[7]+e[8]*n[8],m=e[0]*n[9]+e[3]*n[10]+e[6]*n[11]+e[9],h=e[1]*n[9]+e[4]*n[10]+e[7]*n[11]+e[10],g=e[2]*n[9]+e[5]*n[10]+e[8]*n[11]+e[11];return new r([s,i,o,a,p,c,u,l,d,m,h,g])}mulP(t){let e=this.elements,n=e[0]*t.x+e[3]*t.y+e[6]*t.z+e[9],s=e[1]*t.x+e[4]*t.y+e[7]*t.z+e[10],i=e[2]*t.x+e[5]*t.y+e[8]*t.z+e[11];return new I(n,s,i)}mulSet(t,e){let n=t.elements,s=e.elements,i=n[0]*s[0]+n[3]*s[1]+n[6]*s[2],o=n[1]*s[0]+n[4]*s[1]+n[7]*s[2],a=n[2]*s[0]+n[5]*s[1]+n[8]*s[2],p=n[0]*s[3]+n[3]*s[4]+n[6]*s[5],c=n[1]*s[3]+n[4]*s[4]+n[7]*s[5],u=n[2]*s[3]+n[5]*s[4]+n[8]*s[5],l=n[0]*s[6]+n[3]*s[7]+n[6]*s[8],d=n[1]*s[6]+n[4]*s[7]+n[7]*s[8],m=n[2]*s[6]+n[5]*s[7]+n[8]*s[8],h=n[0]*s[9]+n[3]*s[10]+n[6]*s[11]+n[9],g=n[1]*s[9]+n[4]*s[10]+n[7]*s[11]+n[10],y=n[2]*s[9]+n[5]*s[10]+n[8]*s[11]+n[11];this.set(i,o,a,p,c,u,l,d,m,h,g,y)}mulV(t){let e=this.elements,n=e[0]*t.x+e[3]*t.y+e[6]*t.z+e[9],s=e[1]*t.x+e[4]*t.y+e[7]*t.z+e[10],i=e[2]*t.x+e[5]*t.y+e[8]*t.z+e[11];return new X(n,s,i)}rotate(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C,b=this.elements,ft=c*b[0]+g*b[1]+M*b[2],ut=h*b[0]+u*b[1]+V*b[2],bt=P*b[0]+z*b[1]+l*b[2];b[0]=ft,b[1]=ut,b[2]=bt;let gt=c*b[3]+g*b[4]+M*b[5],yt=h*b[3]+u*b[4]+V*b[5],Dt=P*b[3]+z*b[4]+l*b[5];b[3]=gt,b[4]=yt,b[5]=Dt;let wt=c*b[6]+g*b[7]+M*b[8],Tt=h*b[6]+u*b[7]+V*b[8],Ot=P*b[6]+z*b[7]+l*b[8];b[6]=wt,b[7]=Tt,b[8]=Ot;let Xt=c*b[9]+g*b[10]+M*b[11],Zt=h*b[9]+u*b[10]+V*b[11],Ht=P*b[9]+z*b[10]+l*b[11];b[9]=Xt,b[10]=Zt,b[11]=Ht}rotatePre(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C,b=this.elements,ft=b[0]*c+b[3]*h+b[6]*P,ut=b[0]*g+b[3]*u+b[6]*z,bt=b[0]*M+b[3]*V+b[6]*l;b[0]=ft,b[3]=ut,b[6]=bt;let gt=b[1]*c+b[4]*h+b[7]*P,yt=b[1]*g+b[4]*u+b[7]*z,Dt=b[1]*M+b[4]*V+b[7]*l;b[1]=gt,b[4]=yt,b[7]=Dt;let wt=b[2]*c+b[5]*h+b[8]*P,Tt=b[2]*g+b[5]*u+b[8]*z,Ot=b[2]*M+b[5]*V+b[8]*l;b[2]=wt,b[5]=Tt,b[8]=Ot}rotateSet(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C;this.set(c,h,P,g,u,z,M,V,l,0,0,0)}scale(t,e,n){let s=this.elements;s[0]*=t,s[1]*=e,s[2]*=n,s[3]*=t,s[4]*=e,s[5]*=n,s[6]*=t,s[7]*=e,s[8]*=n,s[9]*=t,s[10]*=e,s[11]*=n}scalePre(t,e,n){let s=this.elements;s[0]*=t,s[1]*=t,s[2]*=t,s[3]*=e,s[4]*=e,s[5]*=e,s[6]*=n,s[7]*=n,s[8]*=n}scaleSet(t,e,n){this.set(t,0,0,0,e,0,0,0,n,0,0,0)}set(t,e,n,s,i,o,a,p,c,u,l,d){let m=this.elements;m[0]=t,m[1]=e,m[2]=n,m[3]=s,m[4]=i,m[5]=o,m[6]=a,m[7]=p,m[8]=c,m[9]=u,m[10]=l,m[11]=d}toArray(){return[...this.elements]}toString(){let t=this.elements;return`{e0: ${t[0]}, e3: ${t[3]}, e6: ${t[6]}, e9: ${t[9]},
 e1: ${t[1]}, e4: ${t[4]}, e7: ${t[7]}, e10: ${t[10]},
 e2: ${t[2]}, e5: ${t[5]}, e8: ${t[8]}, e11: ${t[11]}}`}translate(t,e,n){let s=this.elements;s[9]+=t,s[10]+=e,s[11]+=n}translatePre(t,e,n){let s=this.elements;s[9]+=s[0]*t+s[3]*e+s[6]*n,s[10]+=s[1]*t+s[4]*e+s[7]*n,s[11]+=s[2]*t+s[5]*e+s[8]*n}translateSet(t,e,n){this.set(1,0,0,0,1,0,0,0,1,t,e,n)}transpose(){let t=this.elements;return new Pt([t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1])}},Pt=class r{elements;constructor(t){this.elements=t}get type(){return 1}static createIdentity(){return new r([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static createZero(){return new r([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])}static fromArray(t,e=0){let n=t,s=e;return new r([n[s+0],n[s+1],n[s+2],n[s+3],n[s+4],n[s+5],n[s+6],n[s+7],n[s+8],n[s+9],n[s+10],n[s+11],n[s+12],n[s+13],n[s+14],n[s+15]])}static fromMat3(t){let e=t.elements;return new r([e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,0,0,0,1])}static fromMat4A(t){let e=t.elements;return new r([e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,e[9],e[10],e[11],1])}static fromOrthographicFrustum(t,e,n,s,i,o){let a=2/(e-t),p=2/(s-n),c=1/(i-o),u=(t+e)/(t-e),l=(n+s)/(n-s),d=i/(i-o);return new r([a,0,0,0,0,p,0,0,0,0,c,0,u,l,d,1])}static fromOrthographicFrustumGL(t,e,n,s,i,o){let a=2/(e-t),p=2/(s-n),c=2/(i-o),u=(t+e)/(t-e),l=(n+s)/(n-s),d=(i+o)/(i-o);return new r([a,0,0,0,0,p,0,0,0,0,c,0,u,l,d,1])}static fromPerspective(t,e,n,s){let i=1/Math.tan(.5*t),o=i/e,a=i,p=s/(n-s),c=n*s/(n-s);return new r([o,0,0,0,0,a,0,0,0,0,p,-1,0,0,c,0])}static fromPerspectiveFrustum(t,e,n,s,i,o){let a=2*i/(e-t),p=2*i/(s-n),c=(t+e)/(e-t),u=(n+s)/(s-n),l=o/(i-o),d=i*o/(i-o);return new r([a,0,0,0,0,p,0,0,c,u,l,-1,0,0,d,0])}static fromPerspectiveFrustumGL(t,e,n,s,i,o){let a=2*i/(e-t),p=2*i/(s-n),c=(t+e)/(e-t),u=(n+s)/(s-n),l=(i+o)/(i-o),d=2*i*o/(i-o);return new r([a,0,0,0,0,p,0,0,c,u,l,-1,0,0,d,0])}static fromPerspectiveGL(t,e,n,s){let i=1/Math.tan(.5*t),o=i/e,a=i,p=(n+s)/(n-s),c=2*s*n/(n-s);return new r([o,0,0,0,0,a,0,0,0,0,p,-1,0,0,c,0])}static fromRotation(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C;return new r([c,h,P,0,g,u,z,0,M,V,l,0,0,0,0,1])}static fromScale(t,e,n){return new r([t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1])}static fromTranslation(t,e,n){return new r([1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1])}static fromView(t,e,n){let s=e.neg().unit(),i=n.cross(s).unit(),o=s.cross(i),a=i.x,p=o.x,c=s.x,u=i.y,l=o.y,d=s.y,m=i.z,h=o.z,g=s.z,y=-t.dot(i),v=-t.dot(o),P=-t.dot(s);return new r([a,p,c,0,u,l,d,0,m,h,g,0,y,v,P,1])}add(t){let e=this.elements,n=t.elements,s=e[0]+n[0],i=e[1]+n[1],o=e[2]+n[2],a=e[3]+n[3],p=e[4]+n[4],c=e[5]+n[5],u=e[6]+n[6],l=e[7]+n[7],d=e[8]+n[8],m=e[9]+n[9],h=e[10]+n[10],g=e[11]+n[11],y=e[12]+n[12],v=e[13]+n[13],P=e[14]+n[14],M=e[15]+n[15];return new r([s,i,o,a,p,c,u,l,d,m,h,g,y,v,P,M])}addSet(t,e){let n=t.elements,s=e.elements,i=n[0]+s[0],o=n[1]+s[1],a=n[2]+s[2],p=n[3]+s[3],c=n[4]+s[4],u=n[5]+s[5],l=n[6]+s[6],d=n[7]+s[7],m=n[8]+s[8],h=n[9]+s[9],g=n[10]+s[10],y=n[11]+s[11],v=n[12]+s[12],P=n[13]+s[13],M=n[14]+s[14],S=n[15]+s[15];this.set(i,o,a,p,c,u,l,d,m,h,g,y,v,P,M,S)}clone(){return new r([...this.elements])}copyFromMat4(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15]}copyFromMat4A(t){let e=this.elements,n=t.elements;e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=0,e[4]=n[3],e[5]=n[4],e[6]=n[5],e[7]=0,e[8]=n[6],e[9]=n[7],e[10]=n[8],e[11]=0,e[12]=n[9],e[13]=n[10],e[14]=n[11],e[15]=1}determinant(){let t=this.elements,e=t[10]*(t[0]*t[5]-t[1]*t[4]),n=t[9]*(t[0]*t[6]-t[2]*t[4]),s=t[8]*(t[1]*t[6]-t[2]*t[5]),i=t[15]*(e-n+s),o=t[11]*(t[0]*t[5]-t[1]*t[4]),a=t[9]*(t[0]*t[7]-t[3]*t[4]),p=t[8]*(t[1]*t[7]-t[3]*t[5]),c=t[14]*(o-a+p),u=t[11]*(t[0]*t[6]-t[2]*t[4]),l=t[10]*(t[0]*t[7]-t[3]*t[4]),d=t[8]*(t[2]*t[7]-t[3]*t[6]),m=t[13]*(u-l+d),h=t[11]*(t[1]*t[6]-t[2]*t[5]),g=t[10]*(t[1]*t[7]-t[3]*t[5]),y=t[9]*(t[2]*t[7]-t[3]*t[6]),v=t[12]*(h-g+y);return i-c+m-v}eq(t){let e=this.elements,n=t.elements;return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]}extractSRT(){let t=this.elements,e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]),n=Math.sqrt(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]+t[7]*t[7]),s=Math.sqrt(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]+t[11]*t[11]);this.determinant()<0&&(e=-e);let i=1/e,o=1/n,a=1/s,p=new X(e,n,s),c=lt.fromRotationMatrix(i*t[0],i*t[1],i*t[2],o*t[4],o*t[5],o*t[6],a*t[8],a*t[9],a*t[10]),u=new I(t[12],t[13],t[14]);return{s:p,r:c,t:u}}inverse(){let t=this.determinant();if(t===0)return r.createIdentity();let e=1/t,n=this.elements,s=n[15]*(n[5]*n[10]-n[6]*n[9]),i=n[14]*(n[5]*n[11]-n[7]*n[9]),o=n[13]*(n[6]*n[11]-n[7]*n[10]),a=e*(s-i+o),p=n[15]*(n[2]*n[9]-n[1]*n[10]),c=n[14]*(n[3]*n[9]-n[1]*n[11]),u=n[13]*(n[3]*n[10]-n[2]*n[11]),l=e*(p-c+u),d=n[15]*(n[1]*n[6]-n[2]*n[5]),m=n[14]*(n[1]*n[7]-n[3]*n[5]),h=n[13]*(n[2]*n[7]-n[3]*n[6]),g=e*(d-m+h),y=n[11]*(n[2]*n[5]-n[1]*n[6]),v=n[10]*(n[3]*n[5]-n[1]*n[7]),P=n[9]*(n[3]*n[6]-n[2]*n[7]),M=e*(y-v+P),S=n[15]*(n[6]*n[8]-n[4]*n[10]),C=n[14]*(n[7]*n[8]-n[4]*n[11]),z=n[12]*(n[7]*n[10]-n[6]*n[11]),V=e*(S-C+z),b=n[15]*(n[0]*n[10]-n[2]*n[8]),ft=n[14]*(n[0]*n[11]-n[3]*n[8]),ut=n[12]*(n[2]*n[11]-n[3]*n[10]),bt=e*(b-ft+ut),gt=n[15]*(n[2]*n[4]-n[0]*n[6]),yt=n[14]*(n[3]*n[4]-n[0]*n[7]),Dt=n[12]*(n[3]*n[6]-n[2]*n[7]),wt=e*(gt-yt+Dt),Tt=n[11]*(n[0]*n[6]-n[2]*n[4]),Ot=n[10]*(n[0]*n[7]-n[3]*n[4]),Xt=n[8]*(n[2]*n[7]-n[3]*n[6]),Zt=e*(Tt-Ot+Xt),Ht=n[15]*(n[4]*n[9]-n[5]*n[8]),Wo=n[13]*(n[4]*n[11]-n[7]*n[8]),zo=n[12]*(n[5]*n[11]-n[7]*n[9]),Bo=e*(Ht-Wo+zo),Fo=n[15]*(n[1]*n[8]-n[0]*n[9]),ko=n[13]*(n[3]*n[8]-n[0]*n[11]),Lo=n[12]*(n[3]*n[9]-n[1]*n[11]),Vo=e*(Fo-ko+Lo),qo=n[15]*(n[0]*n[5]-n[1]*n[4]),No=n[13]*(n[0]*n[7]-n[3]*n[4]),Uo=n[12]*(n[1]*n[7]-n[3]*n[5]),jo=e*(qo-No+Uo),Qo=n[11]*(n[1]*n[4]-n[0]*n[5]),Go=n[9]*(n[3]*n[4]-n[0]*n[7]),Yo=n[8]*(n[3]*n[5]-n[1]*n[7]),Xo=e*(Qo-Go+Yo),Zo=n[14]*(n[5]*n[8]-n[4]*n[9]),Ho=n[13]*(n[6]*n[8]-n[4]*n[10]),Ko=n[12]*(n[6]*n[9]-n[5]*n[10]),$o=e*(Zo-Ho+Ko),Jo=n[14]*(n[0]*n[9]-n[1]*n[8]),_o=n[13]*(n[0]*n[10]-n[2]*n[8]),ta=n[12]*(n[1]*n[10]-n[2]*n[9]),ea=e*(Jo-_o+ta),na=n[14]*(n[1]*n[4]-n[0]*n[5]),sa=n[13]*(n[2]*n[4]-n[0]*n[6]),ia=n[12]*(n[2]*n[5]-n[1]*n[6]),ra=e*(na-sa+ia),oa=n[10]*(n[0]*n[5]-n[1]*n[4]),aa=n[9]*(n[0]*n[6]-n[2]*n[4]),pa=n[8]*(n[1]*n[6]-n[2]*n[5]),ca=e*(oa-aa+pa);return new r([a,l,g,M,V,bt,wt,Zt,Bo,Vo,jo,Xo,$o,ea,ra,ca])}mul(t){let e=this.elements,n=t.elements,s=e[0]*n[0]+e[4]*n[1]+e[8]*n[2]+e[12]*n[3],i=e[1]*n[0]+e[5]*n[1]+e[9]*n[2]+e[13]*n[3],o=e[2]*n[0]+e[6]*n[1]+e[10]*n[2]+e[14]*n[3],a=e[3]*n[0]+e[7]*n[1]+e[11]*n[2]+e[15]*n[3],p=e[0]*n[4]+e[4]*n[5]+e[8]*n[6]+e[12]*n[7],c=e[1]*n[4]+e[5]*n[5]+e[9]*n[6]+e[13]*n[7],u=e[2]*n[4]+e[6]*n[5]+e[10]*n[6]+e[14]*n[7],l=e[3]*n[4]+e[7]*n[5]+e[11]*n[6]+e[15]*n[7],d=e[0]*n[8]+e[4]*n[9]+e[8]*n[10]+e[12]*n[11],m=e[1]*n[8]+e[5]*n[9]+e[9]*n[10]+e[13]*n[11],h=e[2]*n[8]+e[6]*n[9]+e[10]*n[10]+e[14]*n[11],g=e[3]*n[8]+e[7]*n[9]+e[11]*n[10]+e[15]*n[11],y=e[0]*n[12]+e[4]*n[13]+e[8]*n[14]+e[12]*n[15],v=e[1]*n[12]+e[5]*n[13]+e[9]*n[14]+e[13]*n[15],P=e[2]*n[12]+e[6]*n[13]+e[10]*n[14]+e[14]*n[15],M=e[3]*n[12]+e[7]*n[13]+e[11]*n[14]+e[15]*n[15];return new r([s,i,o,a,p,c,u,l,d,m,h,g,y,v,P,M])}mulP(t){let e=this.elements,n=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12],s=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13],i=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14],o=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15];return I.fromXYZW(n,s,i,o)}mulSet(t,e){let n=t.elements,s=e.elements,i=n[0]*s[0]+n[4]*s[1]+n[8]*s[2]+n[12]*s[3],o=n[1]*s[0]+n[5]*s[1]+n[9]*s[2]+n[13]*s[3],a=n[2]*s[0]+n[6]*s[1]+n[10]*s[2]+n[14]*s[3],p=n[3]*s[0]+n[7]*s[1]+n[11]*s[2]+n[15]*s[3],c=n[0]*s[4]+n[4]*s[5]+n[8]*s[6]+n[12]*s[7],u=n[1]*s[4]+n[5]*s[5]+n[9]*s[6]+n[13]*s[7],l=n[2]*s[4]+n[6]*s[5]+n[10]*s[6]+n[14]*s[7],d=n[3]*s[4]+n[7]*s[5]+n[11]*s[6]+n[15]*s[7],m=n[0]*s[8]+n[4]*s[9]+n[8]*s[10]+n[12]*s[11],h=n[1]*s[8]+n[5]*s[9]+n[9]*s[10]+n[13]*s[11],g=n[2]*s[8]+n[6]*s[9]+n[10]*s[10]+n[14]*s[11],y=n[3]*s[8]+n[7]*s[9]+n[11]*s[10]+n[15]*s[11],v=n[0]*s[12]+n[4]*s[13]+n[8]*s[14]+n[12]*s[15],P=n[1]*s[12]+n[5]*s[13]+n[9]*s[14]+n[13]*s[15],M=n[2]*s[12]+n[6]*s[13]+n[10]*s[14]+n[14]*s[15],S=n[3]*s[12]+n[7]*s[13]+n[11]*s[14]+n[15]*s[15];this.set(i,o,a,p,c,u,l,d,m,h,g,y,v,P,M,S)}mulV(t){let e=this.elements,n=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12]*t.w,s=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13]*t.w,i=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14]*t.w,o=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15]*t.w;return new qe(n,s,i,o)}rotate(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C,b=this.elements,ft=c*b[0]+g*b[1]+M*b[2],ut=h*b[0]+u*b[1]+V*b[2],bt=P*b[0]+z*b[1]+l*b[2];b[0]=ft,b[1]=ut,b[2]=bt;let gt=c*b[4]+g*b[5]+M*b[6],yt=h*b[4]+u*b[5]+V*b[6],Dt=P*b[4]+z*b[5]+l*b[6];b[4]=gt,b[5]=yt,b[6]=Dt;let wt=c*b[8]+g*b[9]+M*b[10],Tt=h*b[8]+u*b[9]+V*b[10],Ot=P*b[8]+z*b[9]+l*b[10];b[8]=wt,b[9]=Tt,b[10]=Ot;let Xt=c*b[12]+g*b[13]+M*b[14],Zt=h*b[12]+u*b[13]+V*b[14],Ht=P*b[12]+z*b[13]+l*b[14];b[12]=Xt,b[13]=Zt,b[14]=Ht}rotatePre(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C,b=this.elements,ft=b[0]*c+b[4]*h+b[8]*P,ut=b[0]*g+b[4]*u+b[8]*z,bt=b[0]*M+b[4]*V+b[8]*l;b[0]=ft,b[4]=ut,b[8]=bt;let gt=b[1]*c+b[5]*h+b[9]*P,yt=b[1]*g+b[5]*u+b[9]*z,Dt=b[1]*M+b[5]*V+b[9]*l;b[1]=gt,b[5]=yt,b[9]=Dt;let wt=b[2]*c+b[6]*h+b[10]*P,Tt=b[2]*h+b[6]*u+b[10]*z,Ot=b[2]*P+b[6]*V+b[10]*l;b[2]=wt,b[6]=Tt,b[10]=Ot;let Xt=b[3]*c+b[7]*h+b[11]*P,Zt=b[3]*h+b[7]*u+b[11]*z,Ht=b[3]*P+b[7]*V+b[11]*l;b[3]=Xt,b[7]=Zt,b[11]=Ht}rotateSet(t,e,n,s){let i=t*t,o=e*e,a=n*n,p=s*s,c=i+o-a-p,u=i-o+a-p,l=i-o-a+p,d=e*n,m=t*s,h=d+d+m+m,g=d+d-m-m,y=e*s,v=t*n,P=y+y-v-v,M=y+y+v+v,S=n*s,C=t*e,z=S+S+C+C,V=S+S-C-C;this.set(c,h,P,0,g,u,z,0,M,V,l,0,0,0,0,1)}scale(t,e,n){let s=this.elements;s[0]*=t,s[1]*=e,s[2]*=n,s[4]*=t,s[5]*=e,s[6]*=n,s[8]*=t,s[9]*=e,s[10]*=n,s[12]*=t,s[13]*=e,s[14]*=n}scalePre(t,e,n){let s=this.elements;s[0]*=t,s[1]*=t,s[2]*=t,s[3]*=t,s[4]*=e,s[5]*=e,s[6]*=e,s[7]*=e,s[8]*=n,s[9]*=n,s[10]*=n,s[11]*=n}scaleSet(t,e,n){this.set(t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1)}set(t,e,n,s,i,o,a,p,c,u,l,d,m,h,g,y){let v=this.elements;v[0]=t,v[1]=e,v[2]=n,v[3]=s,v[4]=i,v[5]=o,v[6]=a,v[7]=p,v[8]=c,v[9]=u,v[10]=l,v[11]=d,v[12]=m,v[13]=h,v[14]=g,v[15]=y}sub(t){let e=this.elements,n=t.elements,s=e[0]-n[0],i=e[1]-n[1],o=e[2]-n[2],a=e[3]-n[3],p=e[4]-n[4],c=e[5]-n[5],u=e[6]-n[6],l=e[7]-n[7],d=e[8]-n[8],m=e[9]-n[9],h=e[10]-n[10],g=e[11]-n[11],y=e[12]-n[12],v=e[13]-n[13],P=e[14]-n[14],M=e[15]-n[15];return new r([s,i,o,a,p,c,u,l,d,m,h,g,y,v,P,M])}subSet(t,e){let n=t.elements,s=e.elements,i=n[0]-s[0],o=n[1]-s[1],a=n[2]-s[2],p=n[3]-s[3],c=n[4]-s[4],u=n[5]-s[5],l=n[6]-s[6],d=n[7]-s[7],m=n[8]-s[8],h=n[9]-s[9],g=n[10]-s[10],y=n[11]-s[11],v=n[12]-s[12],P=n[13]-s[13],M=n[14]-s[14],S=n[15]-s[15];this.set(i,o,a,p,c,u,l,d,m,h,g,y,v,P,M,S)}toArray(){return[...this.elements]}toString(){let t=this.elements;return`{e0: ${t[0]}, e4: ${t[4]}, e8: ${t[8]}, e12: ${t[12]},
 e1: ${t[1]}, e5: ${t[5]}, e9: ${t[9]}, e13: ${t[13]},
 e2: ${t[2]}, e6: ${t[6]}, e10: ${t[10]}, e14: ${t[14]},
 e3: ${t[3]}, e7: ${t[7]}, e11: ${t[11]}, e15: ${t[15]}}`}translate(t,e,n){let s=this.elements;s[0]+=t*s[3],s[1]+=e*s[3],s[2]+=n*s[3],s[4]+=t*s[7],s[5]+=e*s[7],s[6]+=n*s[7],s[8]+=t*s[11],s[9]+=e*s[11],s[10]+=n*s[11],s[12]+=t*s[15],s[13]+=e*s[15],s[14]+=n*s[15]}translatePre(t,e,n){let s=this.elements;s[12]+=s[0]*t+s[4]*e+s[8]*n,s[13]+=s[1]*t+s[5]*e+s[9]*n,s[14]+=s[2]*t+s[6]*e+s[10]*n,s[15]+=s[3]*t+s[7]*e+s[11]*n}translateSet(t,e,n){this.set(1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1)}transpose(){let t=this.elements;return new r([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]])}};var tt=class r{points;constructor(t){this.points=t}static createEmpty(){return new r([])}static isAreaIntersection(t,e,n){return!!(r.isEdgeIntersection(t,e)||r.isPointInside(t,e.points[0],n)||r.isPointInside(e,t.points[0],n))}static isEdgeIntersection(t,e){for(let n of t.getEdgeIterator())for(let s of e.getEdgeIterator())if(O.isIntersection(n,s))return!0;return!1}static isPointInside(t,e,n){let s=0;for(let i of t.getEdgeIterator())s+=i.toBezier().getWindingAt(e);return n||(s=s&1),s!==0}static isPolygonInside(t,e,n=!1){for(let s of e.points)if(!r.isPointInside(t,s,n))return!1;return!0}addPoint(t){this.points.push(t)}addXY(t,e){this.addPoint(new f(t,e))}clear(){this.points=[]}clone(){let t=this.points.map(e=>e.clone());return new r(t)}findClosestEdgePoint(t){let e=Number.POSITIVE_INFINITY,n;for(let s of this.getEdgeIterator()){let i=s.getClosestPoint(t).sub(t).lenSq();i<e&&(e=i,n=s)}return n}getBounds(){let t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(let i of this.points)t=Math.min(t,i.x),e=Math.min(e,i.y),n=Math.max(n,i.x),s=Math.max(s,i.y);return new Q(t,e,n,s)}getCentroid(){let t=0,e=0;for(let s of this.points)t+=s.x,e+=s.y;let n=this.points.length;return new f(t/n,e/n)}getConvexHull(){let t=this.points[0];for(let s=1;s<this.points.length;s++){let i=this.points[s];(i.y===t.y?i.x<t.x:i.y<t.y)&&(t=i)}let e=this.points.slice();e.sort((s,i)=>s.sub(t).angle()-i.sub(t).angle());let n=2;for(;n<e.length;){let s=e[n-2],i=e[n-1],o=e[n-0],a=s.sub(i),p=s.sub(o);a.cross(p)>0?n++:(n--,e.splice(n,1))}return new r(e)}getEdgeIterator(){return new Ke(this.points)}getEdges(){let t=[];for(let e of this.getEdgeIterator())t.push(e);return t}getOrientation(){let t=0;for(let e of this.getEdgeIterator())t+=e.p0.toVector().cross(e.p1.toVector());return t}getOrientedBoundingBox(){let t=Number.POSITIVE_INFINITY,e=[f.createZero(),f.createZero(),f.createZero(),f.createZero()],n=this.getConvexHull();for(let s of n.getEdgeIterator()){let i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,a=Number.POSITIVE_INFINITY;for(let m of n.points){let h=s.getParameterFromPoint(m),g=s.getSignedDistanceFromPoint(m);i=Math.min(i,h),o=Math.max(o,h),a=Math.min(a,g)}let p=s.getValueAt(i),c=s.getValueAt(o),u=c.sub(p),l=u.unit().normal().mulS(a),d=u.cross(l);d<t&&(e[0]=p,e[1]=p.addV(l),e[2]=c.addV(l),e[3]=c,t=d)}return new r(e)}hasPoints(){return this.points.length>0}isConvex(){let t=this.points.length,e=this.points[t-1],n=this.points[t-2],s=!1,i=!1;for(let o=0;o<t;o++){let a=this.points[o],p=e.sub(a).cross(n.sub(e));if(p>0?s=!0:p<0&&(i=!0),i&&s)return!1;n=e,e=a}return!0}isSimple(){for(let t of this.getEdgeIterator())for(let e of this.getEdgeIterator())if(t!==e&&!O.isAdjacent(t,e)&&O.isIntersection(t,e))return!1;return!0}reverse(){this.points.reverse()}toPath(){let t=w.createEmpty();if(this.points.length>0){t.moveTo(this.points[0]);for(let e=1;e<this.points.length;e++)t.lineTo(this.points[e]);t.close()}return t}transform(t){let e=this.points;for(let n=0;n<e.length;n++)e[n]=t.mulP(e[n])}};var kt=class r{comp;data;constructor(t){this.comp=t,this.data=[]}static fromArray(t,e){let n=new r(e);return n.data=t.slice().sort(e),n}clear(){this.data=[]}dequeue(){return this.data.shift()}find(t){let e=this.findIndex(t);return e>=0?this.data[e]:void 0}findBy(t,e=0){for(let n=e;n<this.data.length;n++)if(t(this.data[n]))return this.data[n]}findIndex(t){let e=this.data,n=this.comp;if(e.length<8){for(let s=0;s<e.length;s++)if(n(t,e[s])===0)return s}else{let s=this.findIndexNearestStart(t);if(n(t,e[s])===0)return s}return-1}findIndexBy(t,e=0){for(let n=e;n<this.data.length;n++)if(t(this.data[n]))return n;return-1}findIndexNearestEnd(t,e=0){let n=this.data,s=this.comp,i=e,o=n.length;for(;i<o;){let a=i+o>>>1;s(t,n[a])<0?o=a:i=a+1}return i}findIndexNearestStart(t,e=0){let n=this.data,s=this.comp,i=e,o=n.length;for(;i<o;){let a=i+o>>>1;s(t,n[a])<=0?o=a:i=a+1}return i}getAt(t){return this.data[t]}insert(t){let e=this.findIndexNearestEnd(t);this.data.splice(e,0,t)}remove(t){let e=this.findIndex(t);return e<0?!1:(this.removeAt(e),!0)}removeAt(t,e=1){this.data.splice(t,e)}removeBy(t,e=0,n=1){let s=this.findIndexBy(t,e);return s<0?!1:(this.removeAt(s,n),!0)}removeRange(t,e){let n=this.findIndexNearestStart(t),i=this.findIndexNearestEnd(e??t,n)-n;return this.removeAt(n,i),i}size(){return this.data.length}toArray(){return this.data.slice()}values(){return this.data}},gn=class r{compareFn;data;constructor(t){this.compareFn=t,this.data=[]}static fromArray(t,e){let n=new r(e);return n.data=t.slice().sort((s,i)=>e(s.key,i.key)),n}clear(){this.data=[]}dequeue(){return this.data.shift()}entries(){return this.data}find(t){let e=this.findIndex(t);return e>=0?this.data[e].value:void 0}findBy(t,e=0){for(let n=e;n<this.data.length;n++)if(t(this.data[n].key))return this.data[n].value}findIndex(t){let e=this.data,n=this.compareFn;if(e.length<8){for(let s=0;s<e.length;s++)if(n(t,e[s].key)===0)return s}else{let s=this.findIndexNearestStart(t);if(n(t,e[s].key)===0)return s}return-1}findIndexBy(t,e=0){for(let n=e;n<this.data.length;n++)if(t(this.data[n].key))return n;return-1}findIndexNearestEnd(t,e=0){let n=this.data,s=this.compareFn,i=e,o=this.data.length;for(;i<o;){let a=i+o>>>1;s(t,n[a].key)<0?o=a:i=a+1}return i}findIndexNearestStart(t,e=0){let n=this.data,s=this.compareFn,i=e,o=n.length;for(;i<o;){let a=i+o>>>1;s(t,n[a].key)<=0?o=a:i=a+1}return i}getValueAt(t){return this.data[t].value}insert(t,e){let n=this.findIndexNearestEnd(t);this.data.splice(n,0,{key:t,value:e})}keys(){return this.data.map(t=>t.key)}remove(t){let e=this.findIndex(t);return e<0?!1:(this.removeAt(e),!0)}removeAt(t,e=1){this.data.splice(t,e)}removeBy(t,e=0,n=1){let s=this.findIndexBy(t,e);return s<0?!1:(this.removeAt(s,n),!0)}removeRange(t,e){let n=this.findIndexNearestStart(t),i=this.findIndexNearestEnd(e??t,n)-n;return this.removeAt(n,i),i}size(){return this.data.length}toArray(){return this.data.slice()}values(){return this.data.map(t=>t.value)}};function ve(r,t,e,n,s){D(s<=r.length-t,"Parameter 'length' must be smaller or equal to length of 'src' to avoid over-read");let i=n+s;i>e.length&&(e.length=i);let o=t,a=n;for(;a<i;)e[a++]=r[o++]}function os(r,t,e,n,s){D(s<=r.length-t,"Parameter 'length' must be smaller or equal to length of 'src' to avoid over-read");let i=n+s;i>e.length&&(e.length=i);let o=t+s-1,a=n;for(;a<i;)e[a++]=r[o--]}function _t(r,t){if(r===t)return!0;if(r.length!==t.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==t[e])return!1;return!0}var A=class r{chain;data;face;lnext;onext;p0;seg;sym;constructor(t,e,n){this.p0=t,this.seg=e,this.data=n,this.lnext=this,this.onext=this,this.sym=this,this.chain=void 0,this.face=void 0}get lprev(){return this.onext.sym}get oprev(){return this.sym.lnext}get p1(){return this.sym.p0}static clear(t){t.lnext=t,t.onext=t,t.sym=t,t.chain=void 0,t.face=void 0}static compareQueue(t,e){return t.p0.x!==e.p0.x?t.p0.x-e.p0.x:t.p0.y!==e.p0.y?t.p0.y-e.p0.y:t.left()!==e.left()?t.left()?1:-1:t.left()?f.signedArea(t.p1,t.p0,e.p1):f.signedArea(t.p0,t.p1,e.p1)}static compareStatus(t,e){return t.p0.eq(e.p0)?t.p1.eq(e.p1)?0:f.signedArea(t.p0,t.p1,e.p1):r.compareQueue(t,e)<0?f.signedArea(t.p0,t.p1,e.p0):f.signedArea(e.p1,e.p0,t.p0)}static createPair(t,e){let n=new r(t.p0,t,void 0),s=new r(t.p1,e,void 0);return n.sym=s,n.lnext=s,s.sym=n,s.lnext=n,n}static detachPair(t){r.splice(t,t.oprev),r.splice(t.sym,t.sym.oprev)}static findConnectingEdge(t,e){if(t===t.onext)return t;let n=t;do{let s=n.onext;if(E.isBetweenCcw(e,n.vector(),s.vector()))return n;n=s}while(n!==t);return x.error("Mesh2: Cannot find connecting edge (Fallback)"),t}static isJoin(t,e){return t.p1.eq(e.p0)}static join(t,e){let n=t.sym,s=e.sym;t.lnext=e,e.onext=n,n.onext=e,s.lnext=n}static splice(t,e){let n=t.onext,s=e.onext;n.sym.lnext=e,s.sym.lnext=t,t.onext=s,e.onext=n}static swap(t){let e=t.face,n=t.sym.face;if(e===void 0||n===void 0)return;let s=t.oprev,i=t.lnext;r.splice(t,s),r.splice(t.sym,i),r.splice(t,s.lnext),r.splice(t.sym,i.lnext);let o=new R(s.p1,i.p1);t.p0=o.p0,t.seg=o,t.sym.p0=o.p1,t.sym.seg=o.reverse(),e.start=t,et.updateEdgeFaces(e,e),n.start=t.sym,et.updateEdgeFaces(n,n)}clonePair(){let t=this.sym,e=new r(this.p0,this.seg,this.data),n=new r(t.p0,t.seg,t.data);return e.sym=n,e.lnext=n,n.sym=e,n.lnext=e,e}getLnextIterator(){return new se(this,this.lprev)}getOnextIterator(){return new Ze(this,this.oprev)}left(){return this.p0.x!==this.p1.x?this.p0.x<this.p1.x:this.p0.y<this.p1.y}needsSwap(){if(this.face===void 0||this.sym.face===void 0)return!1;let t=this.p0,e=this.sym.p0,n=this.lnext.p1,s=this.sym.lnext.p1,i=t.sub(s),o=e.sub(s),a=n.sub(s),p=i.lenSq()*o.cross(a),c=o.lenSq()*i.cross(a),u=a.lenSq()*i.cross(o);return p-c+u>0}toString(){return`{p0: ${this.p0}, p1: ${this.p1}}`}validate(){D(this.sym!==this),D(this.sym.sym===this),D(this.lnext.onext.sym===this),D(this.onext.sym.lnext===this),D(this.seg!==void 0==(this.face!==void 0));let t=this.onext;do{let e=t.oprev,n=t.onext;e!==n&&(D(t.p0.eq(e.p0)&&t.p0.eq(n.p0)),D(E.isBetweenCcw(t.vector(),e.vector(),n.vector()))),t=t.onext}while(t!==this.onext)}vector(){return this.p1.sub(this.p0)}},dt=class{data;head;tail;constructor(t,e,n){this.head=t,this.tail=e,this.data=n}static updateEdgeChains(t,e){for(let n of t.getEdgeIterator())n.chain=e}getEdgeIterator(){return new se(this.tail,this.head)}isClosed(){return A.isJoin(this.head,this.tail)}printDebug(){let t=`MeshChain2 {
`;for(let e of this.getEdgeIterator())t+=`    MeshEdge2 ${e}
`;t+="}",x.infoDebug("{}",t)}writeToPath(t){let e=this.getEdgeIterator(),n=e.next();for(n.done!==!0&&(t.moveTo(n.value.p0),n=e.next());n.done!==!0;)t.lineTo(n.value.p0),n=e.next()}},et=class{data;start;constructor(t,e){this.start=t,this.data=e}static updateEdgeFaces(t,e){for(let n of t.getEdgeIterator())n.face=e}getEdgeIterator(){return new se(this.start,this.start.lprev)}getEdges(){let t=[];for(let e of this.getEdgeIterator())t.push(e);return t}getPoints(){let t=[];for(let e of this.getEdgeIterator())t.push(e.p0);return t}getSignedArea(){let t=0;for(let e of this.getEdgeIterator()){let n=e.seg??new R(e.p0,e.p1);t+=n.getSignedArea()}return t}hasPointInside(t){let e=0;for(let n of this.getEdgeIterator()){let s=n.seg??new R(n.p0,n.p1);e+=s.getWindingAt(t)}return e!==0}isMonotoneInX(){let t=this.start.lprev,e=0,n=t.p1.x-t.p0.x;for(let s of this.getEdgeIterator()){let i=s.p1.x-s.p0.x;(n>0||i>0)&&(n<0||i<0)&&(e+=1),n=i}return e<=2}printDebug(){let t=`MeshFace2 {
`;for(let e of this.getEdgeIterator())t+=`    MeshEdge2 ${e}
`;t+="}",x.infoDebug("{}",t)}writeToPath(t){let e=this.getEdgeIterator(),n=e.next();for(n.done!==!0&&(t.moveTo(n.value.p0),n=e.next());n.done!==!0;)t.lineTo(n.value.p0),n=e.next();t.close()}},K=class r{chains;edges;faces;constructor(t,e,n){this.edges=t,this.chains=e,this.faces=n}static createEmpty(){return new r([],[],[])}static fromChain(t){let e=r.createEmpty(),n=t.getEdgeIterator(),s=n.curr.clonePair();e.edges.push(s),n.next();let i=s;for(let a of n){let p=a.clonePair();e.edges.push(p),A.join(i,p),i=p}let o=new dt(s,i,t.data);return dt.updateEdgeChains(o,o),e.chains.push(o),e}static fromFace(t){let e=r.createEmpty(),n=t.getEdgeIterator(),s=n.curr.clonePair();e.edges.push(s),n.next();let i=s;for(let a of n){let p=a.clonePair();A.join(i,p),e.edges.push(p),i=p}A.join(i,s);let o=new et(s,t.data);return et.updateEdgeFaces(o,o),e.faces.push(o),e}addChainSegment(t,e){let n=this.createEdge(t);n.data=e;for(let s of this.chains){if(A.isJoin(s.head,n))return this.chainAddHead(s,n),n;if(A.isJoin(n,s.tail))return this.chainAddTail(s,n),n}return this.createChain(n,n),n}clear(){for(let t of this.edges)A.clear(t);this.chains=[],this.edges=[],this.faces=[]}clone(){let t=r.createEmpty(),e=new Map;for(let n=0;n<this.edges.length;n++){let s=this.edges[n],i=new A(s.p0,s.seg,s.data);t.edges.push(i),e.set(s,n)}for(let n=0;n<this.edges.length;n++){let s=this.edges[n],i=t.edges[n],o=e.get(s.sym),a=e.get(s.lnext),p=e.get(s.onext);o!==void 0&&(i.sym=t.edges[o]),a!==void 0&&(i.lnext=t.edges[a]),p!==void 0&&(i.onext=t.edges[p])}for(let n of this.chains){let s=e.get(n.head),i=e.get(n.tail);if(s!==void 0&&i!==void 0){let o=new dt(t.edges[s],t.edges[i],n.data);dt.updateEdgeChains(o,o),t.chains.push(o)}}for(let n of this.faces){let s=e.get(n.start);if(s!==void 0){let i=new et(t.edges[s],n.data);et.updateEdgeFaces(i,i),t.faces.push(i)}}return t}connectEdgePoints(t,e){let n=e.p0.sub(t.p0);if(n.isZero()){let s=A.findConnectingEdge(t,e.vector()),i=A.findConnectingEdge(e,t.vector());this.connectEdges(s,i)}else{let s=A.findConnectingEdge(t,n),i=A.findConnectingEdge(e,n.neg());this.connectEdges(s,i)}}connectEdges(t,e){if(t!==e){if(t.face===void 0||e.face===void 0){x.error("Mesh2: At least one face is undefined");return}if(t.p0.eq(e.p0))A.splice(t,e);else{let n=new R(t.p0,e.p0),s=this.createEdge(n,n.reverse());A.splice(t,s),A.splice(e,s.sym)}if(t.face===e.face){let n=t.face;n.start=t,et.updateEdgeFaces(n,n);let s=this.createFace(e);s.data=n.data,et.updateEdgeFaces(s,s)}else{let n=e.face;et.updateEdgeFaces(n,t.face);let s=this.destroyFace(n);D(s,"Unable to destroy face")}}}createChain(t,e){let n=new dt(t,e,void 0);return this.chains.push(n),n}createEdge(t,e){let n=A.createPair(t,e);return this.edges.push(n,n.sym),n}createFace(t){let e=new et(t,void 0);return this.faces.push(e),e}deleteEdgePair(t){A.detachPair(t),t.chain=void 0,t.face=void 0,t.sym.chain=void 0,t.sym.face=void 0;let e=this.destroyEdge(t),n=this.destroyEdge(t.sym);D(e&&n,"Unable to destroy edges")}deleteFace(t){let e=t.start,n=e,s=n.lnext;do n=s,s=n.lnext,n.sym.face===void 0?this.deleteEdgePair(n):n.face=void 0;while(n!==e);let i=this.destroyFace(t);D(i,"Unable to destroy face")}destroyChain(t){let e=this.chains.indexOf(t);return e<0?!1:(this.chains.splice(e,1),!0)}destroyEdge(t){let e=this.edges.indexOf(t);return e<0?!1:(this.edges.splice(e,1),!0)}destroyFace(t){let e=this.faces.indexOf(t);return e<0?!1:(this.faces.splice(e,1),!0)}finalizeChain(t){let e=this.createFace(t.tail);e.data=t.data;let n=this.destroyChain(t);D(n,"Unable to destroy chain");for(let s of e.getEdgeIterator())s.face=e,s.chain=void 0}getChains(){return this.chains}getChainsPath(){let t=w.createEmpty();for(let e of this.chains)e.writeToPath(t);return t}getEdges(){return this.edges}getFaces(){return this.faces}getFacesPath(){let t=w.createEmpty();for(let e of this.faces)e.writeToPath(t);return t}getFacesPaths(){let t=[];for(let e of this.faces){let n=w.createEmpty();e.writeToPath(n),t.push(n)}return t}monotonize(){let t=this.edges.filter(e=>e.face!==void 0);t.sort((e,n)=>A.compareQueue(e,n)),this.monotoneProcess(t)}monotonizeFaces(t){let e=[];for(let n of t)for(let s of n.getEdgeIterator())e.push(s);e.sort((n,s)=>A.compareQueue(n,s)),this.monotoneProcess(e)}printDebug(){let t=`Mesh2 {
`;for(let e of this.getChains()){t+=`    MeshChain2 {
`;for(let n of e.getEdgeIterator())t+=`        MeshEdge2 ${n}
`;t+=`    }
`}for(let e of this.getFaces()){t+=`    MeshFace2 {
`;for(let n of e.getEdgeIterator())t+=`        MeshEdge2 ${n}
`;t+=`    }
`}t+="}",x.infoDebug("{}",t)}triangulate(t=!1){this.monotonize();let e=this.faces.length;for(let n=0;n<e;n++)this.triangulateProcess(this.faces[n]);t&&this.triangulateOptimize()}triangulateAddPoint(t){for(let e of this.faces)if(e.hasPointInside(t)){let n=e.start,s=n.lnext,i=s.lnext,o=new R(t,n.p0),a=new R(t,s.p0),p=new R(t,i.p0),c=this.createEdge(o,o.reverse()),u=this.createEdge(a,a.reverse()),l=this.createEdge(p,p.reverse());A.splice(c,u),A.splice(u,l),A.splice(n,c.sym),A.splice(s,u.sym),A.splice(i,l.sym);let d=new et(s,void 0),m=new et(i,void 0);et.updateEdgeFaces(e,e),et.updateEdgeFaces(d,d),et.updateEdgeFaces(m,m),this.faces.push(d),this.faces.push(m);return}}triangulateOptimize(){let t=0;for(;t<this.edges.length;){let e=this.edges[t];e.needsSwap()?(A.swap(e),t=0):t++}}validate(){for(let t of this.edges)t.validate()}chainAddHead(t,e){A.join(t.head,e),t.head=e,t.isClosed()?(A.join(t.head,t.tail),this.finalizeChain(t)):this.chainCheckTails(t)}chainAddTail(t,e){A.join(e,t.tail),t.tail=e,t.isClosed()?(A.join(t.head,t.tail),this.finalizeChain(t)):this.chainCheckHeads(t)}chainCheckHeads(t){for(let e of this.chains)if(e!==t&&A.isJoin(e.head,t.tail)){A.join(e.head,t.tail),t.tail=e.tail;let n=this.destroyChain(e);D(n,"Unable to destroy chain"),t.isClosed()&&(A.join(t.head,t.tail),this.finalizeChain(t));return}}chainCheckTails(t){for(let e of this.chains)if(e!==t&&A.isJoin(t.head,e.tail)){A.join(t.head,e.tail),t.head=e.head;let n=this.destroyChain(e);D(n,"Unable to destroy chain"),t.isClosed()&&(A.join(t.head,t.tail),this.finalizeChain(t));return}}monotoneDelete(t,e,n){let s=t.findIndex(e);if(s<0){x.error("Mesh2: Unable to delete status");return}let i=t.getValueAt(s);i.isMerge===!0&&this.connectEdgePoints(n,i.helper),t.removeAt(s)}monotoneInsert(t,e){t.insert(e,{helper:e,face:e.face,isMerge:!1})}monotoneProcess(t){let e=new gn(A.compareStatus);for(let n of t){let s=n.lprev,i=n;if(i.seg===void 0){x.error("Mesh2: Unable to get segment");continue}let o=s.p0,a=i.p0,p=i.p1,c=a.sub(o),u=p.sub(a),l=c.cross(u);if(l>0){if(o.x>=a.x&&a.x<p.x){this.monotoneInsert(e,i);continue}if(o.x<=a.x&&a.x>p.x){this.monotoneDelete(e,s,i);continue}}else if(l<0){if(o.x>a.x&&a.x<=p.x){this.monotoneUpdate(e,i,!1,!0),this.monotoneInsert(e,i);continue}if(o.x<a.x&&a.x>=p.x){this.monotoneDelete(e,s,i),this.monotoneUpdate(e,i,!0,!1);continue}}a.lt(p)?(this.monotoneDelete(e,s,i),this.monotoneInsert(e,i)):this.monotoneUpdate(e,i,!1,!1)}}monotoneUpdate(t,e,n,s){let i=t.findIndexNearestEnd(e);if(i<0){x.error("Mesh2: Unable to update status");return}let o=t.getValueAt(i);(o.isMerge||s)&&this.connectEdgePoints(e,o.helper),o.helper=e,o.isMerge=n}triangulateProcess(t){let e=t.getEdges();e.sort((i,o)=>A.compareQueue(i,o));let n=[e[0],e[1]];for(let i=2;i<e.length-1;i++){let o=e[i],a=e[i-1],p=o.lnext.p0.eq(a.p0),c=a.lnext.p0.eq(o.p0);if(p||c)for(;n.length>1;){let u=n[n.length-1],l=n[n.length-2],d=f.signedArea(o.p0,u.p0,l.p0);if(p&&d>0||c&&d<0)this.connectEdgePoints(o,l),n.pop();else break}else{for(;n.length>1;){let u=n[n.length-1];this.connectEdgePoints(o,u),n.pop()}n.pop(),n.push(a)}n.push(o)}let s=e[e.length-1];for(let i=1;i<n.length-1;i++){let o=n[i];this.connectEdgePoints(s,o)}}};var St=class r{left;p0;p1;seg;wind;constructor(t,e,n,s,i){this.p0=t,this.p1=e,this.seg=n,this.wind=s,this.left=i}static compareQueue(t,e){return t.p0.x!==e.p0.x?t.p0.x-e.p0.x:t.p0.y!==e.p0.y?t.p0.y-e.p0.y:t.left!==e.left?t.left?1:-1:t.left?f.signedArea(t.p1,t.p0,e.p1):f.signedArea(t.p0,t.p1,e.p1)}static compareStatus(t,e){return t.p0.eq(e.p0)?t.p1.eq(e.p1)?0:f.signedArea(t.p1,t.p0,e.p1):r.compareQueue(t,e)<0?f.signedArea(t.p1,t.p0,e.p0):f.signedArea(e.p0,e.p1,t.p0)}eq(t){return this.p0.eq(t.p0)&&this.p1.eq(t.p1)}printDebug(){x.infoDebug("{} -> {} ({}, id = {}, winding = {})",this.p0,this.p1,this.left?"left":"right",this.seg.ref.data,this.wind)}};function yn(r){r.process(),x.assertFnDebug(()=>r.validate(),"PathClip2: Validation failed");let t=[];r.writeEdgeSegmentsTo(t);let e=[];for(let n of t){let s=n.p0,i=n.p1,o=n.ref.weight;s.eq(i)||(s.lt(i)?(e.push(new St(s,i,n,o,!0)),e.push(new St(i,s,n,o,!1))):(e.push(new St(i,s,n,-o,!0)),e.push(new St(s,i,n,-o,!1))))}return e.sort(St.compareQueue),e}function xe(r,t,e){let n=!1,s=!1;switch(e){case 0:{n=r!==0,s=t!==0;break}case 1:{n=(r&1)!==0,s=(t&1)!==0;break}case 2:{n=r>0,s=t>0;break}case 3:{n=r<0,s=t<0;break}default:{n=e(r),s=e(t);break}}return[n,s]}function Li(r,t,e,n,s){let i=!1,o=!1;switch(s){case 0:{i=!r&&!e&&(t||n),o=!t&&!n&&(r||e);break}case 1:{i=t&&n&&(!r||!e),o=r&&e&&(!t||!n);break}case 2:{i=r===e&&t!==n,o=r!==e&&t===n;break}case 3:{i=t&&!n&&(!r||e),o=r&&!e&&(!t||n);break}case 4:{i=!t&&n&&(r||!e),o=!r&&e&&(t||!n);break}}return[i,o]}var ct=class r{hi;lo;constructor(t,e){this.hi=t,this.lo=e}static from(t){return new r(t,0)}add(t){let e=as(this.hi,t.hi),n=as(this.lo,t.lo),s=Lt(e.hi,e.lo+n.hi);return Lt(s.hi,n.lo+s.lo)}add64(t){let e=as(this.hi,t);return Lt(e.hi,this.lo+e.lo)}div(t){let e=this.hi/t.hi,n=xa(this,e),s=this.hi-n.hi,i=this.lo-n.lo,o=s+i;return Lt(e,o/t.hi)}div64(t){let e=this.hi/t,n=vn(e,t),o=this.hi-n.hi-n.lo+this.lo;return Lt(e,o/t)}mul(t){let e=vn(this.hi,t.hi),n=this.hi*t.lo,s=this.lo*t.hi,i=n+s;return Lt(e.hi,e.lo+i)}mul64(t){let e=vn(this.hi,t),n=this.lo*t;return Lt(e.hi,e.lo+n)}neg(){return new r(-this.hi,-this.lo)}sub(t){return this.add(t.neg())}sub64(t){return this.add64(-t)}value(){return this.hi+this.lo}};function as(r,t){let e=r+t,n=e-t,s=e-n,i=r-n,o=t-s,a=i+o;return new ct(e,a)}function Lt(r,t){let e=r+t,n=e-r,s=t-n;return new ct(e,s)}function xa(r,t){let e=vn(r.hi,t),n=Lt(e.hi,r.lo*t);return Lt(n.hi,n.lo+e.lo)}function vn(r,t){let e=Vi(r),n=Vi(t),s=r*t,p=-s+e.hi*n.hi+e.hi*n.lo+e.lo*n.hi+e.lo*n.lo;return new ct(s,p)}function Vi(r){let t=134217729*r,e=r-t,n=t+e,s=r-n;return new ct(n,s)}var ps=class{pixel;constructor(){this.pixel=new Map}addMagnet(t){let e=t.toString();this.pixel.set(e,{type:0,p:t})}addPin(t){let e=t.toString();this.pixel.has(e)||this.pixel.set(e,{type:1,p:t})}clear(){this.pixel.clear()}getMagnets(){let t=[];for(let e of this.pixel.values())e.type===0&&t.push(e.p);return t}getPins(){let t=[];for(let e of this.pixel.values())e.type===1&&t.push(e.p);return t}getValues(){return this.pixel.values()}},Ut=class{key;left;p0;p1;seg;constructor(t,e,n,s,i){this.p0=t,this.p1=e,this.seg=n,this.key=s,this.left=i}static compareQueue(t,e){return t.p0.x!==e.p0.x?t.p0.x-e.p0.x:t.p0.y!==e.p0.y?t.p0.y-e.p0.y:t.left!==e.left?t.left?1:-1:0}static compareStatus(t,e){return t.key-e.key}},jt=class{inputSegments;intersections;magnets;outputSegments;pins;pixelSet;precision;constructor(){this.precision=2**16,this.inputSegments=[],this.intersections=[],this.magnets=[],this.outputSegments=[],this.pins=[],this.pixelSet=new ps}addSegment(t,e,n,s,i){x.assertFnDebug(()=>t.isFinite(),"SnapRound2: BezierCurve2 is not finite"),t.type!==0&&x.warn("SnapRound2: Not implemented yet");let o=this.precision,a=this.addEndpoint(t.p0,o,s),p=this.addEndpoint(t.pn,o,s),c={set:e,weight:n,data:i};this.inputSegments.push({p0:a,p1:p,ref:c})}clear(){this.pixelSet.clear(),this.inputSegments=[],this.intersections=[],this.magnets=[],this.outputSegments=[],this.pins=[]}debugGetErrors(){return this.createIntersections(this.outputSegments)}debugGetInputSegments(){return this.inputSegments.slice()}debugGetIntersections(){return this.intersections.slice()}debugGetMagnets(){return this.magnets.slice()}debugGetOutputSegments(){return this.outputSegments.slice()}debugGetPins(){return this.pins.slice()}process(){this.intersections=this.createIntersections(this.inputSegments);for(let t of this.intersections){let e=xn(t);this.pixelSet.addMagnet(e)}this.magnets=this.pixelSet.getMagnets(),this.pins=this.pixelSet.getPins(),this.intersectEdges(this.magnets,this.pins)}validate(){return this.debugGetErrors().length===0}writeEdgeSegmentsTo(t){let e=this.precision;for(let n of this.outputSegments){let s=new f(n.p0.x/e,n.p0.y/e),i=new f(n.p1.x/e,n.p1.y/e),o=n.ref;t.push({p0:s,p1:i,ref:o})}}writeEdges(t){let e=this.precision;for(let n of this.outputSegments){let s=new f(n.p0.x/e,n.p0.y/e),i=new f(n.p1.x/e,n.p1.y/e);t.push(new O(s,i))}}static signedArea(t,e,n){let s=ct.from(t.x),i=ct.from(t.y),o=ct.from(e.x),a=ct.from(e.y),p=ct.from(n.x),c=ct.from(n.y),u=o.sub(s),l=a.sub(i),d=p.sub(s),m=c.sub(i),h=u.mul(m),g=l.mul(d);return h.sub(g).value()}addEndpoint(t,e,n){let s=new f(e*t.x,e*t.y),i=xn(s);return this.isPin(i,t,e)&&!n?(this.pixelSet.addPin(i),i):(this.pixelSet.addMagnet(i),s)}addSegmentCandidate(t,e,n,s){if(e.eq(n))return;let i=this.getPixelIntersections(e,n,s);this.sortByParameter(i);let o=e;for(let a of i){let p=f.signedArea(t.p0,t.p1,a.p),c=f.signedArea(e,n,a.p);p*c<=0&&(this.addSegmentOutput(o,a.p,t.ref),o=a.p)}this.addSegmentOutput(o,n,t.ref)}addSegmentOutput(t,e,n){t.eq(e)||this.outputSegments.push({p0:t,p1:e,ref:n})}createIntersections(t){let e=[],n=this.createQueue(t),s=new kt(Ut.compareStatus);for(let i of n.values())if(i.left){for(let o of s.values())this.writeSegmentIntersectionsTo(i.seg,o.seg,e);s.insert(i)}else{let o=s.remove(i);D(o,`SnapRound2: Status event not found
{}`,i.seg)}return e}createQueue(t){let e=[];for(let n=0;n<t.length;n++){let s=t[n];s.p0.eq(s.p1)||(s.p0.lt(s.p1)?(e.push(new Ut(s.p0,s.p1,s,n,!0)),e.push(new Ut(s.p1,s.p0,s,n,!1))):(e.push(new Ut(s.p1,s.p0,s,n,!0)),e.push(new Ut(s.p0,s.p1,s,n,!1))))}return kt.fromArray(e,Ut.compareQueue)}getPixelIntersections(t,e,n){let s=[];for(let i of n){if(i.eq(t)||i.eq(e))continue;let o=Sa(t,e,i);if(o!==void 0){let[a,p]=o;s.push({p:i,min:a,max:p})}}return s}intersectEdges(t,e){for(let n of this.inputSegments){let s=xn(n.p0),i=xn(n.p1);if(s.eq(i)){this.outputSegments.push({p0:s,p1:i,ref:n.ref});continue}let o=this.getPixelIntersections(n.p0,n.p1,t);this.sortByParameter(o);let a=s;for(let p of o)this.addSegmentCandidate(n,a,p.p,e),a=p.p;this.addSegmentCandidate(n,a,i,e)}}isPin(t,e,n){return t.x/n===e.x&&t.y/n===e.y}sortByParameter(t){t.sort((e,n)=>e.min!==n.min?e.min-n.min:(e.max===n.max&&x.error("Max parameter values are equal"),e.max-n.max))}writeSegmentIntersectionsTo(t,e,n){if(t.p0.eq(e.p0)||t.p0.eq(e.p1)||t.p1.eq(e.p0)||t.p1.eq(e.p1))return;let s=f.signedArea(e.p0,e.p1,t.p0),i=f.signedArea(e.p0,e.p1,t.p1),o=Rt(i-s,s);if(o<0||o>1||Number.isNaN(o))return;let a=f.signedArea(t.p0,t.p1,e.p0),p=f.signedArea(t.p0,t.p1,e.p1),c=Rt(p-a,a);if(c<0||c>1||Number.isNaN(c))return;let u=t.p0.lerp(t.p1,o),l=e.p0.lerp(e.p1,c);n.push(u.lerp(l,.5))}};function Sa(r,t,e){let n=e.x-.5,s=e.y-.5,i=e.x+.5,o=e.y+.5;if(r.x<n&&t.x<n||r.y<s&&t.y<s||r.x>i&&t.x>i||r.y>o&&t.y>o)return;let a=t.x-r.x,p=t.y-r.y,c=(n-r.x)/a,u=(i-r.x)/a,l=(s-r.y)/p,d=(o-r.y)/p;if(a===0){if(r.x===i)return;c=l,u=d}if(p===0){if(r.y===o)return;l=c,d=u}let m=Math.max(Math.min(c,u),Math.min(l,d)),h=Math.min(Math.max(c,u),Math.max(l,d)),g;if(m===h){let y=r.lerp(t,m);y.x===n&&y.y===s&&(g=[m,h])}else m<h&&(m>=0&&m<=1?g=[m,h]:h>=0&&h<=1&&(g=[h,m]));return g}function xn(r){let t=Math.round(r.x),e=Math.round(r.y);return new f(t,e)}var mt=class{booleanOperator;flattenTolerance;snapRound;status;windingOperatorA;windingOperatorB;constructor(t){this.status=new kt(St.compareStatus),this.snapRound=new jt,this.snapRound.precision=t.clipPrecision,this.flattenTolerance=t.flattenTolerance,this.booleanOperator=xt.booleanOperator,this.windingOperatorA=xt.windingOperatorA,this.windingOperatorB=xt.windingOperatorB}addCurve(t,e=0,n=1,s=!1,i){this.snapRound.addSegment(t,e,n,s,i)}addEdge(t,e=0,n=1,s=!1,i){this.snapRound.addSegment(t.toBezier(),e,n,s,i)}addMesh(t,e=0,n=1,s=!1){for(let i of t.getChains())for(let o of i.getEdgeIterator())o.seg!==void 0&&this.snapRound.addSegment(o.seg,e,n,s,o.data);for(let i of t.getFaces())for(let o of i.getEdgeIterator())o.seg!==void 0&&this.snapRound.addSegment(o.seg,e,n,s,o.data)}addPath(t,e=0,n=1,s=!1){let i=t.flatten(!1,{flattenMode:1,flattenTolerance:this.flattenTolerance});for(let o of i.getCurveIterator())this.snapRound.addSegment(o,e,n,s,void 0)}process(t,e){this.booleanOperator=e.booleanOperator,this.windingOperatorA=e.windingOperatorA,this.windingOperatorB=e.windingOperatorB,this.status.clear();let n=yn(this.snapRound);for(let s of n)if(s.left)this.status.insert(s);else{let i=this.status.findIndexBy(c=>c.seg===s.seg);if(i<0){x.error("PathClip2: Status event segment {} not found",s.seg);continue}let o=this.status.getAt(i),[a,p]=this.isIncOut(o);if(a){let c=new R(o.p0,o.p1);t.addChainSegment(c,o.seg.ref.data)}else if(p){let c=new R(o.p1,o.p0);t.addChainSegment(c,o.seg.ref.data)}this.status.removeAt(i)}this.snapRound.clear()}setQualityOptions(t){this.snapRound.precision=t.clipPrecision,this.flattenTolerance=t.flattenTolerance}isIncOut(t){if(t.wind===0)return[!1,!1];let e=0,n=0,s=0,i=0,o=!1;for(let l=this.status.size()-1;l>=0;l--){let d=this.status.getAt(l);if(d.eq(t))d.seg.ref.set===0?e-=d.wind:s-=d.wind,d.wind=0,o=!0;else if(!o)d.seg.ref.set===0?n-=d.wind:i-=d.wind;else break}e+=n,s+=i;let[a,p]=xe(e,n,this.windingOperatorA),[c,u]=xe(s,i,this.windingOperatorB);return Li(a,p,c,u,this.booleanOperator)}};var w=class r{commands;points;constructor(t,e){this.commands=t,this.points=e}static createEmpty(){return new r([],[])}static fromObject(t){let e=t.commands.map(s=>({...s})),n=t.points.map(s=>f.fromObject(s));return new r(e,n)}static toObject(t){let e=t.commands.map(s=>({...s})),n=t.points.map(s=>f.toObject(s));return{commands:e,points:n}}addArc(t,e,n){this.moveTo(t),this.arcTo(e,n)}addCircle(t,e){this.addCircleXY(t.x,t.y,e)}addCircleXY(t,e,n){this.moveToXY(t+n,e),this.arcToXY(t+n,e+n,t,e+n),this.arcToXY(t-n,e+n,t-n,e),this.arcToXY(t-n,e-n,t,e-n),this.arcToXY(t+n,e-n,t+n,e)}addConic(t,e,n,s){this.moveTo(t),this.conicTo(e,n,s)}addCubic(t,e,n,s){this.moveTo(t),this.cubicTo(e,n,s)}addCurveSplines(...t){if(t.length!==0){this.moveTo(t[0].p0);for(let e=0;e<t.length;e++){let n=t[e];switch(n.type){case 0:{this.lineTo(n.p1);break}case 1:{this.quadTo(n.p1,n.p2);break}case 2:{this.cubicTo(n.p1,n.p2,n.p3);break}case 3:{this.conicTo(n.p1,n.p2,n.w);break}default:U(n)}}}}addEllipse(t,e,n){this.addEllipseXY(t.x,t.y,e,n)}addEllipseXY(t,e,n,s){this.moveToXY(t+n,e),this.arcToXY(t+n,e+s,t,e+s),this.arcToXY(t-n,e+s,t-n,e),this.arcToXY(t-n,e-s,t,e-s),this.arcToXY(t+n,e-s,t+n,e),this.close()}addLine(t,e){this.moveTo(t),this.lineTo(e)}addLineXY(t,e,n,s){let i=new f(t,e),o=new f(n,s);this.addLine(i,o)}addPath(t,e=!1){e&&t.isValid()?(ve(t.commands,1,this.commands,this.commands.length,t.commands.length-1),ve(t.points,1,this.points,this.points.length,t.points.length-1)):(ve(t.commands,0,this.commands,this.commands.length,t.commands.length),ve(t.points,0,this.points,this.points.length,t.points.length))}addPathReversed(t,e=!1){e&&t.isValid()?(ss(t.commands,1,this.commands,this.commands.length,t.commands.length-1),os(t.points,0,this.points,this.points.length,t.points.length-1)):(ss(t.commands,0,this.commands,this.commands.length,t.commands.length),os(t.points,0,this.points,this.points.length,t.points.length))}addPie(t,e,n,s,i){let o=i;Math.abs(o)>2*Math.PI&&(o%=2*Math.PI);let a=Math.sin(s),p=Math.cos(s),c=Jt.fromRotation(p,a);c.scale(e,n),c.translate(t.x,t.y),o<0&&c.scalePre(1,-1),o=Math.abs(o),a=Math.sin(o),p=Math.cos(o);let u=new E(1,0),l=new E(1,1),d=new E(p,a);for(this.moveTo(t),this.lineTo(c.mulV(u).toPoint());o>.5*Math.PI+.005;){u=u.normal().neg();let g=c.mulV(l).toPoint(),y=c.mulV(u).toPoint();this.arcTo(g,y),l=l.normal().neg(),o-=.5*Math.PI}l=u.add(d),l=l.mulS(2).divS(l.dot(l)),p=Math.sqrt(.5*u.dot(d)+.5);let m=c.mulV(l).toPoint(),h=c.mulV(d).toPoint();this.conicTo(m,h,p),this.close()}addQuad(t,e,n){this.moveTo(t),this.quadTo(e,n)}addRect(t,e){this.addRectXY(t.x,t.y,e.x,e.y)}addRectXY(t,e,n,s){this.moveToXY(t,e),this.lineToXY(n,e),this.lineToXY(n,s),this.lineToXY(t,s),this.close()}arcTo(t,e){this.conicTo(t,e,Math.SQRT1_2)}arcToXY(t,e,n,s){let i=new f(t,e),o=new f(n,s);this.arcTo(i,o)}clear(){this.commands=[],this.points=[]}clip(t,e,n){let s=K.createEmpty(),i=new mt({...H,...n});return i.addPath(this,0),i.addPath(t,1),i.process(s,{...xt,...e}),s.getFacesPath()}close(){this.commands.push({type:5})}conicTo(t,e,n){this.commands.push({type:4,w:n}),this.points.push(t),this.points.push(e)}conicToXY(t,e,n,s,i){let o=new f(t,e),a=new f(n,s);this.conicTo(o,a,i)}copyFrom(t){this.commands=t.commands.slice(),this.points=t.points.slice()}cubicTo(t,e,n){this.commands.push({type:3}),this.points.push(t),this.points.push(e),this.points.push(n)}cubicToXY(t,e,n,s,i,o){let a=new f(t,e),p=new f(n,s),c=new f(i,o);this.cubicTo(a,p,c)}dash(t,e){let n=r.createEmpty();return ki({...H,...e}).process(this,n,{...Wi,...t}),n}flatten(t=!1,e){let n=r.createEmpty();return mn({...H,...e}).process(this,n,t),n}getBounds(){let t=Q.createEmpty();for(let e of this.getCurveIterator())t.union(e.getBounds());return t}getCommands(){return this.commands}getCurveIterator(){return new He(this.commands,this.points)}getFirstCommand(){return this.commands[0]}getFirstPoint(){return this.points[0]}getLastCommand(){return this.commands[this.commands.length-1]}getLastPoint(){return this.points[this.points.length-1]}getPoints(){return this.points}getSignedArea(){let t=0;for(let e of this.getCurveIterator())t+=e.getSignedArea();return t}getSvgData(){let t=this.getCommands(),e=this.getPoints(),n=0,s=0,i="";for(;n<t.length;){let o=t[n++];switch(o.type){case 0:{let a=e[s++];i+=`M${a.x} ${a.y}`;break}case 1:{let a=e[s++];i+=`L${a.x} ${a.y}`;break}case 2:{let a=e[s++],p=e[s++];i+=`Q${a.x} ${a.y} ${p.x} ${p.y}`;break}case 3:{let a=e[s++],p=e[s++],c=e[s++];i+=`C${a.x} ${a.y} ${p.x} ${p.y} ${c.x} ${c.y}`;break}case 4:{let a=e[s++],p=e[s++];i+=`L${a.x} ${a.y} L${p.x} ${p.y}`;break}case 5:{i+="Z";break}default:U(o)}}return i}hasPointInside(t,e){if(!this.isValid())return!1;let n=0;for(let s of this.getCurveIterator()){let i=s.getControlBounds();t.y<i.y0||t.y>i.y1||t.x<i.x0||(n+=s.getWindingAt(t))}return is(n,e)}hasPointInsideFrac(t,e,n){if(!this.isValid())return!1;let s=n??2**-8,i=0;for(let o of this.getCurveIterator())i+=o.getWindingFracAt(t,s);return i=i/(2*Math.PI),i=Math.round(i),is(i,e)}isClosed(){return this.getLastCommand()?.type===5}isValid(){return this.getFirstCommand()?.type===0}lineTo(t){this.commands.push({type:1}),this.points.push(t)}lineToXY(t,e){let n=new f(t,e);this.lineTo(n)}moveTo(t){this.commands.push({type:0}),this.points.push(t)}moveToXY(t,e){let n=new f(t,e);this.moveTo(n)}offset(t,e){let n=r.createEmpty();return Fi({...H,...e}).process(this,n,{...zi,...t}),n}quadTo(t,e){this.commands.push({type:2}),this.points.push(t),this.points.push(e)}quadToXY(t,e,n,s){let i=new f(t,e),o=new f(n,s);this.quadTo(i,o)}simplify(t){let e=r.createEmpty();return Bi({...H,...t}).process(this,e),e}stroke(t,e){let n=r.createEmpty();return hn({...H,...e}).process(this,n,{...Ft,...t}),n}svgArcTo(t,e,n,s,i,o){let a=this.getLastPoint();if(a===void 0||a===t||e===0||n===0){this.lineTo(t);return}let p=Math.sin(s),c=Math.cos(s),u=Jt.fromRotation(c,-p),l=a.sub(t).mulS(.5);l=u.mulV(l);let d=Math.abs(e),m=Math.abs(n),h=l.x*l.x/(d*d)+l.y*l.y/(m*m);h>1&&(h=Math.sqrt(h),d*=h,m*=h),u.scale(1/d,1/m);let g=u.mulP(a),y=u.mulP(t);l=y.sub(g).mulS(.5);let v=g.addV(l),P=l.lenSq();if(P<1){let z=Math.sqrt(1/P-1);l=l.normal().neg().mulS(z),i!==o?v=v.addV(l):v=v.subV(l)}let M=g.sub(v),S=y.sub(v);u.rotateSet(M.x,M.y),u.translate(v.x,v.y),u.scale(d,m),u.rotate(c,p),p=M.cross(S),c=M.dot(S);let C=Math.atan2(p,c);for(o?(C<0&&(C+=2*Math.PI),S=new E(c,p)):(C>0&&(C-=2*Math.PI),u.scalePre(1,-1),S=new E(c,-p),C=Math.abs(C)),M=new E(1,0),l=new E(1,1);C>.5*Math.PI+.005;)M=M.normal().neg(),g=u.mulV(l).toPoint(),y=u.mulV(M).toPoint(),this.arcTo(g,y),l=l.normal().neg(),C-=.5*Math.PI;l=M.add(S),l=l.mulS(2).divS(l.dot(l)),g=u.mulV(l).toPoint(),y=t,c=Math.sqrt(.5*(1+M.dot(S))),this.conicTo(g,y,c)}toMesh(t,e){let n=K.createEmpty(),s=new mt({...H,...e});return s.addPath(this,0),s.process(n,{...xt,windingOperatorA:t}),n}toMultiPolygon(t,e){return this.toMesh(t,e).getFaces().map(s=>new tt(s.getPoints()))}transform(t){let e=this.points;for(let n=0;n<e.length;n++)e[n]=t.mulP(e[n])}};var ht=class r{a;b;g;r;constructor(t,e,n,s){this.r=t,this.g=e,this.b=n,this.a=s}static fromArray(t,e=0){return new r(t[e],t[e+1],t[e+2],t[e+3])}static fromHSV(t,e,n,s){let i=Math.floor(t*6),o=t*6-i,a=n*(1-e),p=n*(1-e*o),c=n*(1-e*(1-o));switch(i%6){case 0:return new r(n,c,a,s);case 1:return new r(p,n,a,s);case 2:return new r(a,n,c,s);case 3:return new r(a,p,n,s);case 4:return new r(c,a,n,s);case 5:return new r(n,a,p,s)}return new r(0,0,0,s)}static fromNumber(t){let e=t>>>0&255,n=t>>>8&255,s=t>>>16&255,i=t>>>24&255;return new r(i/255,s/255,n/255,e/255)}static fromObject(t){return new r(t.r,t.g,t.b,t.a)}static toObject(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}clone(){return new r(this.r,this.g,this.b,this.a)}style(){let t=this.clampFloatToHex(this.r),e=this.clampFloatToHex(this.g),n=this.clampFloatToHex(this.b),s=this.clampFloatToHex(this.a);return`#${t}${e}${n}${s}`}toArray(){return[this.r,this.g,this.b,this.a]}clampFloatToHex(t){return j(Math.round(255*t),0,255).toString(16).padStart(2,"0")}};function Pn(r,t,e,n){return ht.fromHSV(r.nextFloat(),t,e,n)}function pe(r,t,e,n,s){let i=w.createEmpty();switch(i.moveTo(new f(n*r.nextFloat(),s*r.nextFloat())),t){case 0:{for(let o=0;o<e;o++){let a=new f(n*r.nextFloat(),s*r.nextFloat());i.lineTo(a)}break}case 1:{for(let o=0;o<e;o++){let a=new f(n*r.nextFloat(),s*r.nextFloat()),p=new f(n*r.nextFloat(),s*r.nextFloat());i.quadTo(a,p)}break}case 2:{for(let o=0;o<e;o++){let a=new f(n*r.nextFloat(),s*r.nextFloat()),p=new f(n*r.nextFloat(),s*r.nextFloat()),c=new f(n*r.nextFloat(),s*r.nextFloat());i.cubicTo(a,p,c)}break}case 3:{for(let o=0;o<e;o++){let a=new f(n*r.nextFloat(),s*r.nextFloat()),p=new f(n*r.nextFloat(),s*r.nextFloat());i.conicTo(a,p,4*r.nextFloat())}break}}return i}function Sn(r,t){let e=r.nextFloatBetween(t.x0,t.x1),n=r.nextFloatBetween(t.y0,t.y1);return new f(e,n)}function ce(r,t,e,n,s){let i=tt.createEmpty(),o=tt.createEmpty();switch(t){case 0:{let c=r.nextIntBetween(3,50),u=r.nextIntBetween(3,50);for(let l=0;l<c;l++)i.addPoint(new f(n*r.nextFloat(),s*r.nextFloat()));for(let l=0;l<u;l++)o.addPoint(new f(n*r.nextFloat()+e,s*r.nextFloat()));break}case 1:{i.addXY(100,100),i.addXY(400,150),i.addXY(450,400),i.addXY(150,450),o.addXY(300+e,300),o.addXY(600+e,350),o.addXY(650+e,600),o.addXY(350+e,650);break}case 2:{i.addXY(100,100),i.addXY(400,100),i.addXY(400,400),i.addXY(100,400),o.addXY(200+e,150),o.addXY(300+e,150),o.addXY(300+e,350),o.addXY(200+e,350);break}case 3:{i.addXY(100,100),i.addXY(150,500),i.addXY(550,500),i.addXY(500,100),o.addXY(250+e,200),o.addXY(450+e,200),o.addXY(400+e,400),o.addXY(200+e,400);break}case 4:{i.addXY(100,100),i.addXY(400,100),i.addXY(400,400),i.addXY(100,400),o.addXY(150,150+e),o.addXY(350,350+e),o.addXY(350,150+e),o.addXY(150,350+e);break}case 5:{i.addXY(100,300),i.addXY(200,250),i.addXY(300,200+.1*e),i.addXY(400,150),i.addXY(510,100),i.addXY(505,300);break}case 6:{i.addXY(100,100),i.addXY(600,400),i.addXY(200,400),i.addXY(300,200),i.addXY(400,300),i.addXY(500,100);break}}return[i,o]}function qi(r,t,e,n,s){let i=tt.createEmpty(),o=t.getCenter(),a=2*Math.PI/e,p=.5*t.dx(),c=.5*t.dy();for(let u=0;u<e;u++){let l=u*a+a*r.nextFloatBetween(0,n),d=r.nextFloatBetween(s,1),m=p*d*Math.sin(l),h=c*d*Math.cos(l);i.addXY(o.x+m,o.y+h)}return i}function Ni(){return 16777215*Math.random()|0}function En(r){switch(r){case"intersection":return 1;case"exclusion":return 2;case"awithoutb":return 3;case"bwithouta":return 4;default:return 0}}function Mn(r){switch(r){case"miter":return 1;case"miterclip":return 2;case"round":return 3;default:return 0}}function Qt(r){switch(r){case"evenodd":return 1;case"positive":return 2;case"negative":return 3;case"absgeqtwo":return t=>Math.abs(t)>2;default:return 0}}function Ma(r){let{canvas:t}=r.readData("app-canvas"),e=t.getContext("2d");e===null&&F("Unable to create app rendering context");let n=new cs(e);r.setPlugin(n)}var cs=class r{context;pluginId="app-context";constructor(t){this.context=t}get canvas(){return this.context.canvas}static fromCanvas(t){let e=t.getContext("2d");if(e!==null)return new r(e)}blitImage(t,e,n){let s=t.toImageData();s!==void 0&&this.context.putImageData(s,e,n)}clear(t="#FFFFFF"){let e=this.context;e.resetTransform(),e.save(),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore()}createLinePattern(t,e="#000000"){let n=new OffscreenCanvas(t,t),s=n.getContext("2d");if(s===null)return null;s.fillStyle=e;for(let i=0;i<t;i++)s.fillRect(i,i,1,1);return this.context.createPattern(n,"repeat")}drawBox(t,e="#000000",n=1){let s=this.context;s.save(),s.lineWidth=n,s.strokeStyle=e,s.strokeRect(t.x0,t.y0,t.x1-t.x0,t.y1-t.y0),s.restore()}drawBoxes(t,e="#000000",n=1){let s=this.context;s.beginPath();for(let i of t)s.rect(i.x0,i.y0,i.x1-i.x0,i.y1-i.y0);s.save(),s.lineWidth=n,s.strokeStyle=e,s.stroke(),s.restore()}drawEdge(t,e="#000000",n=1){let s=this.context;s.beginPath(),s.moveTo(t.p0.x,t.p0.y),s.lineTo(t.p1.x,t.p1.y),s.save(),s.lineJoin="round",s.lineWidth=n,s.strokeStyle=e,s.stroke(),s.restore()}drawEdges(t,e="#000000",n=1){let s=this.context;s.beginPath();for(let i of t)s.moveTo(i.p0.x,i.p0.y),s.lineTo(i.p1.x,i.p1.y);s.save(),s.lineJoin="round",s.lineWidth=n,s.strokeStyle=e,s.stroke(),s.restore()}drawMeshEdges(t,e="#000000",n=1){let s=this.context;s.beginPath();for(let i of t.getEdges())s.moveTo(i.p0.x,i.p0.y),s.lineTo(i.p1.x,i.p1.y);s.save(),s.lineJoin="round",s.strokeStyle=e,s.lineWidth=n,s.stroke(),s.restore()}drawPath(t,e="#000000",n=1){let s=this.context;s.beginPath(),this.addPath(s,t),s.save(),s.lineJoin="round",s.lineCap="round",s.lineWidth=n,s.strokeStyle=e,s.stroke(),s.restore()}drawPolygon(t,e="#000000",n=1){let s=this.context;s.beginPath(),this.addPolygon(s,t),s.save(),s.lineJoin="round",s.lineWidth=n,s.strokeStyle=e,s.stroke(),s.restore()}drawRay(t,e="#000000",n=1){let s=this.context;s.beginPath(),s.moveTo(t.p.x,t.p.y),s.lineTo(t.p.x+t.v.x,t.p.y+t.v.y),s.save(),s.lineJoin="round",s.lineWidth=n,s.strokeStyle=e,s.stroke(),s.restore()}fillBox(t,e="#000000"){let n=this.context;n.save(),n.fillStyle=e,n.fillRect(t.x0,t.y0,t.x1-t.x0,t.y1-t.y0),n.restore()}fillBoxes(t,e="#000000"){let n=this.context;n.beginPath();for(let s of t)n.rect(s.x0,s.y0,s.x1-s.x0,s.y1-s.y0);n.save(),n.fillStyle=e,n.fill(),n.restore()}fillEdgePoints(t,e="#000000",n=1){let s=this.context;s.beginPath();for(let i of t)this.addCircle(s,i.p0,.5*n),this.addCircle(s,i.p1,.5*n);s.save(),s.fillStyle=e,s.fill(),s.restore()}fillMesh(t,e="#000000"){let n=this.context;n.beginPath();for(let s of t.getFaces())this.addMeshFaceToContext(n,s);n.save(),n.fillStyle=e,n.fill(),n.restore()}fillMeshRandom(t,e){let n=this.context;n.save();for(let s of t.getFaces())n.beginPath(),this.addMeshFaceToContext(n,s),n.fillStyle=Pn(e,.25,1,1).style(),n.fill();n.restore()}fillPath(t,e="#000000",n){let s=this.context;s.beginPath(),this.addPath(s,t),s.save(),s.fillStyle=e,s.fill(n),s.restore()}fillPoints(t,e="#000000",n=1){let s=this.context;s.beginPath();for(let i of t)this.addCircle(s,i,.5*n);s.save(),s.fillStyle=e,s.fill(),s.restore()}fillPolygon(t,e="#000000"){let n=this.context;n.beginPath(),this.addPolygon(n,t),n.save(),n.lineJoin="round",n.fillStyle=e,n.fill(),n.restore()}fillText(t,e,n="#000000",s="16px Verdana"){let i=this.context;i.save(),i.font=s,i.fillStyle=n;let o=i.measureText(t),a=e.x-.5*(o.actualBoundingBoxRight+o.actualBoundingBoxLeft),p=e.y-.5*(o.actualBoundingBoxDescent-o.actualBoundingBoxAscent);i.fillText(t,a,p),i.restore()}getSize(t){let e=this.context.canvas;return t?[e.width,e.height]:[1400,700]}resetTransform(){this.context.resetTransform()}resize(t,e){if(t<0||e<0)return;let n=this.context.canvas;n.width=t,n.height=e}setTransform(t){let e=this.context,n=t.elements;e.setTransform(n[0],n[1],n[2],n[3],n[4],n[5])}addCircle(t,e,n){t.moveTo(e.x+n,e.y),t.arcTo(e.x+n,e.y+n,e.x,e.y+n,n),t.arcTo(e.x-n,e.y+n,e.x-n,e.y,n),t.arcTo(e.x-n,e.y-n,e.x,e.y-n,n),t.arcTo(e.x+n,e.y-n,e.x+n,e.y,n),t.closePath()}addMeshFaceToContext(t,e){let n=e.start.p0;t.moveTo(n.x,n.y);for(let s of e.getEdgeIterator())t.lineTo(s.p1.x,s.p1.y);t.closePath()}addPath(t,e){if(!e.isValid())return;let n=e.getCommands(),s=e.getPoints(),i=0,o=0,a=f.createZero();for(;i<n.length;){let p=n[i++];switch(p.type){case 0:{a=s[o++],t.moveTo(a.x,a.y);break}case 1:{let c=s[o++];t.lineTo(c.x,c.y),a=c;break}case 2:{let c=s[o++],u=s[o++];t.quadraticCurveTo(c.x,c.y,u.x,u.y),a=u;break}case 3:{let c=s[o++],u=s[o++],l=s[o++];t.bezierCurveTo(c.x,c.y,u.x,u.y,l.x,l.y),a=l;break}case 4:{let c=s[o++],u=s[o++],l=p.w,d=4/3*(l/(l+1)),m=a.lerp(c,d),h=u.lerp(c,d);t.bezierCurveTo(m.x,m.y,h.x,h.y,u.x,u.y),a=u;break}case 5:{t.closePath();break}default:U(p)}}}addPolygon(t,e){let n=e.points;if(n.length!==0){t.moveTo(n[0].x,n[0].y);for(let s=1;s<n.length;s++)t.lineTo(n[s].x,n[s].y);t.closePath()}}},N=class{moduleId="app-context";setup(t){t.registerPlugin("app-context"),t.addSystem({stage:"start-pre",fn:Ma})}};function us(r){let{inputElements:t,paramsContainer:e}=r.readData("app-input");for(let n of t)n.register(e)}function Ca(r){let{inputElements:t}=r.readData("app-input");for(let e of t)e.unregister()}var Cn=class{moduleId="app-input";setup(t){t.registerData("app-input"),t.addSystem({stage:"start-post",fn:us}),t.addSystem({stage:"stop-pre",fn:Ca})}},In=class{element;events;id;isBound;style;constructor(t,e){t.id=e,this.element=t,this.id=e,this.events=[],this.isBound=!1}addEventListener(t,e){this.isBound?F("Cannot add event listener on bound input element"):this.events.push({type:t,listener:e})}focus(){this.element.focus()}getElement(){return this.element}getId(){return this.id}register(t){if(this.isBound)F("Already bound");else{this.isBound=!0;for(let e of this.events)this.element.addEventListener(e.type,e.listener);this.style!==void 0&&this.element.setAttribute("style",this.style),t.appendChild(this.element),t.append(`
`)}}setStyle(t){this.style=t}unregister(){for(let e of this.events)this.element.removeEventListener(e.type,e.listener);let t=this.element.parentElement;t!==null&&t.removeChild(this.element),this.isBound=!1}},Pe=class extends In{defaultValue;valueInputElement;constructor(t,e,n){super(t,e),t.value=n,this.valueInputElement=t,this.defaultValue=n}getDefaultValue(){return this.defaultValue}getFloat(){return Number.parseFloat(this.getValue())}getInt(){return Number.parseInt(this.getValue())}getValue(){return this.valueInputElement.value}setDefaultValue(t){this.defaultValue=t}setValue(t){this.valueInputElement.value=t}},Gt=class extends In{constructor(t,e){let n=document.createElement("button");n.textContent=e,super(n,t)}},rt=class extends Pe{constructor(t,e=""){let n=document.createElement("input");n.type="text",super(n,t,e)}},B=class extends Pe{constructor(t,e,n,s="0"){let i=document.createElement("input");i.type="range",i.className="slider",i.min=e,i.max=n,super(i,t,s)}},Y=class extends Pe{selectElement;constructor(t,e=""){let n=document.createElement("select");super(n,t,e),this.selectElement=n}setOptionValues(...t){for(let e of t){let n=document.createElement("option");n.text=e,this.selectElement.appendChild(n)}this.selectElement.value=this.getDefaultValue()}};var ls={0:0,1:2,2:1,3:3,4:4},ds={KeyW:0,KeyA:1,KeyS:2,KeyD:3,Space:4,KeyC:5,ShiftLeft:6};function Ia(r){let{keyboardEventHandler:t,mouseEventHandler:e}=r.readData("input-init"),n=[],s=[],i=[],o=[];if(t!==void 0){let c=l=>{n.push({eventId:"input-keyboard-button",type:"keydown",code:l.code,isComposing:l.isComposing,key:l.key,location:l.location,repeat:l.repeat})};t.addEventListener("keydown",c);let u=l=>{n.push({eventId:"input-keyboard-button",type:"keyup",code:l.code,isComposing:l.isComposing,key:l.key,location:l.location,repeat:l.repeat})};t.addEventListener("keyup",u)}if(e!==void 0){let c=d=>{s.push({eventId:"input-mouse-button",type:d.type,button:d.button})};e.addEventListener("mousedown",c),e.addEventListener("mouseup",c);let u=d=>{i.push({eventId:"input-mouse-motion",type:d.type,clientX:d.clientX,clientY:d.clientY,movementX:d.movementX,movementY:d.movementY,offsetX:d.offsetX,offsetY:d.offsetY,pageX:d.pageX,pageY:d.pageY,screenX:d.screenX,screenY:d.screenY})};e.addEventListener("mouseenter",u),e.addEventListener("mouseleave",u),e.addEventListener("mousemove",u),e.addEventListener("mouseout",u),e.addEventListener("mouseover",u);let l=d=>{o.push({eventId:"input-mouse-wheel",type:"wheel",deltaX:d.deltaX,deltaY:d.deltaY,deltaZ:d.deltaZ,deltaMode:d.deltaMode})};e.addEventListener("wheel",l)}r.writeData({dataId:"input-capture",keyboardButtonEvents:n,mouseButtonEvents:s,mouseMotionEvents:i,mouseWheelEvents:o});let a=new ms;a.initialize(),r.setPlugin(a);let p=new hs;p.initialize(),r.setPlugin(p)}function Aa(r){let t=r.readData("input-init"),e=r.readData("input-capture");r.writeEvents(e.keyboardButtonEvents),r.writeEvents(e.mouseButtonEvents),r.writeEvents(e.mouseMotionEvents),r.writeEvents(e.mouseWheelEvents);for(let c of t.receiverIds){let u=r.getChannel(c);u.queueEvents(e.keyboardButtonEvents),u.queueEvents(e.mouseButtonEvents),u.queueEvents(e.mouseMotionEvents),u.queueEvents(e.mouseWheelEvents)}e.keyboardButtonEvents.length=0,e.mouseButtonEvents.length=0,e.mouseMotionEvents.length=0,e.mouseWheelEvents.length=0;let n=r.getPlugin("keyboard"),s=r.readEvents("input-keyboard-button");n.clear(),n.applyEvents(s);let i=r.getPlugin("mouse"),o=r.readEvents("input-mouse-button"),a=r.readEvents("input-mouse-motion"),p=r.readEvents("input-mouse-wheel");i.clear(),i.applyEvents(o,a,p)}var ms=class{states;pluginId="keyboard";constructor(){this.states=new Map}applyEvents(t){for(let e of t){let n=ds[e.code];if(n!==void 0)switch(e.type){case"keydown":{this.press(n);break}case"keyup":{this.release(n);break}default:U(e.type)}}}clear(){for(let t of this.states.values())t.state===3?t.state=0:t.state===1&&(t.state=2)}initialize(){for(let t in ds)this.states.set(ds[t],{code:t,state:0})}isPressed(t){let e=this.states.get(t);return e!==void 0?e.state===1:!1}isPressing(t){let e=this.states.get(t);return e!==void 0?e.state===1||e.state===2:!1}isReleased(t){let e=this.states.get(t);return e!==void 0?e.state===3:!1}press(t){let e=this.states.get(t);e!==void 0&&(e.state===0||e.state===3)&&(e.state=1)}release(t){let e=this.states.get(t);e!==void 0&&(e.state=3)}},hs=class{cursorPosition;states;pluginId="mouse";constructor(){this.cursorPosition={x:-1,y:-1},this.states=new Map}applyEvents(t,e,n){for(let s of t){let i=ls[s.button];if(i!==void 0)switch(s.type){case"mousedown":{this.press(i);break}case"mouseup":{this.release(i);break}}}for(let s of e)this.moveCursorTo({x:s.offsetX,y:s.offsetY})}clear(){for(let t of this.states.values())t.state===3?t.state=0:t.state===1&&(t.state=2)}getCursorPosition(){return this.cursorPosition}initialize(){for(let t in ls)this.states.set(ls[t],{code:t,state:0})}isPressed(t){let e=this.states.get(t);return e!==void 0?e.state===1:!1}isPressing(t){let e=this.states.get(t);return e!==void 0?e.state===1||e.state===2:!1}isReleased(t){let e=this.states.get(t);return e!==void 0?e.state===3:!1}moveCursorTo(t){this.cursorPosition=t}press(t){let e=this.states.get(t);e!==void 0&&(e.state===0||e.state===3)&&(e.state=1)}release(t){let e=this.states.get(t);e!==void 0&&(e.state=3)}},Se=class{moduleId="input-receiver";setup(t){t.registerPlugin("mouse"),t.registerPlugin("keyboard"),t.registerData("input-capture"),t.registerData("input-init"),t.registerEvent("input-keyboard-button"),t.registerEvent("input-mouse-motion"),t.registerEvent("input-mouse-button"),t.registerEvent("input-mouse-wheel"),t.addSystem({stage:"start-post",fn:Ia}),t.addSystem({stage:"update-pre",fn:Aa})}};function Da(r){r.writeData({dataId:"time",delta:0,frame:0,time:0})}function wa(r){let t=r.readData("time-init"),e=r.readEvents("animation-frame");for(let o of t.receiverIds)r.getChannel(o).queueEvents(e);let{delta:n,frame:s,time:i}=r.readData("time");for(let o of e)n=o.time-i,s=s+1,i=o.time;r.writeData({dataId:"time",delta:n,frame:s,time:i})}var Ee=class{moduleId="time";setup(t){t.registerData("time-init"),t.registerData("time"),t.registerEvent("animation-frame"),t.addSystem({stage:"start-post",fn:Da}),t.addSystem({stage:"update-pre",fn:wa})}};function Ui(r){let t=new URLSearchParams(window.location.search),e=document.body,n=bs("div",{id:"params",style:"height: 30px"}),s=bs("div",{id:"canvasContainer",style:"border: 1px solid black; position:absolute; top:40px; right:10px; bottom:10px; left:10px;"});e.appendChild(n),e.appendChild(s);let i=bs("canvas",{id:"canvas2D"});r.writeData({dataId:"app-canvas",canvas:i.transferControlToOffscreen()}),s.appendChild(i),r.writeData({dataId:"app-main",canvas:i,canvasContainer:s,urlSearchParams:t}),r.writeData({dataId:"app-input",paramsContainer:n,inputElements:[]}),r.writeEvent({eventId:"window-resize",width:s.clientWidth,height:s.clientHeight}),window.addEventListener("resize",()=>{let{canvasContainer:o}=r.readData("app-main");r.queueEvent({eventId:"window-resize",width:o.clientWidth,height:o.clientHeight})}),r.writeData({dataId:"time-init",receiverIds:["remote"]}),r.writeData({dataId:"input-init",keyboardEventHandler:self,mouseEventHandler:i,receiverIds:["remote"]})}function ji(r){let t=Ni(),{inputElements:e}=r.readData("app-input"),{appPartIds:n,appPartId:s}=r.readData("app-launcher"),i=new Y("app-main",s);i.setOptionValues(...n),i.addEventListener("input",()=>{window.location.replace(`?app=${i.getValue()}`)}),e.push(i);let o=new Gt("randomize","randomize");o.addEventListener("click",()=>{r.queueEvent({eventId:"app-command",command:"randomize"})}),e.push(o);let a=new rt("seed",t.toString());a.setStyle("width: 80px"),e.push(a);let p=new rt("generator","0");p.setStyle("width: 25px"),e.push(p);let c=new Gt("update","update");c.addEventListener("click",()=>{r.queueEvent({eventId:"app-command",command:"update"})}),e.push(c),r.writeData({dataId:"app-main-input",appComboBox:i,randomizeButton:o,seedTextBox:a,generatorTextBox:p,updateButton:c})}function fs(r){let{generatorTextBox:t,seedTextBox:e}=r.readData("app-main-input");r.writeData({dataId:"app-state",seed:e.getInt(),generator:t.getInt()})}async function Qi(r){let t=r.getChannel("remote"),e=r.readData("app-state");t.queueData(e);let n=r.readData("app-canvas");n.canvas instanceof OffscreenCanvas?t.queueData(n,[n.canvas]):t.queueData(n),await t.runScheduleAsync("start"),requestAnimationFrame(s=>{r.writeEvent({eventId:"animation-frame",time:s}),r.runSchedule("update")})}async function Ta(r){let t=r.getChannel("remote"),e=r.readEvents("window-resize");t.queueEvents(e);let n=r.readData("app-state");t.queueData(n);let s=r.readEvents("app-command");t.queueEvents(s),await t.runScheduleAsync("update"),requestAnimationFrame(i=>{r.writeEvent({eventId:"animation-frame",time:i}),r.runSchedule("update")})}function Oa(r){r.writeData({dataId:"time-init",receiverIds:[]}),r.writeData({dataId:"input-init",keyboardEventHandler:void 0,mouseEventHandler:void 0,receiverIds:[]})}function Ra(r){let t=r.readLatestEvent("window-resize");if(t!==void 0){let{canvas:e}=r.readData("app-canvas");e.width=t.width,e.height=t.height}}function bs(r,t){let e=document.createElement(r);for(let n in t)e.setAttribute(n,t[n]);return e}var k=class{moduleId="app-main-input";setup(t){t.addModules([new Ee,new Se,new Cn]),t.registerData("app-main"),t.registerData("app-main-input"),t.registerData("app-canvas"),t.registerData("app-state"),t.registerEvent("app-command"),t.registerEvent("window-resize"),t.addSystem({stage:"start-pre",fn:Ui}),t.addSystem({stage:"start-pre",fn:ji}),t.addSystem({stage:"start-pre",fn:fs}),t.addSystem({stage:"start-post",fn:Qi}),t.addSystem({stage:"update-pre",fn:fs}),t.addSystem({stage:"update-post",fn:Ta}),t.addDependency({stage:"start-pre",seq:[Ui,ji,fs]}),t.addDependency({stage:"start-post",seq:[us,Qi]})}},L=class{moduleId="app-remote";setup(t){t.addModules([new Ee,new Se]),t.registerData("app-canvas"),t.registerData("app-state"),t.registerEvent("app-command"),t.registerEvent("window-resize"),t.addSystem({stage:"start-pre",fn:Oa}),t.addSystem({stage:"update-pre",fn:Ra})}};var Me=class{branchSize;compareFn;leafSize;root;constructor(t,e,n){this.root=this.leafNodeCreate(void 0,0,[],void 0),this.compareFn=t,this.branchSize=e??16,this.leafSize=n??this.branchSize}add(t){let e=this.findLeafNode(this.root,t);e.length<this.leafSize?this.leafNodeAdd(e,t):this.leafNodeSplitAdd(e,t)}clear(){this.root=this.leafNodeCreate(void 0,0,[],void 0)}*getGenerator(){let t=this.getFirstLeaf();for(;;){for(let e=0;e<t.length;e++)yield t.values[e];if(t.next!==void 0)t=t.next;else return}}getRootNode(){return this.root}toArray(){let t=[];for(let e of this.getGenerator())t.push(e);return t}validate(t){let n=this.getGenerator().next();if(n.done===!0)return!0;let s=n.value;for(let o of this.getGenerator()){if(t(s,o)>0)return!1;s=o}return i(this.root,this.branchSize,this.leafSize);function i(o,a,p){let c=!0;if(o.type===0){c&&=o.length<=a;for(let u of o.children)c&&=i(u,a,p)}else c&&=o.length<=p;return c}}findLeafNode(t,e){if(t.type===0){let n=this.findNearestIndexEnd(t.keys,e);return this.findLeafNode(t.children[n],e)}else return t}findNearestIndexEnd(t,e,n=0){let s=this.compareFn,i=n,o=t.length;for(;i<o;){let a=i+o>>>1;s(e,t[a])<0?o=a:i=a+1}return i}getFirstLeaf(){let t=this.root;for(;t.type!==1;)t=t.children[0];return t}internalNodeAdd(t,e,n,s){let i=this.findNearestIndexEnd(t.keys,n);e.parent=t,t.keys.splice(i,0,s),t.children.splice(i+1,0,e),t.length+=1}internalNodeCreate(t,e,n,s){return{type:0,parent:t,length:e,keys:n,children:s}}internalNodeSplitAdd(t,e,n){let s=this.findNearestIndexEnd(t.keys,n);t.keys.splice(s,0,n);let i=t.length+2>>>1,o=s<i-1,a=o?i-1:i,[p]=t.keys.splice(i-1,1),c=t.length-a,u=t.keys.splice(i-1,c),l=t.children.splice(a,c),d=this.internalNodeCreate(t.parent,c,u,l);for(let m of l)m.parent=d;t.length=a,o?(e.parent=t,t.children.splice(s+1,0,e),t.length+=1):(e.parent=d,d.children.splice(s+1-a,0,e),d.length+=1),this.nodeAddToParent(t,d,n,p)}leafNodeAdd(t,e){let n=this.findNearestIndexEnd(t.values,e);t.values.splice(n,0,e),t.length+=1}leafNodeCreate(t,e,n,s){return{type:1,parent:t,length:e,values:n,next:s}}leafNodeSplitAdd(t,e){let n=t.length>>>1,s=this.compareFn(e,t.values[n])<0,i=s?n:n+1,o=t.length-i,a=t.values.splice(i,o),p=this.leafNodeCreate(t.parent,o,a,t.next);t.length=i,t.next=p,this.leafNodeAdd(s?t:p,e),this.nodeAddToParent(t,p,t.values[0],p.values[0])}nodeAddToParent(t,e,n,s){let i=t.parent;i!==void 0?i.length<this.branchSize?this.internalNodeAdd(i,e,n,s):this.internalNodeSplitAdd(i,e,s):this.nodeAddToRoot(t,e,s)}nodeAddToRoot(t,e,n){let s=this.internalNodeCreate(void 0,2,[n],[t,e]);t.parent=s,e.parent=s,this.root=s}};function Gi(r){let{inputElements:t}=r.readData("app-input"),e=new rt("branchsize","4");e.setStyle("width: 40px"),t.push(e);let n=new rt("leafsize","16");n.setStyle("width: 40px"),t.push(n);let s=new B("count","0","128","32");s.setStyle("width: 200px"),t.push(s),r.writeData({dataId:"app-part-main",inputBranchSize:e,inputLeafSize:n,inputCount:s})}function Wa(r){let t=(e,n)=>Math.floor(e)-Math.floor(n);r.writeData({dataId:"app-part-remote",bplusTree:new Me(t)})}function gs(r){let{inputBranchSize:t,inputCount:e,inputLeafSize:n}=r.readData("app-part-main"),s={dataId:"app-part-state",count:e.getInt(),branchSize:t.getInt(),leafSize:n.getInt()};r.writeData(s),r.getChannel("remote").queueData(s)}function Yi(r){let{branchSize:t,count:e,leafSize:n}=r.readData("app-part-state"),{seed:s}=r.readData("app-state"),i=q.fromSeedLcg(s),o=(p,c)=>Math.floor(p)-Math.floor(c),a=new Me(o,t,n);for(let p=1;p<=e;p++){let c=i.nextIntBetween(0,10)+.003*p;a.add(c)}x.assertFn(()=>a.validate(o),"Validation failed"),r.writeData({dataId:"app-part-remote",bplusTree:a})}function Xi(r){let{bplusTree:t}=r.readData("app-part-remote"),e=r.getPlugin("app-context");e.clear();let n=26*2.5,s=26,i=20,o=10;a(t.getRootNode(),0,0);function a(c,u,l){let d=l;if(c.type===0){p(c.keys,u,d,"#FF8888");for(let m of c.children)d=a(m,u+1,d+1)}else p(c.values,u,d,"#8888FF");return d}function p(c,u,l,d){let m=u;for(let h of c){let g=i+m*(n+o),y=i+l*(s+o),v=Q.fromXYWH(g,y,n,s);e.fillBox(v,d),e.fillText(h.toFixed(3),v.getCenter(),"#FFFFFF"),m++}}}var ys=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Gi,gs]}),t.addSystems({stage:"update",fns:[gs]}),t.addDependency({stage:"start",seq:[Gi,gs]})}},vs=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Wa]}),t.addSystems({stage:"update",fns:[Yi,Xi]}),t.addDependency({stage:"update",seq:[Yi,Xi]})}},Zi={id:"main",modules:[new k,new ys],schedules:T},Hi={id:"remote",modules:[new L,new vs],schedules:T};function Ki(r){let{inputElements:t}=r.readData("app-input"),e=new B("count","0","1000","10");e.setStyle("width: 200px"),t.push(e);let n=new Gt("save","save");n.addEventListener("click",()=>r.queueEvent({eventId:"app-part-command",command:"save"})),t.push(n);let s=new Gt("load","load");s.addEventListener("click",()=>r.queueEvent({eventId:"app-part-command",command:"load"})),t.push(s),r.writeData({dataId:"app-part-main",inputCount:e,inputSave:n,inputLoad:s})}function za(r){let{seed:t}=r.readData("app-state");r.writeData({dataId:"app-part-remote",count:0,json:void 0,random:q.fromSeedLcg(t)})}function xs(r){let e={dataId:"app-part-state",count:r.readData("app-part-main").inputCount.getInt()};r.writeData(e),r.getChannel("remote").queueData(e)}function Ps(r){let t=r.readData("app-part-remote"),e=r.readData("app-part-state"),n=r.getPlugin("app-context"),{random:s}=t,i=t.count,o=e.count;if(i<=o)for(let a=i;a<o;a++){let p=s.nextFloat()<.8?"rectangle":"circle",c=s.nextFloatBetween(10,100),u=s.nextFloat()<.5?"red":"blue",l=new f(s.nextFloatBetween(0,n.canvas.width),s.nextFloatBetween(0,n.canvas.height)),d=new E(s.nextFloatBetween(-1,1),s.nextFloatBetween(-1,1));r.createEntity(void 0,{componentId:p},{componentId:"object",size:c,color:u,position:l,velocity:d})}else{let a=r.queryEntities(["object"]),p=o;for(;a.next();){let c=a.getEntityId();p<i&&(r.destroyEntity(c),p+=1)}}t.count=o}function $i(r){let{delta:t}=r.readData("time"),e=r.getPlugin("app-context"),{width:n,height:s}=e.canvas,i=r.queryEntities(["object"]);for(;i.next();){let o=i.getEntityId(),a=r.getComponent(o,"object");if(a===void 0)continue;let p=a.position,c=a.velocity,u=.5*a.size,l=c.x,d=c.y,m=p.x+t*l,h=p.y+t*d;m>n-u?(m=n-u,l=-l):m<u&&(m=u,l=-l),h>s-u?(h=s-u,d=-d):h<u&&(h=u,d=-d),a.position=new f(m,h),a.velocity=new E(l,d),r.updateComponent(o,"object")}}function Ji(r){let t=r.readData("app-part-remote"),e=r.readEvents("app-part-command");for(let n of e)switch(n.command){case"save":{console.time("saveEntities"),t.json=r.saveEntities(),console.timeEnd("saveEntities"),x.info("World saved ({} bytes)",t.json.length);break}case"load":{if(t.json===void 0)break;console.time("loadEntities"),r.loadEntities(t.json),console.timeEnd("loadEntities"),x.info("World loaded ({} bytes)",t.json.length);break}}}function Ss(r){r.getPlugin("app-context").clear()}function _i(r){let t=r.getPlugin("app-context"),e=r.queryEntities(["circle","object"]),n=w.createEmpty(),s=w.createEmpty();for(;e.next();){let i=e.getEntityId(),o=r.getComponent(i,"object");if(o===void 0)continue;let a=o.position,p=o.size,c=o.color;c==="red"?n.addCircle(a,.5*p):c==="blue"&&s.addCircle(a,.5*p)}t.fillPath(n,"red"),t.fillPath(s,"blue")}function tr(r){let t=r.getPlugin("app-context"),e=r.queryEntities(["rectangle","object"]),n=w.createEmpty(),s=w.createEmpty();for(;e.next();){let i=e.getEntityId(),o=r.getComponent(i,"object");if(o===void 0)continue;let a=o.position,p=o.size,c=o.color,u=a.x-.5*p,l=a.y-.5*p,d=a.x+.5*p,m=a.y+.5*p;c==="red"?n.addRectXY(u,l,d,m):c==="blue"&&s.addRectXY(u,l,d,m)}t.fillPath(n,"red"),t.fillPath(s,"blue")}function er(r){let t=0,e=0;for(let n of r.getEntitiesChanged())r.hasChangeFlag(n,"object",1)&&(t+=1),r.hasChangeFlag(n,"object",4)&&(e+=1);(t>0||e>0)&&x.info("created = {}, deleted = {}",t,e)}var Es=class{moduleId="main";setup(t){t.registerData("app-part-state"),t.registerData("app-part-main"),t.registerEvent("app-part-command"),t.addSystem({stage:"start",fn:Ki}),t.addSystem({stage:"start",fn:xs}),t.addSystem({stage:"update",fn:xs}),t.addDependency({stage:"start",seq:[Ki,xs]})}},Ms=class{moduleId="remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.registerEvent("app-part-command"),t.registerSerializable(E),t.registerSerializable(f),t.addSystem({stage:"start",fn:za}),t.addSystems({stage:"update",fns:[Ps,$i,Ji,Ss,_i,tr,er]}),t.addDependency({stage:"update",seq:[Ji,Ps,$i,Ss]}),t.addDependency({stage:"update",seq:[Ss,tr,_i]}),t.addDependency({stage:"update",seq:[Ps,er]})}},nr={id:"main",modules:[new k,new Es],schedules:T},sr={id:"remote",modules:[new L,new Ms],schedules:T};var An=class{moduleId="gpu";setup(t){t.registerData("gpu-init"),t.registerData("gpu"),t.addSystem({stage:"start-post",fn:Cs,awaitMode:"dependency"})}};async function Cs(r){let{gpu:t,requestAdapterOptions:e,deviceDescriptor:n,context:s}=r.readData("gpu-init");le(t!==void 0,"No GPU found");let i=await t.requestAdapter(e);le(i!==null,"Unable to request GPU adapter");let o=await i.requestDevice(n);r.writeData({dataId:"gpu",gpu:t,adapter:i,device:o,context:s})}function Is(r,t,e){if(t.type==="number"){let n=t.array,s=r.createBuffer({size:4*n.length,usage:e,mappedAtCreation:!0}),i=s.getMappedRange(),o=new Float32Array(i);for(let a=0;a<o.length;a++)o[a]=n[a];return s.unmap(),s}else{let n=t.array,s=r.createBuffer({size:n.BYTES_PER_ELEMENT*n.length,usage:e|GPUBufferUsage.COPY_DST});return r.queue.writeBuffer(s,0,n.buffer),s}}function Ba(r){let t=new As;r.setPlugin(t)}var As=class{pluginId="asset";meshes;materials;constructor(){this.meshes=new Dn,this.materials=new Dn}},Dn=class{id;entries;constructor(){this.entries=new Map,this.id=0}add(t){let e=this.createNewId();return this.entries.set(e,t),e}remove(t){return this.entries.delete(t)}createNewId(){let t=this.id;return this.id+=1,t}},wn=class{moduleId="asset";setup(t){t.registerPlugin("asset"),t.addSystem({stage:"start-pre",fn:Ba})}};function Ds(r){for(let t of r.getEntitiesChanged()){let e=r.getComponent(t,"camera");if(e===void 0)continue;let n=r.getComponent(t,"computed-transform");if(n!==void 0){let s=n.global.inverse();e.viewProjection.copyFromMat4A(s),e.viewProjection.mulSet(e.projection,e.viewProjection)}else e.viewProjection.copyFromMat4(e.projection)}}var ir=`struct VertexIn {
    @location(0) position: vec3f,
};

struct TransformIn {
    @location(1) col0: vec3f,
    @location(2) col1: vec3f,
    @location(3) col2: vec3f,
    @location(4) col3: vec3f,
};

struct VertexOut {
    @builtin(position) position: vec4f,
};

struct FragmentOut {
    @location(0) color: vec4f,
};

@group(0) @binding(0)
var<uniform> viewProjection: mat4x4f;

@group(1) @binding(0)
var<uniform> color: vec4f;

@vertex
fn vertex_main(vtxIn: VertexIn, matIn: TransformIn) -> VertexOut {
    var objectPos = vec4f(vtxIn.position, 1.0);
    var world = mat4x3f(matIn.col0, matIn.col1, matIn.col2, matIn.col3);
    var worldPos = vec4f(world * objectPos, 1.0);

    var vtxOut: VertexOut;
    vtxOut.position = viewProjection * worldPos;

    return vtxOut;
}

@fragment
fn fragment_main() -> FragmentOut {
    var out: FragmentOut;
    out.color = color;
    return out;
}
`;function ws(r){let t=[],e=r.createHierarchySelector();for(let n of r.getEntitiesChanged()){if(r.getComponent(n,"transform")===void 0)continue;let i=r.getComponent(n,"computed-transform");i===void 0&&(i={componentId:"computed-transform",global:bn.createIdentity(),visible:0},r.setComponent(n,i)),e.select(n),t.push({entityId:n,depth:e.getDepth()}),rr(r,e,t)}t.sort((n,s)=>n.depth-s.depth);for(let n of t){let s=r.getComponent(n.entityId,"transform"),i=r.getComponent(n.entityId,"computed-transform");if(s===void 0||i===void 0)continue;e.select(n.entityId);let o=e.getParent();if(o!==void 0){let u=r.getComponent(o,"computed-transform");if(u===void 0)continue;i.global.copyFromMat4A(u.global),s.visible===0?i.visible=u.visible:i.visible=s.visible}else i.global.set(1,0,0,0,1,0,0,0,1,0,0,0),i.visible=s.visible;let a=s.translation;a.isZero()||i.global.translatePre(a.x,a.y,a.z);let p=s.rotation;p.isIdentity()||i.global.rotatePre(p.a,p.b,p.c,p.d);let c=s.scale;c.isOne()||i.global.scalePre(c.x,c.y,c.z),r.updateComponent(n.entityId,"computed-transform")}}function rr(r,t,e){let n=t.getChildren();if(n!==void 0)for(let s of n)r.getComponent(s,"transform")!==void 0&&e.push({entityId:s,depth:t.getDepth()}),t.select(s),rr(r,t,e)}var ka=5e4,Tn=class{moduleId="mesh-render";setup(t){t.addModules([new wn]),t.registerData("mesh-render-state"),t.registerData("scene"),t.addSystem({stage:"start-post",fn:or}),t.addSystem({stage:"update-post",fn:ws}),t.addSystem({stage:"update-post",fn:Ds}),t.addSystem({stage:"update-post",fn:ar}),t.addDependency({stage:"start-post",seq:[Cs,or]}),t.addDependency({stage:"update-post",seq:[ws,Ds,ar]})}};function or(r){let{context:t,device:e,gpu:n}=r.readData("gpu"),{canvas:s}=t,i=new Map,o=new Map,a=n.getPreferredCanvasFormat(),p=La(e,a),c=qa(e,p),u=e.createTexture({size:[s.width,s.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});r.writeData({dataId:"mesh-render-state",depthTexture:u,entries:i,materialEntries:o,pipeline:c,pipelineContext:p})}function ar(r){let t=r.readData("gpu"),e=r.readData("mesh-render-state"),n=r.getPlugin("asset");for(let m of r.getEntitiesChanged()){let h=r.getComponent(m,"mesh"),g=r.getComponent(m,"material"),y=r.getComponent(m,"computed-transform"),v=e.entries.get(m);h!==void 0&&g!==void 0&&y!==void 0?(v===void 0&&(v=ja(t.device,e,n,m,h,g)),Ga(e,v,y)):v!==void 0&&Qa(e,v)}let i=[{view:t.context.getCurrentTexture().createView(),clearValue:{r:1,g:1,b:1,a:1},loadOp:"clear",storeOp:"store"}],o={view:e.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},a=r.readData("scene"),p=r.getComponent(a.mainCamera,"camera");if(p===void 0){x.warn("No camera found");return}let c=Va(t.device,e.pipelineContext,p.viewProjection),u=t.device.createCommandEncoder(),l=u.beginRenderPass({colorAttachments:i,depthStencilAttachment:o});l.setPipeline(e.pipeline),l.setBindGroup(0,c);for(let m of e.materialEntries.values()){l.setBindGroup(1,m.bindGroup1);for(let h of m.meshEntries.values())h.needsUpdate&&(t.device.queue.writeBuffer(h.transformsBuffer,0,h.transformsBufferStaging.array,0,h.instances.length*12),h.needsUpdate=!1),l.setVertexBuffer(0,h.positionsBuffer),l.setVertexBuffer(1,h.transformsBuffer),l.draw(h.positionsCount,h.instances.length,0,0)}l.end();let d=u.finish();t.device.queue.submit([d])}function La(r,t){let e=r.createShaderModule({code:ir}),n={module:e,entryPoint:"vertex_main",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:12,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:0,format:"float32x3"},{shaderLocation:2,offset:12,format:"float32x3"},{shaderLocation:3,offset:24,format:"float32x3"},{shaderLocation:4,offset:36,format:"float32x3"}],arrayStride:48,stepMode:"instance"}]},s={module:e,entryPoint:"fragment_main",targets:[{format:t}]},o=[{entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}]},{entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}].map(p=>r.createBindGroupLayout(p)),a=r.createPipelineLayout({bindGroupLayouts:o});return{vertexState:n,fragmentState:s,bindGroupLayouts:o,pipelineLayout:a}}function Va(r,t,e){return r.createBindGroup({entries:[{binding:0,resource:{buffer:Ua(r,e)}}],layout:t.bindGroupLayouts[0]})}function qa(r,t){let e={vertex:t.vertexState,fragment:t.fragmentState,primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},layout:t.pipelineLayout};return r.createRenderPipeline(e)}function Na(r,t){let e=r.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0}),n=e.getMappedRange(),s=new Float32Array(n);return s[0]=t.r,s[1]=t.g,s[2]=t.b,s[3]=t.a,e.unmap(),e}function Ua(r,t){let e=r.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0}),n=e.getMappedRange();return new Float32Array(n).set(t.elements),e.unmap(),e}function ja(r,t,e,n,s,i){let o=t.materialEntries.get(i.handle);if(o===void 0){let u=e.materials.entries.get(i.handle);D(u!==void 0);let l=Na(r,u.color);o={bindGroup1:r.createBindGroup({entries:[{binding:0,resource:{buffer:l}}],layout:t.pipelineContext.bindGroupLayouts[1]}),colorBuffer:l,meshEntries:new Map},t.materialEntries.set(i.handle,o)}let a=o.meshEntries.get(s.handle);if(a===void 0){let u=e.meshes.entries.get(s.handle);D(u!==void 0);let l={type:"float32",array:new Float32Array(12*ka)};a={instances:[],transformsBufferStaging:l,transformsBuffer:Is(r,l,GPUBufferUsage.VERTEX),positionsBuffer:Is(r,u.vertices,GPUBufferUsage.VERTEX),positionsCount:u.vertices.array.length/3,needsUpdate:!0},o.meshEntries.set(s.handle,a)}let p=a.instances.length;a.instances.push(n);let c={entity:n,instanceIdx:p,materialId:i.handle,meshId:s.handle};return t.entries.set(n,c),c}function Qa(r,t){let e=r.materialEntries.get(t.materialId);D(e!==void 0);let n=e.meshEntries.get(t.meshId);D(n!==void 0);let s=n.instances.pop();D(s!==void 0);let i=n.instances.length,o=t.instanceIdx;if(o<i){let a=n.transformsBufferStaging.array,p=12*i,c=12*o;a.copyWithin(c,p,12),n.instances[o]=s}}function Ga(r,t,e){let n=r.materialEntries.get(t.materialId);D(n!==void 0);let s=n.meshEntries.get(t.meshId);D(s!==void 0);let i=s.transformsBufferStaging.array,o=e.global.elements,a=12*t.instanceIdx;i.set(o,a),s.needsUpdate=!0}function pr(r){let{inputElements:t}=r.readData("app-input"),e=new B("fov","30","150","65");e.setStyle("width: 200px"),t.push(e);let n=new B("count","0","1000000","15000");n.setStyle("width: 200px"),t.push(n);let s=new Y("transform","none");s.setOptionValues("none","rotate"),t.push(s),r.writeData({dataId:"app-part-main",inputCount:n,inputFOV:e,inputTransform:s})}function cr(r){let{canvas:t}=r.readData("app-canvas"),{seed:e}=r.readData("app-state"),n=t.getContext("webgpu");n===null&&F("Unable to create WebGPU rendering context"),r.writeData({dataId:"gpu-init",alphaMode:"premultiplied",context:n,deviceDescriptor:void 0,gpu:navigator.gpu,requestAdapterOptions:void 0}),r.writeData({dataId:"app-part-remote",count:0,random:q.fromSeedLcg(e),materialHandles:[],meshHandles:[],parentEntity:void 0});let s=r.createEntity(void 0,{componentId:"camera",projection:Pt.createIdentity(),viewProjection:Pt.createIdentity()},{componentId:"transform",scale:X.createOne(),rotation:lt.createIdentity(),translation:new I(0,0,15),visible:0});r.writeData({dataId:"scene",mainCamera:s})}function Ts(r){let t=r.readData("app-part-main"),e={dataId:"app-part-state",count:t.inputCount.getInt(),fov:t.inputFOV.getInt(),transform:t.inputTransform.getValue()};r.writeData(e),r.getChannel("remote").queueData(e)}function ur(r){let{context:t,device:e,gpu:n}=r.readData("gpu"),{transform:s}=r.readData("app-part-state"),{time:i}=r.readData("time"),{parentEntity:o}=r.readData("app-part-remote"),a=r.readLatestEvent("window-resize");if(a!==void 0){let{alphaMode:p}=r.readData("gpu-init");t.configure({alphaMode:p,device:e,format:n.getPreferredCanvasFormat()});let c=r.readData("mesh-render-state");c.depthTexture=e.createTexture({size:[a.width,a.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}if(s==="rotate"&&o!==void 0){let p=.25*i/180,c=r.getComponent(o,"transform");c!==void 0&&(c.rotation=lt.fromRotationAngleY(p),r.updateComponent(o,"transform"))}}function lr(r){let t=r.readData("app-part-remote"),e=r.getPlugin("asset"),{random:n}=t;for(let o=0;o<25;o++){let a=e.materials.add({color:Pn(n,.5,1,1)});t.materialHandles.push(a)}let s=[-1,-1,1,1,-1,1,1,1,1,-1,-1,1,1,1,1,-1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,1,1,-1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,1,1,1,1,-1,-1,1,-1,1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,-1,-1],i=e.meshes.add({vertices:{type:"number",array:s}});t.parentEntity=r.createEntity(void 0,{componentId:"transform",rotation:lt.createIdentity(),scale:X.createOne(),translation:I.createZero(),visible:0}),t.meshHandles.push(i)}function dr(r){let t=r.readData("app-part-remote"),e=r.readData("app-part-state"),n=t.count,s=e.count,i=Math.abs(n-s),o=Math.min(i,2500);if(n<s){let{random:a,materialHandles:p,meshHandles:c,parentEntity:u}=t;for(let l=0;l<o;l++)r.createEntity(u,{componentId:"test"},{componentId:"mesh",handle:c[l%c.length]},{componentId:"material",handle:p[l%p.length]},{componentId:"transform",scale:new X(a.nextFloatBetween(2**-8,2**-6),a.nextFloatBetween(2**-8,2**-6),a.nextFloatBetween(2**-8,2**-6)),rotation:lt.fromRotationEuler(a.nextFloatBetween(0,2*Math.PI),a.nextFloatBetween(0,2*Math.PI),a.nextFloatBetween(0,2*Math.PI),0),translation:new I(a.nextFloatBetween(-5,5),a.nextFloatBetween(-5,5),a.nextFloatBetween(-5,5)),visible:0});t.count+=o}if(n>s){let a=r.queryEntities(["test"]),p=0;for(;a.next();){let c=a.getEntityId();p<o&&(r.destroyEntity(c),p+=1)}t.count-=o}}function mr(r){let{fov:t}=r.readData("app-part-state"),{mainCamera:e}=r.readData("scene"),{context:n}=r.readData("gpu"),{delta:s}=r.readData("time"),i=r.getPlugin("keyboard"),o=r.getPlugin("mouse"),a=r.getComponent(e,"camera"),p=r.getComponent(e,"transform");if(a===void 0||p===void 0)return;let c=p.rotation,u=p.translation;if(o.isPressing(2)){let M=0,S=0;for(let z of r.readEvents("input-mouse-motion"))M-=z.movementX,S-=z.movementY;let C=1/250;c.rotateXPre(C*S),c.rotateY(C*M),c=c.unit()}let l=.005,d=0,m=0,h=0;i.isPressing(0)&&(h-=1),i.isPressing(2)&&(h+=1),i.isPressing(1)&&(d-=1),i.isPressing(3)&&(d+=1),i.isPressing(5)&&(m-=1),i.isPressing(4)&&(m+=1),i.isPressing(6)&&(l*=3);let g=new X(d,m,h);g.isZero()||(g=g.unitOrZero().mulS(s*l),g=c.mulV(g),u=u.addV(g)),p.rotation=c,p.translation=u,r.updateComponent(e,"transform");let y=t*(Math.PI/180),v=n.canvas.width/n.canvas.height,P=Pt.fromPerspective(y,v,.1,100);a.projection=P}var Os=class{moduleId="main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystem({stage:"start",fn:pr}),t.addSystem({stage:"start",fn:Ts}),t.addSystem({stage:"update",fn:Ts}),t.addDependency({stage:"start",seq:[pr,Ts]})}},Rs=class{moduleId="remote";setup(t){t.addModules([new An,new Tn]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystem({stage:"start",fn:cr}),t.addSystem({stage:"start",fn:lr}),t.addSystem({stage:"update",fn:mr}),t.addSystem({stage:"update",fn:ur}),t.addSystem({stage:"update",fn:dr}),t.addDependency({stage:"start",seq:[cr,lr]}),t.addDependency({stage:"update",seq:[mr,ur,dr]})}},hr={id:"main",modules:[new k,new Os],schedules:T},fr={id:"remote",modules:[new L,new Rs],schedules:T};var On=class{buffer;sa;sb;sg;sr;mask;operator;constructor(){this.mask=new Uint8Array,this.operator=this.sourceOverSolid,this.sb=0,this.sg=0,this.sr=0,this.sa=0,this.buffer=new Uint8Array}fill(){let t=this.buffer,e=0;for(;e<t.length;)t[e++]=this.sr,t[e++]=this.sg,t[e++]=this.sb,t[e++]=this.sa}initialize(t){this.buffer=t.getBuffer8(),this.mask=new Uint8Array(t.getWidth())}setColor(t){this.sr=ue(t.r,t.a),this.sg=ue(t.g,t.a),this.sb=ue(t.b,t.a),this.sa=t.a}setOperation(t){switch(t){case 0:{this.operator=this.sourceSolid;break}default:{this.operator=this.sourceOverSolid;break}}}sourceOverSolid(t,e,n){let s=this.buffer,i=e,o=4*(t+i);for(;i<n;){let a=this.mask[i],p=ue(this.sa,a);s[o]=Yt(this.sr,a,s[o++],p),s[o]=Yt(this.sg,a,s[o++],p),s[o]=Yt(this.sb,a,s[o++],p),s[o]=Yt(this.sa,a,s[o++],p),this.mask[i++]=0}}sourceSolid(t,e,n){let s=this.buffer,i=e,o=4*(t+i);for(;i<n;){let a=this.mask[i];s[o]=Yt(this.sr,a,s[o++],a),s[o]=Yt(this.sg,a,s[o++],a),s[o]=Yt(this.sb,a,s[o++],a),s[o]=Yt(this.sa,a,s[o++],a),this.mask[i++]=0}}};function Yt(r,t,e,n){return ue(r,t)+ue(e,Xa(n))}function ue(r,t){let e=r*t+128;return e+(e>>>8)>>>8}function Xa(r){return 255-r}var Ce=8,Rn=class{activeEdges;compositor;edges;height;mask;width;constructor(t){this.height=0,this.width=0,this.compositor=t,this.mask=t.mask,this.edges=[],this.activeEdges=[]}addLine(t,e,n,s){D(t>=0,"Coordinate must not be NaN"),D(e>=0,"Coordinate must not be NaN"),D(n<=this.width,"Coordinate must not be NaN"),D(s<=this.height,"Coordinate must not be NaN");let i=e*256>>>0,o=s*256>>>0;if(i===o)return;let a=t*256>>>0,p=n*256>>>0;i<o?this.edges.push(new Wn(a,i,p,o,1)):this.edges.push(new Wn(p,o,a,i,-1))}initialize(t,e){this.width=t,this.height=e,this.mask=this.compositor.mask}render(t){let e=t===0?4294967295:1;this.quicksort(0,this.edges.length-1);let n=this.edges[0],s=1,i=n.y0>>>Ce;for(;i<this.height;){let o=i<<Ce;for(;s<=this.edges.length&&n.y0<=o;){let a=n.x1-n.x0,p=n.y1-n.y0,c=1;a<0&&(a=-a,c=-1),this.activeEdges.push({x0:n.x0>>>Ce,y1:n.y1,m0:a<<Ce,d0:p<<Ce,d:(o-n.y0)*a,inc:c,sign:n.sign}),n=this.edges[s++]}for(let a=0;a<this.activeEdges.length;a++)this.activeEdges[a].y1<=o&&(this.activeEdges.splice(a,1),a--);for(let a=0;a<this.activeEdges.length;a++){let p=this.activeEdges[a];for(;p.d>=p.d0;)p.d-=p.d0,p.x0+=p.inc;p.d+=p.m0}if(this.activeEdges.length>0){for(let p=1;p<this.activeEdges.length;p++){let c=this.activeEdges[p],u=p;for(;u>0&&this.activeEdges[u-1].x0>c.x0;)this.activeEdges[u]=this.activeEdges[u-1],u--;this.activeEdges[u]=c}let a=0;for(let p=1;p<this.activeEdges.length;p++){let c=this.activeEdges[p-1],u=this.activeEdges[p-0];if(a+=c.sign,a&e)for(let l=c.x0;l<u.x0;l++)this.mask[l]=255}this.compositor.operator(this.width*i,this.activeEdges[0].x0,this.activeEdges[this.activeEdges.length-1].x0)}i++}this.edges=[],this.activeEdges=[]}setCompositor(t){this.compositor=t,this.mask=t.mask}quicksort(t,e){let n=this.edges,s=n[t+e>>>1],i=t,o=e;for(;i<=o;){for(;n[i].y0<s.y0;)i++;for(;n[o].y0>s.y0;)o--;if(i<=o){let a=n[i];n[i]=n[o],n[o]=a,i++,o--}}t<o&&this.quicksort(t,o),i<e&&this.quicksort(i,e)}},Wn=class{sign;x0;x1;y0;y1;constructor(t,e,n,s,i){this.x0=t,this.y0=e,this.x1=n,this.y1=s,this.sign=i}};var Fn=class{clipRect;compositor;pathFlatten;pathStroke;rasterizer;constructor(){this.compositor=new On,this.rasterizer=new Rn(this.compositor),this.clipRect=new kn(0,0,0,0),this.pathFlatten=mn(H),this.pathStroke=hn(H)}addFill(t,e){let n=this.rentPath();n.copyFrom(t),n.transform(e),this.flatten(n),this.returnPath(n)}addStroke(t,e,n){let s=this.rentPath();if(n.transformOrder===0){let i=this.rentPath();i.copyFrom(t),i.transform(e),this.pathStroke.process(i,s,n),this.returnPath(i)}else this.pathStroke.process(t,s,n),s.transform(e);this.flatten(s),this.returnPath(s)}begin(t){let e=t.getWidth(),n=t.getWidth();this.clipRect=new kn(0,n,e,0),this.compositor.initialize(t),this.rasterizer.initialize(e,n)}clear(t){this.compositor.setColor(t.color),this.compositor.fill()}end(){}renderFill(t){this.compositor.setColor(t.color),this.compositor.setOperation(t.compOp),this.rasterizer.render(t.rule)}renderStroke(t){this.compositor.setColor(t.color),this.compositor.setOperation(t.compOp),this.rasterizer.render(0)}rentPath(){return w.createEmpty()}returnPath(t){}clipPolyline(t,e){let n=this.rasterizer,s=t[0],i=j(s.y,e.bottom,e.top),o=i,a=i,p=t.length;for(let c=1;c<p;c++){let u=s;s=t[c];let l=u,d=s;if(l.x<e.left){if(d.x<e.left)continue;l=Bn(u,s,e.left),i=j(l.y,e.bottom,e.top),n.addLine(e.left,o,e.left,i)}else d.x<e.left&&(d=Bn(u,s,e.left),o=j(d.y,e.bottom,e.top));if(l.x>e.right){if(d.x>e.right)continue;l=Bn(u,s,e.right),i=j(l.y,e.bottom,e.top),n.addLine(e.right,a,e.right,i)}else d.x>e.right&&(d=Bn(u,s,e.right),a=j(d.y,e.bottom,e.top));if(l.y<e.bottom){if(d.y<e.bottom)continue;l=zn(u,s,e.bottom)}else d.y<e.bottom&&(d=zn(u,s,e.bottom));if(l.y>e.top){if(d.y>e.top)continue;l=zn(u,s,e.top)}else d.y>e.top&&(d=zn(u,s,e.top));n.addLine(l.x,l.y,d.x,d.y)}s.x>e.right?(i=j(s.y,e.bottom,e.top),n.addLine(e.right,a,e.right,i)):s.x<e.left&&(i=j(s.y,e.bottom,e.top),n.addLine(e.left,o,e.left,i))}flatten(t){let e=w.createEmpty();this.pathFlatten.process(t,e,!0),this.clipPolyline(e.getPoints(),this.clipRect)}},kn=class{bottom;left;right;top;constructor(t,e,n,s){this.left=t,this.top=e,this.right=n,this.bottom=s}};function zn(r,t,e){return new f(r.x+(t.x-r.x)*(e-r.y)/(t.y-r.y),e)}function Bn(r,t,e){return new f(e,r.y+(t.y-r.y)*(e-r.x)/(t.x-r.x))}var Za={color:new ht(0,0,0,255),compOp:1,rule:0},Ha={caps:ge,color:new ht(0,0,0,255),compOp:1,dashArray:[],dashCaps:ge,dashOffset:0,join:1,miterLimit:4,transformOrder:1,width:1},Ln=class{fillOptions;pipeline;strokeOptions;transform;constructor(){this.fillOptions={...Za},this.strokeOptions={...Ha},this.pipeline=new Fn,this.transform=Jt.createIdentity()}get caps(){return this.strokeOptions.caps}set caps(t){this.strokeOptions.caps=t}get dashArray(){return this.strokeOptions.dashArray}set dashArray(t){this.strokeOptions.dashArray=t}get dashCaps(){return this.strokeOptions.dashCaps}set dashCaps(t){this.strokeOptions.dashCaps=t}get dashOffset(){return this.strokeOptions.dashOffset}set dashOffset(t){this.strokeOptions.dashOffset=t}get fillColor(){return this.fillOptions.color}set fillColor(t){this.fillOptions.color=t}get fillCompOp(){return this.fillOptions.compOp}set fillCompOp(t){this.fillOptions.compOp=t}get fillRule(){return this.fillOptions.rule}set fillRule(t){this.fillOptions.rule=t}get join(){return this.strokeOptions.join}set join(t){this.strokeOptions.join=t}get miterLimit(){return this.strokeOptions.miterLimit}set miterLimit(t){this.strokeOptions.miterLimit=t}get strokeColor(){return this.strokeOptions.color}set strokeColor(t){this.strokeOptions.color=t}get strokeCompOp(){return this.strokeOptions.compOp}set strokeCompOp(t){this.strokeOptions.compOp=t}get strokeWidth(){return this.strokeOptions.width}set strokeWidth(t){this.strokeOptions.width=t}get transformOrder(){return this.strokeOptions.transformOrder}set transformOrder(t){this.strokeOptions.transformOrder=t}begin(t){this.pipeline.begin(t)}clear(){this.pipeline.clear(this.fillOptions)}end(){this.pipeline.end()}fillCircle(t,e,n){let s=this.rentPath();s.addCircleXY(t,e,n),this.fillPath(s),this.returnPath(s)}fillEllipse(t,e,n,s){let i=this.rentPath();i.addEllipseXY(t,e,n,s),this.fillPath(i),this.returnPath(i)}fillPath(t){this.pipeline.addFill(t,this.transform),this.pipeline.renderFill(this.fillOptions)}fillRect(t,e,n,s){let i=this.rentPath();i.addRectXY(t,e,n,s),this.fillPath(i),this.returnPath(i)}rentPath(){return this.pipeline.rentPath()}returnPath(t){this.pipeline.returnPath(t)}strokeCircle(t,e,n){let s=this.rentPath();s.addCircleXY(t,e,n),this.strokePath(s),this.returnPath(s)}strokeEllipse(t,e,n,s){let i=this.rentPath();i.addEllipseXY(t,e,n,s),this.strokePath(i),this.returnPath(i)}strokeLine(t,e,n,s){let i=this.rentPath();i.addLineXY(t,e,n,s),this.strokePath(i),this.returnPath(i)}strokePath(t){this.pipeline.addStroke(t,this.transform,this.strokeOptions),this.pipeline.renderStroke(this.strokeOptions)}strokeRect(t,e,n,s){let i=this.rentPath();i.addRectXY(t,e,n,s),this.strokePath(i),this.returnPath(i)}};var Et=class r{buffer;height;width;constructor(t,e,n){this.width=t,this.height=e,this.buffer=n??new ArrayBuffer(4*t*e)}fill(t){new Int32Array(this.buffer).fill(t)}getBuffer8(){let t=4*this.width*this.height;return new Uint8Array(this.buffer,0,t)}getHeight(){return this.height}getWidth(){return this.width}magnify(t){let e=new r(this.width*t,this.height*t),n=this.width*this.height,s=n*t*t,i=new Int32Array(this.buffer,0,n),o=new Int32Array(e.buffer,0,s),a=0;for(let p=0;p<this.height;p++)for(let c=0;c<t;c++){let u=p*this.width;for(let l=0;l<this.width;l++){let d=i[u++];for(let m=0;m<t;m++)o[a++]=d}}return e}resize(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.buffer=new ArrayBuffer(4*t*e))}toImageData(){if(this.width!==0&&this.height!==0){let t=4*this.width*this.height,e=new Uint8ClampedArray(this.buffer,0,t);return new ImageData(e,this.width,this.height)}else return}};function gr(r){let{inputElements:t}=r.readData("app-input"),e=new rt("count","10");e.setStyle("width: 80px"),t.push(e);let n=new B("size","1","1024","200");n.setStyle("width: 200px"),t.push(n);let s=new B("color","0","255","128");s.setStyle("width: 200px"),t.push(s),r.writeData({dataId:"app-part-main",inputCount:e,inputSize:n,inputColor:s})}function Ka(r){r.writeData({dataId:"app-part-remote",image:new Et(0,0)})}function Ws(r){let{inputCount:t,inputSize:e,inputColor:n}=r.readData("app-part-main"),s={dataId:"app-part-state",count:t.getInt(),size:e.getInt(),color:n.getInt()};r.writeData(s),r.getChannel("remote").queueData(s)}function yr(r){let{image:t}=r.readData("app-part-remote"),{count:e,size:n,color:s}=r.readData("app-part-state"),{seed:i,generator:o}=r.readData("app-state"),a=q.fromSeedLcg(i),p=pe(a,o,e,n,n);p.close(),t.resize(n,n);let c=new Ln;c.begin(t),c.fillRule=1,c.fillColor=new ht(224,224,224,255),c.clear(),c.fillColor=new ht(s,0,0,255),c.fillPath(p)}function vr(r){let{image:t}=r.readData("app-part-remote"),e=r.getPlugin("app-context");e.clear(),e.blitImage(t,0,0)}var zs=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[gr,Ws]}),t.addSystems({stage:"update",fns:[Ws]}),t.addDependency({stage:"start",seq:[gr,Ws]})}},Bs=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Ka]}),t.addSystems({stage:"update",fns:[yr,vr]}),t.addDependency({stage:"update",seq:[yr,vr]})}},xr={id:"main",modules:[new k,new zs],schedules:T},Pr={id:"remote",modules:[new L,new Bs],schedules:T};function Sr(r){let{inputElements:t}=r.readData("app-input"),e=new rt("count","10");e.setStyle("width: 80px"),t.push(e);let n=new B("rotation","0","360","0");n.setStyle("width: 200px"),t.push(n);let s=new Y("projection","orthographic");s.setOptionValues("orthographic","perspective"),t.push(s),r.writeData({dataId:"app-part-main",inputCount:e,inputRotation:n,inputProjection:s})}function $a(r){r.writeData({dataId:"app-part-remote",edges:[]})}function Fs(r){let{inputCount:t,inputRotation:e,inputProjection:n}=r.readData("app-part-main"),s={dataId:"app-part-state",count:t.getInt(),projection:n.getValue(),rotation:e.getInt()};r.writeData(s),r.getChannel("remote").queueData(s)}function Er(r){let{projection:t,rotation:e}=r.readData("app-part-state"),n=r.getPlugin("app-context"),[s,i]=n.getSize(!0),o=Ja(),a;t==="orthographic"?a=Pt.fromOrthographicFrustum(-2.5,2.5,-2.5,2.5,1,10):a=Pt.fromPerspectiveFrustum(-.5,.5,-.5,.5,1,10);let p=.5*s,c=.5*i,u=.5*Math.min(s,i);a.scale(u,u,u),a.translate(p,c,0);let l=e*Math.PI/180,d=lt.fromRotationEuler(1.1*l,1.3*l,1.7*l,0),m=Pt.createIdentity();m.rotate(d.a,d.b,d.c,d.d),m.translate(0,0,-5),m.mulSet(a,m),r.writeData({dataId:"app-part-remote",edges:_a(o,m)})}function Mr(r){let{edges:t}=r.readData("app-part-remote"),e=r.getPlugin("app-context");e.clear(),e.drawEdges(t,"#000000")}function Ja(){let r=new I(1,1,1),t=new I(1,1,-1),e=new I(1,-1,1),n=new I(1,-1,-1),s=new I(-1,1,1),i=new I(-1,1,-1),o=new I(-1,-1,1),a=new I(-1,-1,-1);return[new at(r,t),new at(e,n),new at(s,i),new at(o,a),new at(r,e),new at(t,n),new at(s,o),new at(i,a),new at(r,s),new at(t,i),new at(e,o),new at(n,a)]}function _a(r,t){let e=[];for(let n of r){let s=t.mulP(n.p0),i=t.mulP(n.p1),o=f.fromObject(s),a=f.fromObject(i);e.push(new O(o,a))}return e}var ks=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Sr,Fs]}),t.addSystems({stage:"update",fns:[Fs]}),t.addDependency({stage:"start",seq:[Sr,Fs]})}},Ls=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[$a]}),t.addSystems({stage:"update",fns:[Er,Mr]}),t.addDependency({stage:"update",seq:[Er,Mr]})}},Cr={id:"main",modules:[new k,new ks],schedules:T},Ir={id:"remote",modules:[new L,new Ls],schedules:T};function Ar(r){let{inputElements:t}=r.readData("app-input"),e=new B("count","0","50","1");e.setStyle("width: 200px"),t.push(e),r.writeData({dataId:"app-part-main",inputCount:e})}function tp(r){r.writeData({dataId:"app-part-remote",mesh:K.createEmpty(),points:[]})}function Vs(r){let{inputCount:t}=r.readData("app-part-main"),e={dataId:"app-part-state",count:t.getInt()};r.writeData(e),r.getChannel("remote").queueData(e)}function Dr(r){let{count:t}=r.readData("app-part-state"),{seed:e}=r.readData("app-state"),n=r.getPlugin("app-context"),s=q.fromSeedLcg(e),[i,o]=n.getSize(!1),a=new Q(0,0,i,o),p=Sn(s,a),c=Sn(s,a),u=Sn(s,a),l=[];l.push(p,c,u);let d=w.createEmpty();d.moveTo(p),d.lineTo(c),d.lineTo(u),d.close();let m=K.createEmpty(),h=new mt(H);h.addPath(d),h.process(m,xt);for(let g=0;g<t;g++){let y=p.lerp(c,s.nextFloat()),v=c.lerp(u,s.nextFloat()),P=y.lerp(v,s.nextFloat());m.triangulateAddPoint(P),l.push(P)}m.triangulateOptimize(),m.validate(),r.writeData({dataId:"app-part-remote",mesh:m,points:l})}function wr(r){let{mesh:t,points:e}=r.readData("app-part-remote"),{seed:n}=r.readData("app-state"),s=r.getPlugin("app-context"),i=q.fromSeedLcg(n);s.clear(),s.fillMeshRandom(t,i),s.drawMeshEdges(t,"#666666",.5),s.fillPoints(e,"#000000",5)}var qs=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Ar,Vs]}),t.addSystems({stage:"update",fns:[Vs]}),t.addDependency({stage:"start",seq:[Ar,Vs]})}},Ns=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[tp]}),t.addSystems({stage:"update",fns:[Dr,wr]}),t.addDependency({stage:"update",seq:[Dr,wr]})}},Tr={id:"main",modules:[new k,new qs],schedules:T},Or={id:"remote",modules:[new L,new Ns],schedules:T};function Rr(r){let{inputElements:t}=r.readData("app-input"),e=new rt("count","100");e.setStyle("width: 80px"),t.push(e),r.writeData({dataId:"app-part-main",inputCount:e})}function ep(r){r.writeData({dataId:"app-part-remote",bounds:Q.createEmpty(),input:w.createEmpty(),isInside:!1})}function Us(r){let{inputCount:t}=r.readData("app-part-main"),e={dataId:"app-part-state",count:t.getInt()};r.writeData(e),r.getChannel("remote").queueData(e)}function Wr(r){let{count:t}=r.readData("app-part-state"),{seed:e,generator:n}=r.readData("app-state"),s=r.getPlugin("app-context"),i=r.getPlugin("mouse"),o=q.fromSeedLcg(e),[a,p]=s.getSize(!1),c=pe(o,n,t,a,p);c.close();let u=f.fromObject(i.getCursorPosition());r.writeData({dataId:"app-part-remote",input:c,bounds:c.getBounds(),isInside:c.hasPointInside(u,1)})}function zr(r){let{bounds:t,input:e,isInside:n}=r.readData("app-part-remote"),s=r.getPlugin("app-context");s.clear(),s.fillBox(t,"#ADD8E644"),s.fillPath(e,n?"#FFCCCC":"#CCCCCC","evenodd"),s.drawPath(e,"#666666"),s.fillPoints(e.getPoints(),"#000000",5)}var js=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Rr,Us]}),t.addSystems({stage:"update",fns:[Us]}),t.addDependency({stage:"start",seq:[Rr,Us]})}},Qs=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[ep]}),t.addSystems({stage:"update",fns:[Wr,zr]}),t.addDependency({stage:"update",seq:[Wr,zr]})}},Br={id:"main",modules:[new k,new js],schedules:T},Fr={id:"remote",modules:[new L,new Qs],schedules:T};function kr(r){let{inputElements:t}=r.readData("app-input"),e=new B("parameter","0","200","100");e.setStyle("width: 200px"),t.push(e);let n=new Y("boolOp","union");n.setOptionValues("union","intersection","exclusion","awithoutb","bwithouta"),t.push(n);let s=new Y("windA","nonzero");s.setOptionValues("nonzero","evenodd","positive","negative","absgeqtwo"),t.push(s);let i=new Y("windB","nonzero");i.setOptionValues("nonzero","evenodd","positive","negative","absgeqtwo"),t.push(i),r.writeData({dataId:"app-part-main",inputParameter:e,inputBoolOp:n,inputWindA:s,inputWindB:i})}function np(r){r.writeData({dataId:"app-part-remote",polygonA:tt.createEmpty(),polygonB:tt.createEmpty(),chains:w.createEmpty(),faces:w.createEmpty()})}function Gs(r){let{inputParameter:t,inputBoolOp:e,inputWindA:n,inputWindB:s}=r.readData("app-part-main"),i={dataId:"app-part-state",parameter:t.getInt(),boolOp:e.getValue(),windA:n.getValue(),windB:s.getValue()};r.writeData(i),r.getChannel("remote").queueData(i)}function Lr(r){let{parameter:t,boolOp:e,windA:n,windB:s}=r.readData("app-part-state"),{seed:i,generator:o}=r.readData("app-state"),a=r.getPlugin("app-context"),p=2*(t-100),c=q.fromSeedLcg(i),[u,l]=a.getSize(!1),[d,m]=ce(c,o,p,u,l),h=new mt(H);for(let y of d.getEdges())h.addEdge(y,0);for(let y of m.getEdges())h.addEdge(y,1);let g=K.createEmpty();h.process(g,{booleanOperator:En(e),windingOperatorA:Qt(n),windingOperatorB:Qt(s)}),r.writeData({dataId:"app-part-remote",chains:g.getChainsPath(),faces:g.getFacesPath(),polygonA:d,polygonB:m})}function Vr(r){let{polygonA:t,polygonB:e,chains:n,faces:s}=r.readData("app-part-remote"),i=r.getPlugin("app-context");i.clear(),i.fillPolygon(t,"#00FF0022"),i.fillPolygon(e,"#0000FF22");let o=i.createLinePattern(6,"#FF0000")??"#FF000022";i.fillPath(s,o),i.drawPath(s,"#FF3333",1.5),i.drawPath(n,"#3333FF",1.5)}var Ys=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[kr,Gs]}),t.addSystems({stage:"update",fns:[Gs]}),t.addDependency({stage:"start",seq:[kr,Gs]})}},Xs=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[np]}),t.addSystems({stage:"update",fns:[Lr,Vr]}),t.addDependency({stage:"update",seq:[Lr,Vr]})}},qr={id:"main",modules:[new k,new Ys],schedules:T},Nr={id:"remote",modules:[new L,new Xs],schedules:T};function Ur(r){let{inputElements:t}=r.readData("app-input"),e=new B("parameter","0","200","100");e.setStyle("width: 200px"),t.push(e),r.writeData({dataId:"app-part-main",inputParameter:e})}function sp(r){r.writeData({dataId:"app-part-remote",path:w.createEmpty(),points:[]})}function Zs(r){let{inputParameter:t}=r.readData("app-part-main"),e={dataId:"app-part-state",parameter:t.getInt()};r.writeData(e),r.getChannel("remote").queueData(e)}function jr(r){let{parameter:t}=r.readData("app-part-state"),e=new W(new f(100,150),new f(300,400),new f(600,250)),n=new W(new f(100,500),new f(300,100),new f(500,100+3*t)),s=[],i=w.createEmpty();e.intersectQuad(n,s),i.addCurveSplines(e),i.addCurveSplines(n),r.writeData({dataId:"app-part-remote",path:i,points:s})}function Qr(r){let{path:t,points:e}=r.readData("app-part-remote"),n=r.getPlugin("app-context");n.clear(),n.drawPath(t),n.fillPoints(e,"#FF0000",5)}var Hs=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Ur,Zs]}),t.addSystems({stage:"update",fns:[Zs]}),t.addDependency({stage:"start",seq:[Ur,Zs]})}},Ks=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[sp]}),t.addSystems({stage:"update",fns:[jr,Qr]}),t.addDependency({stage:"update",seq:[jr,Qr]})}},Gr={id:"main",modules:[new k,new Hs],schedules:T},Yr={id:"remote",modules:[new L,new Ks],schedules:T};function Xr(r){let{inputElements:t}=r.readData("app-input"),e=new rt("count","10");e.setStyle("width: 80px"),t.push(e);let n=new Y("op","flatten");n.setOptionValues("flatten","simplify","offset","dash","stroke","dashstroke"),t.push(n);let s=new B("param1","0","100","50");s.setStyle("width: 200px"),t.push(s);let i=new B("param2","0","100","50");i.setStyle("width: 200px"),t.push(i);let o=new Y("join","bevel");o.setOptionValues("bevel","miter","miterclip","round"),t.push(o),r.writeData({dataId:"app-part-main",inputCount:e,inputOp:n,inputParam1:s,inputParam2:i,inputJoin:o})}function ip(r){r.writeData({dataId:"app-part-remote",input:w.createEmpty(),output:w.createEmpty()})}function $s(r){let{inputCount:t,inputOp:e,inputParam1:n,inputParam2:s,inputJoin:i}=r.readData("app-part-main"),o={dataId:"app-part-state",count:t.getInt(),op:e.getValue(),param1:n.getInt(),param2:s.getInt(),join:i.getValue()};r.writeData(o),r.getChannel("remote").queueData(o)}function Zr(r){let{count:t,op:e,param1:n,param2:s,join:i}=r.readData("app-part-state"),{seed:o,generator:a}=r.readData("app-state"),p=r.getPlugin("app-context"),c=q.fromSeedLcg(o),[u,l]=p.getSize(!1),d=pe(c,a,t,u,l),m;switch(e){case"flatten":{m=d.flatten(!1,{flattenTolerance:(10*s+1)/10,simplifyTolerance:(10*n+1)/10});break}case"simplify":{m=d.simplify({simplifyTolerance:(10*n+1)/10});break}case"offset":{m=d.offset({distance:n-50,join:Mn(i),miterLimit:s/10});break}case"dash":{m=d.dash({array:[2*n,n],offset:10*s});break}case"stroke":{m=d.stroke({caps:ns,join:Mn(i),miterLimit:s/10,width:n});break}case"dashstroke":{m=d.stroke({caps:ns,dashArray:[2*n,n],dashOffset:10*s,join:Mn(i),width:50});break}default:m=w.createEmpty()}r.writeData({dataId:"app-part-remote",input:d,output:m})}function Hr(r){let{input:t,output:e}=r.readData("app-part-remote"),n=r.getPlugin("app-context");n.clear(),n.drawPath(t,"#666666FF",1),n.drawPath(e,"#FF0000FF",2),n.fillPoints(t.getPoints(),"#00000088",5),n.fillPoints(e.getPoints(),"#FF000088",5)}var Js=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Xr,$s]}),t.addSystems({stage:"update",fns:[$s]}),t.addDependency({stage:"start",seq:[Xr,$s]})}},_s=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[ip]}),t.addSystems({stage:"update",fns:[Zr,Hr]}),t.addDependency({stage:"update",seq:[Zr,Hr]})}},Kr={id:"main",modules:[new k,new Js],schedules:T},$r={id:"remote",modules:[new L,new _s],schedules:T};var Vn=class r{map;constructor(){this.map=new Map}collectData(t){let e={tag:[],refs:[]},n={tag:[],refs:[]};for(let[s,i]of this.map.entries()){let o=i.w0+i.w1,a=i.w1,[p,c]=xe(o,a,t);p&&(e.tag.push(s),e.refs.push(...i.refs)),c&&(n.tag.push(s),n.refs.push(...i.refs))}return e.tag.sort(r.compareTag),n.tag.sort(r.compareTag),[e,n]}getEntry(t){let e=this.map.get(t);if(e!==void 0)return e;{let n={w0:0,w1:0,refs:[]};return this.map.set(t,n),n}}reset(){this.map.clear()}static compareTag(t,e){return t-e}};var qn=class r{flattenTolerance;snapRound;status;windingOperator;constructor(t){this.status=new kt(St.compareStatus),this.snapRound=new jt,this.snapRound.precision=t.clipPrecision,this.flattenTolerance=t.flattenTolerance,this.windingOperator=xt.windingOperatorA}addCurve(t,e=0,n=1,s=!1,i){this.snapRound.addSegment(t,e,n,s,i)}addEdge(t,e=0,n=1,s=!1,i){this.snapRound.addSegment(t.toBezier(),e,n,s,i)}addPath(t,e=0,n=1,s=!1){let i=t.flatten(!1,{flattenMode:1,flattenTolerance:this.flattenTolerance});for(let o of i.getCurveIterator())this.snapRound.addSegment(o,e,n,s,void 0)}process(t,e){this.windingOperator=e,this.status.clear();let n=yn(this.snapRound),s=new Vn;for(let i of n)if(i.left)this.status.insert(i);else{let o=this.status.findIndexBy(u=>u.seg===i.seg);if(o<0){x.error("PathOverlay2: Status event segment {} not found",i.seg);continue}let a=this.status.getAt(o);this.setState(a,s);let[p,c]=s.collectData(this.windingOperator);if(s.reset(),!_t(p.tag,c.tag)){let u=new R(a.p1,a.p0),l=new R(a.p0,a.p1);this.addSegmentPair(t,u,l,p,c)}this.status.removeAt(o)}this.snapRound.clear()}setQualityOptions(t){this.snapRound.precision=t.clipPrecision}static isOpen(t,e){return t.p0.eq(e.p0)&&t!==e}addSegmentPair(t,e,n,s,i){let o=t.createEdge(e,n),a=o.sym;o.data=s,a.data=i;let p=t.getChains();for(let l of p)if(r.isOpen(l.head.sym,o)){this.connectSegmentPair(t,l.head.sym,o,a,s,i);break}else if(r.isOpen(o,l.tail)){this.connectSegmentPair(t,l.tail,o,a,s,i);break}for(let l of p)if(r.isOpen(l.head.sym,a)){this.connectSegmentPair(t,l.head.sym,a,o,i,s);break}else if(r.isOpen(a,l.tail)){this.connectSegmentPair(t,l.tail,a,o,i,s);break}let c=o.chain,u=a.chain;if(c===void 0){let l=t.createChain(o,o);l.data=s.tag,dt.updateEdgeChains(l,l)}else c.isClosed()&&t.finalizeChain(c);if(u===void 0){let l=t.createChain(a,a);l.data=i.tag,dt.updateEdgeChains(l,l)}else u.isClosed()&&t.finalizeChain(u)}connectSegmentPair(t,e,n,s,i,o){let a=A.findConnectingEdge(n,e.vector()),p=A.findConnectingEdge(e,n.vector());A.splice(a,p);let c=n.lprev.chain,u=s.lnext.chain;if(c===void 0||u===void 0){x.error("PathOverlay: No chain");return}if(c===u){x.error("PathOverlay: Chain would need splitting");return}let l=c.data,d=u.data;if(_t(l,i.tag)){if(n.chain===void 0)n.chain=c,c.head=n;else if(n.chain!==c){dt.updateEdgeChains(c,n.chain),n.chain.tail=c.tail;let m=t.destroyChain(c);D(m,"Unable to destroy chain")}}if(_t(d,o.tag)){if(s.chain===void 0)s.chain=u,u.tail=s;else if(s.chain!==u){dt.updateEdgeChains(u,s.chain),s.chain.head=u.head;let m=t.destroyChain(u);D(m,"Unable to destroy chain")}}}setState(t,e){if(t.wind===0)return;let n=!1;for(let s=this.status.size()-1;s>=0;s--){let i=this.status.getAt(s),o=i.seg.ref,a=e.getEntry(o.set);if(i.eq(t))a.w0-=i.wind,a.refs.push(o),i.wind=0,n=!0;else if(!n)a.w1-=i.wind;else break}}};function Jr(r){let{inputElements:t}=r.readData("app-input"),e=new B("parameter","0","200","100");e.setStyle("width: 200px"),t.push(e);let n=new Y("wind","nonzero");n.setOptionValues("nonzero","evenodd","positive","negative","absgeqtwo"),t.push(n),r.writeData({dataId:"app-part-main",inputParameter:e,inputWind:n})}function rp(r){r.writeData({dataId:"app-part-remote",polygonA:tt.createEmpty(),polygonB:tt.createEmpty(),mesh:K.createEmpty(),tagEntries:[]})}function ti(r){let{inputParameter:t,inputWind:e}=r.readData("app-part-main"),n={dataId:"app-part-state",parameter:t.getInt(),wind:e.getValue()};r.writeData(n),r.getChannel("remote").queueData(n)}function _r(r){let{parameter:t,wind:e}=r.readData("app-part-state"),{seed:n,generator:s}=r.readData("app-state"),i=r.getPlugin("app-context"),o=2*(t-100),a=q.fromSeedLcg(n),[p,c]=i.getSize(!1),[u,l]=ce(a,s,o,p,c),d=new qn(H);for(let g of u.getEdges())d.addEdge(g,0);for(let g of l.getEdges())d.addEdge(g,1);d.addEdge(O.fromXY(325,175,350,175),2),d.addEdge(O.fromXY(350,175,350,225),2),d.addEdge(O.fromXY(350,225,325,225),2),d.addEdge(O.fromXY(325,225,325,175),2),d.addEdge(O.fromXY(300,275,375,275),3),d.addEdge(O.fromXY(375,275,375,325),3),d.addEdge(O.fromXY(375,325,300,325),3),d.addEdge(O.fromXY(300,325,300,275),3);let m=K.createEmpty();d.process(m,Qt(e));let h=op(m);r.writeData({dataId:"app-part-remote",polygonA:u,polygonB:l,mesh:m,tagEntries:h})}function to(r){let{mesh:t,tagEntries:e}=r.readData("app-part-remote"),n=r.getPlugin("app-context");n.clear();let s=[],i=1/e.length;for(let o=0;o<1;o+=i){let a=ht.fromHSV(o,.25,1,1);s.push(a.style())}for(let o of t.getFaces()){let a=o.data;if(a.length===0)continue;let p=w.createEmpty();o.writeToPath(p);let c=e.findIndex(u=>_t(u.tag,a));c<0||n.fillPath(p,s[c])}n.drawMeshEdges(t,"#888888",.5)}function op(r){let t=[];for(let e of r.getFaces()){D(e.data!==void 0,"Face data must not be undefined");let n=e.data,s=t.find(i=>_t(i.tag,n));s!==void 0?s.faces.push(e):t.push({tag:n,faces:[e]})}for(let e of t)e.tag.length>0&&r.monotonizeFaces(e.faces);return t}var ei=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Jr,ti]}),t.addSystems({stage:"update",fns:[ti]}),t.addDependency({stage:"start",seq:[Jr,ti]})}},ni=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[rp]}),t.addSystems({stage:"update",fns:[_r,to]}),t.addDependency({stage:"update",seq:[_r,to]})}},eo={id:"main",modules:[new k,new ei],schedules:T},no={id:"remote",modules:[new L,new ni],schedules:T};function so(r){let{inputElements:t}=r.readData("app-input"),e=new B("param1","1","100","50");e.setStyle("width: 200px"),t.push(e);let n=new B("param2","1","100","50");n.setStyle("width: 200px"),t.push(n),r.writeData({dataId:"app-part-main",inputParam1:e,inputParam2:n})}function ap(r){r.writeData({dataId:"app-part-remote"})}function si(r){let{inputParam1:t,inputParam2:e}=r.readData("app-part-main"),n={dataId:"app-part-state",param1:t.getInt(),param2:e.getInt()};r.writeData(n),r.getChannel("remote").queueData(n)}function io(r){let{param1:t,param2:e}=r.readData("app-part-state"),{seed:n}=r.readData("app-state"),s=q.fromSeedLcg(n);x.infoDebug("param1 = {}, param2 = {}, random = {}",t,e,s.nextInt()),r.writeData({dataId:"app-part-remote"})}function ro(r){r.getPlugin("app-context").clear()}var ii=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[so,si]}),t.addSystems({stage:"update",fns:[si]}),t.addDependency({stage:"start",seq:[so,si]})}},ri=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[ap]}),t.addSystems({stage:"update",fns:[io,ro]}),t.addDependency({stage:"update",seq:[io,ro]})}},oo={id:"main",modules:[new k,new ii],schedules:T},ao={id:"remote",modules:[new L,new ri],schedules:T};var pp=[0,1,1,7,1,19,21,127,1,259,261,1807,273,4915,5461,32767,1,65539,65541,458767,65553,1245235,1376341,8323327,65793,16974595,17106181,118427407,17895697,322122547];function po(r){let{inputElements:t}=r.readData("app-input"),e=new B("size","16","1024","512");e.setStyle("width: 200px"),t.push(e);let n=new B("count","0","16","8");n.setStyle("width: 200px"),t.push(n);let s=new Y("format","none");s.setOptionValues("none","u8","u16","u32","f32"),t.push(s),r.writeData({dataId:"app-part-main",inputSize:e,inputCount:n,inputFormat:s})}function cp(r){r.writeData({dataId:"app-part-remote",boxes:[],image:new Et(0,0)})}function oi(r){let{inputSize:t,inputCount:e,inputFormat:n}=r.readData("app-part-main"),s={dataId:"app-part-state",size:t.getInt(),count:e.getInt(),format:n.getValue()};r.writeData(s),r.getChannel("remote").queueData(s)}function co(r){let{size:t,count:e,format:n}=r.readData("app-part-state"),{seed:s,generator:i}=r.readData("app-state"),o=2**e,a=q.fromSeedLcg(s),p=[];switch(i){case 0:{mp(a,o,p);break}case 1:{lp(a,o,p);break}case 2:{dp(a,o,p);break}}let c=[],u=new Et(0,0);switch(n){case"none":{c=up(p,t,t/256);break}case"u8":{u=Nn(p,"u8");break}case"u16":{u=Nn(p,"u16");break}case"u32":{u=Nn(p,"u32");break}case"f32":{u=Nn(p,"f32");break}}r.writeData({dataId:"app-part-remote",boxes:c,image:u})}function uo(r){let{boxes:t,image:e}=r.readData("app-part-remote"),{size:n}=r.readData("app-part-state"),s=r.getPlugin("app-context"),i=e.getWidth(),o=Math.trunc(n/i);o=j(o,1,128);let a=e.magnify(o);s.clear(),s.blitImage(a,0,0),s.fillBoxes(t,"#000000")}function up(r,t,e){let n=[];for(let s=0;s<r.length;s+=2){let i=t*r[s+0],o=t*r[s+1],a=new Q(i-e,o-e,i+e,o+e);n.push(a)}return n}function Nn(r,t){switch(t){case"u8":{let e=Un(r.length,4),n=new Uint8Array(4*e*e);for(let s=0;s<r.length;s++)n[s]=256*r[s];return new Et(e,e,n.buffer)}case"u16":{let e=Un(r.length,2),n=new Uint16Array(2*e*e);for(let s=0;s<r.length;s++)n[s]=65536*r[s];return new Et(e,e,n.buffer)}case"u32":{let e=Un(r.length,1),n=new Uint32Array(e*e);for(let s=0;s<r.length;s++)n[s]=4294967296*r[s];return new Et(e,e,n.buffer)}case"f32":{let e=Un(r.length,1),n=new Float32Array(e*e);for(let s=0;s<r.length;s++)n[s]=r[s];return new Et(e,e,n.buffer)}default:U(t)}}function lo(r,t,e,n,s){let i=t+r.nextFloat(),o=e+r.nextFloat();s.push(i/n),s.push(o/n)}function Un(r,t){let e=Math.sqrt(r/t);return Math.ceil(e)}function lp(r,t,e){let n=Math.sqrt(t),s=1/Math.ceil(n);for(let i=0;i<1;i+=s)for(let o=0;o<1;o+=s){let a=s*r.nextFloat(),p=s*r.nextFloat();e.push(o+a),e.push(i+p)}}function dp(r,t,e){let n=0,s=0,i=1;lo(r,n,s,i,e);for(let o=0,a=1;a<t;o++,a=i){i=2*a;for(let p=0;p<a;p++){let c=2*(p^0),u=2*(p^pp[o]);n=i*e[c+0]^1,s=i*e[u+1]^1,lo(r,n,s,i,e)}}}function mp(r,t,e){for(let n=0;n<t;n++){let s=r.nextFloat(),i=r.nextFloat();e.push(s),e.push(i)}}var ai=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[po,oi]}),t.addSystems({stage:"update",fns:[oi]}),t.addDependency({stage:"start",seq:[po,oi]})}},pi=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[cp]}),t.addSystems({stage:"update",fns:[co,uo]}),t.addDependency({stage:"update",seq:[co,uo]})}},mo={id:"main",modules:[new k,new ai],schedules:T},ho={id:"remote",modules:[new L,new pi],schedules:T};function fo(r){let{inputElements:t}=r.readData("app-input"),e=new B("parameter","1","200","50");e.setStyle("width: 200px"),t.push(e),r.writeData({dataId:"app-part-main",inputParameter:e})}function hp(r){r.writeData({dataId:"app-part-remote",inputSegments:[],outputSegments:[],intersections:[],magnets:[],pins:[],errors:[]})}function ci(r){let{inputParameter:t}=r.readData("app-part-main"),e={dataId:"app-part-state",parameter:t.getInt()};r.writeData(e),r.getChannel("remote").queueData(e)}function bo(r){let{parameter:t}=r.readData("app-part-state"),{seed:e,generator:n}=r.readData("app-state"),s=r.getPlugin("app-context"),i=t,o=1/i,a=new jt;a.precision=o;let[p,c]=s.getSize(!1);fp(n,e,a,o,p,c);let u=performance.now();a.process();let l=performance.now();x.info("Snap round time: {} ms",(l-u).toFixed(1));let d=xo(a.debugGetInputSegments(),i),m=xo(a.debugGetOutputSegments(),i),h=li(a.debugGetIntersections(),i),g=vo(a.debugGetMagnets(),i),y=li(a.debugGetPins(),i),v=vo(li(a.debugGetErrors(),1),i);x.info("Got {} input edges",d.length),x.info("Found {} intersections, {} magnets and {} pins",h.length,g.length,y.length),x.info("Created {} output edges",m.length),v.length>0&&x.error("*** {} errors ***",v.length),r.writeData({dataId:"app-part-remote",inputSegments:d,outputSegments:m,intersections:h,magnets:g,pins:y,errors:v})}function go(r){let{errors:t,inputSegments:e,intersections:n,magnets:s,outputSegments:i,pins:o}=r.readData("app-part-remote"),{parameter:a}=r.readData("app-part-state"),p=r.getPlugin("app-context");p.clear(),p.fillBoxes(s,"#E4E4E4"),p.drawEdges(e,"#888888"),p.fillPoints(o,"#CCCCCC",.25*a),p.fillBoxes(t,"#0088FF44"),p.drawEdges(i),p.fillEdgePoints(i,"#000000",5),p.fillPoints(n,"#FF0000",5)}function ui(r,t,e,n=!1){let s=new R(t,e);r.addSegment(s,0,1,n,void 0)}function yo(r,t){for(let e of t){let n=new R(e.p0,e.p1);r.addSegment(n,0,1,!1,void 0)}}function fp(r,t,e,n,s,i){let o=q.fromSeedLcg(t);switch(r){case 0:{let u=o.nextIntBetween(10,30);for(let l=0;l<u;l++){let d=new f(s*o.nextFloat(),i*o.nextFloat()),m=new f(s*o.nextFloat(),i*o.nextFloat());o.nextFloat()<.5&&(d=f.roundToPrecision(d,n)),o.nextFloat()<.5&&(m=f.roundToPrecision(m,n)),ui(e,d,m)}break}case 1:{let a=[];a.push(O.fromXY(100,200,600,300)),a.push(O.fromXY(75,425,575,625)),a.push(O.fromXY(100,500,300,100)),a.push(O.fromXY(100,500,400,600)),a.push(O.fromXY(300,500,500,200)),yo(e,a);break}case 2:{let a=[];a.push(O.fromXY(200,200,500,200)),a.push(O.fromXY(500,200,500,500)),a.push(O.fromXY(500,500,200,500)),a.push(O.fromXY(200,500,200,200)),a.push(O.fromXY(300,220,400,220)),a.push(O.fromXY(400,220,400,320)),a.push(O.fromXY(400,320,300,320)),a.push(O.fromXY(300,320,300,220)),yo(e,a);break}case 3:{let a=new f(s*o.nextFloat(),i*o.nextFloat()),p=new f(s*o.nextFloat(),i*o.nextFloat()),c=o.nextFloatBetween(0,.5),u=o.nextFloatBetween(.5,1),l=f.roundToPrecision(a.lerp(p,c),n),d=f.roundToPrecision(a.lerp(p,u),n);ui(e,a,p),ui(e,l,d,!0);break}}}function vo(r,t){let e=[];for(let n of r){let s=Math.round(t*(n.x-.5)),i=Math.round(t*(n.y-.5)),o=Math.round(t);e.push(new Q(s,i,s+o,i+o))}return e}function li(r,t){let e=[];for(let n of r){let s=Math.round(t*n.x),i=Math.round(t*n.y);e.push(new f(s,i))}return e}function xo(r,t){let e=[];for(let n of r){let s=Math.round(t*n.p0.x),i=Math.round(t*n.p0.y),o=Math.round(t*n.p1.x),a=Math.round(t*n.p1.y);e.push(O.fromXY(s,i,o,a))}return e}var di=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[fo,ci]}),t.addSystems({stage:"update",fns:[ci]}),t.addDependency({stage:"start",seq:[fo,ci]})}},mi=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[hp]}),t.addSystems({stage:"update",fns:[bo,go]}),t.addDependency({stage:"update",seq:[bo,go]})}},Po={id:"main",modules:[new k,new di],schedules:T},So={id:"remote",modules:[new L,new mi],schedules:T};var te=class r{n1;n2;orig;t0;t1;vel;constructor(t,e,n,s){this.orig=t,this.vel=r.getVelocity(e,n),this.n1=e,this.n2=n,this.t0=s,this.t1=Number.POSITIVE_INFINITY}static createFrom(t){let e=t.p0,n=r.getWavefrontEdgeCw(t),s=r.getWavefrontEdgeCcw(t),i=n.p1.sub(n.p0).unit().normal().neg(),o=s.p0.sub(s.p1).unit().normal().neg();return new r(e,i,o,0)}static getVelocity(t,e){let n=t.add(e);return n.mulS(2).divS(n.lenSq())}static getWavefrontEdgeCcw(t){let e=t;do{if(e.face===void 0&&e.sym.face!==void 0)return e;e=e.onext}while(e!==t);return x.error("Fallback (ccw)"),t}static getWavefrontEdgeCw(t){let e=t;do{if(e.face!==void 0&&e.sym.face===void 0)return e;e=e.oprev}while(e!==t);return x.error("Fallback (cw)"),t}getPositionAt(t){return this.orig.addVMulS(this.vel,t-this.t0)}},Vt=class{e;t1;type;constructor(t,e,n){this.type=t,this.e=e,this.t1=n}static compareFace(t,e){let n=t.data,s=e.data,i=n.t1,o=s.t1;return i<0==o<0?i-o:o}},Ie=class{vertices;constructor(){this.vertices=[]}createStraightSkeleton(t,e){let n=t.getFaces().slice();for(;n.length>0;){n.sort((i,o)=>Vt.compareFace(i,o));let s=n[0].data;if(D(s.t1>=0,"Parameter must be positve (t = {})",s.t1),this.printEvents(n,e),e<s.t1){for(let i of n)this.updateFacePositionAt(i,e),this.dumpVerticesAt(i,e);break}for(let i of n)this.updateFacePositionAt(i,s.t1);this.handleEvent(s),s.type!==2&&n.splice(0,1);for(let i of n)this.updateFaceEvent(i)}}getVertexEdges(){let t=[];for(let e of this.vertices){let n=e.getPositionAt(e.t0),s=e.getPositionAt(e.t1);t.push(new O(n,s))}return t}initializeMesh(t){for(let e of t.getEdges()){if(e.data!==void 0)continue;let n=te.createFrom(e),s=e;do D(s.data===void 0),s.data=n,s=s.onext;while(s!==e)}for(let e of t.getFaces())this.updateFaceEvent(e)}deleteEdgeAndMerge(t){let e=t.lnext,n=e.lnext,s=t.sym,i=e.sym,o=n.sym;t.data=void 0,A.splice(s,e);let a=e;do a.p0=t.p0,a.onext.p0=t.p0,a=a.onext;while(a!==e);A.splice(t,e),A.detachPair(t),A.clear(e),A.clear(n),i.lnext.onext=o,o.lnext.onext=i,i.sym=o,o.sym=i}deleteEdgeAndSplit(t){let e=t.lnext,n=e.lnext;A.detachPair(e),e.p0=f.createZero(),e.sym.p0=f.createZero(),t.data=void 0,A.splice(t,te.getWavefrontEdgeCcw(t)),t.face=void 0,e.face=void 0,n.face=void 0}dumpVerticesAt(t,e){let n=t.start,s=n.lnext,i=s.lnext,o=n.data,a=s.data,p=i.data;o!==void 0&&(o.t1=e,this.vertices.push(o)),a!==void 0&&(a.t1=e,this.vertices.push(a)),p!==void 0&&(p.t1=e,this.vertices.push(p))}getEdgeCollapseParameter(t,e){let n=t.getPositionAt(0),s=e.getPositionAt(0),i=t.vel,a=e.vel.sub(i),p=s.sub(n);return a.dot(p.neg())/a.dot(a)}getEdgeCrashParameter(t,e,n){let s=t.getPositionAt(0),i=e.getPositionAt(0),o=n.getPositionAt(0),a=t.vel,p=i.sub(s),u=o.sub(i).unit().normal();return p.dot(u)/(1+a.dot(u))}getKineticEventTypeName(t){switch(t){case 0:return"EdgeEvent";case 1:return"SplitEvent";case 2:return"FlipEvent";case 3:return"FullEvent"}}getTriangleCollapseParameter(t,e,n){let s=t.getPositionAt(0).toVector(),i=e.getPositionAt(0).toVector(),o=n.getPositionAt(0).toVector(),a=t.vel,p=e.vel,c=n.vel,u=a.cross(p)-a.cross(c)+p.cross(c),l=s.cross(p)-s.cross(c)+i.cross(c)-i.cross(a)+o.cross(a)-o.cross(p),d=s.cross(i)-s.cross(o)+i.cross(o),m=st(u,.5*l,d);return m.type===2?m:{type:1,x:Rt(2*u,l)}}handleEvent(t){let e=t.e,n=e.lnext,s=n.lnext,i=e.data,o=n.data,a=s.data,p=t.t1;switch(t.type){case 0:{this.stopVertexAt(i,p),this.stopVertexAt(o,p);let c=i.getPositionAt(p),u=new te(c,o.n1,i.n2,p),l=n.sym,d=s.sym;this.deleteEdgeAndMerge(e),l.face!==void 0&&this.updateVerticesCw(l.sym,u),d.face!==void 0&&this.updateVerticesCcw(d,u);break}case 1:{this.stopVertexAt(i,p);let c=i.getPositionAt(p),u=new te(c,i.n1,o.n1,p),l=new te(c,a.n2,i.n2,p);this.deleteEdgeAndSplit(e),this.updateVerticesCw(e,u),this.updateVerticesCcw(s.sym,l);break}case 2:{A.swap(e),e.data=e.oprev.data,e.sym.data=e.sym.oprev.data;break}case 3:{this.stopVertexAt(i,p),this.stopVertexAt(o,p),this.stopVertexAt(a,p);break}}}handleTriangle0(t,e,n){let s=t.data,i=e.data,o=n.data,a=this.getTriangleCollapseParameter(s,i,o),p;a.type===2?a.x1<a.x2||a.x2<0?p=a.x1:p=a.x2:p=a.x;let c=s.getPositionAt(p),u=i.getPositionAt(p),l=o.getPositionAt(p),d=u.sub(c).lenSq(),m=l.sub(u).lenSq(),h=c.sub(l).lenSq(),g=d,y=t;return m>g&&(g=m,y=e),h>g&&(g=h,y=n),new Vt(2,y,p)}handleTriangle1(t,e,n){let s=t.data,i=e.data,o=n.data;D(t.sym.face!==void 0),D(e.sym.face===void 0),D(n.sym.face!==void 0);let a=this.getEdgeCrashParameter(s,i,o),p=this.getEdgeCollapseParameter(i,o);if(p<=a&&p>0)return{type:0,e,t1:p};let c=s.getPositionAt(a),u=i.getPositionAt(a),l=o.getPositionAt(a),d=u.sub(c).lenSq(),m=l.sub(u).lenSq(),h=c.sub(l).lenSq(),g=d,y=t;return m>g&&(g=m,y=e),h>g&&(g=h,y=n),y===e?new Vt(1,t,a):new Vt(2,y,a)}handleTriangle2(t,e,n){let s=t.data,i=e.data,o=n.data,a=this.getEdgeCollapseParameter(s,i),p=this.getEdgeCollapseParameter(s,o);return a<p||p<0?new Vt(0,t,a):new Vt(0,n,p)}handleTriangle3(t,e){let n=t.data,s=e.data,i=this.getEdgeCollapseParameter(n,s);return new Vt(3,t,i)}printEdgesLnext(t,e){x.infoDebug("lnext");let n=0;for(let s of t.getLnextIterator())x.infoDebug("  [{}] p0: {}",n,s.p0),x.infoDebug("      p1: {}",s.p1),e&&s.validate(),n++}printEdgesOnext(t,e){x.infoDebug("onext");let n=0;for(let s of t.getOnextIterator())x.infoDebug("  [{}] p0: {}",n,s.p0),x.infoDebug("      p1: {}",s.p1),x.infoDebug("      angle: {}",s.p1.sub(s.p0).angle()*180/Math.PI),e&&(D(s.data===t.data),s.validate()),n++}printEvents(t,e){x.infoDebug("******************************************************************"),x.infoDebug("Parameter = {}",e),x.infoDebug("******************************************************************");for(let n=0;n<t.length;n++){let i=t[n].data;x.infoDebug("[{}] type = {}",n,this.getKineticEventTypeName(i.type)),x.infoDebug("    t = {}",i.t1),x.infoDebug("    edge = {}",i.e.p0),x.infoDebug("           {}",i.e.p1)}}printFace(t){x.infoDebug("******************************************************************");let e=t.start,n=e.lnext,s=n.lnext;x.infoDebug("Face: e0 = {}",e.p0),x.infoDebug("           {}",e.p1),x.infoDebug("      e1 = {}",n.p0),x.infoDebug("           {}",n.p1),x.infoDebug("      e2 = {}",s.p0),x.infoDebug("           {}",s.p1)}printVerticesAt(t,e){x.infoDebug("******************************************************************");let n=t.start,s=n.lnext,i=s.lnext,o=n.data,a=s.data,p=i.data;x.infoDebug("vtx0: pos = {}",o.getPositionAt(e)),x.infoDebug("      vel = {}",o.vel),x.infoDebug("       n1 = {}",o.n1),x.infoDebug("       n2 = {}",o.n2),x.infoDebug("vtx1: pos = {}",a.getPositionAt(e)),x.infoDebug("      vel = {}",a.vel),x.infoDebug("       n1 = {}",a.n1),x.infoDebug("       n2 = {}",a.n2),x.infoDebug("vtx2: pos = {}",p.getPositionAt(e)),x.infoDebug("      vel = {}",p.vel),x.infoDebug("       n1 = {}",p.n1),x.infoDebug("       n2 = {}",p.n2)}stopVertexAt(t,e){t.t1=e,this.vertices.push(t)}updateEdgePositionAt(t,e){let n=t.data,s=t.sym.data;t.p0=n.getPositionAt(e),t.sym.p0=s.getPositionAt(e)}updateFaceEvent(t){let e=t.start,n=e.lnext,s=n.lnext,i;e.sym.face===void 0?n.sym.face===void 0?s.sym.face===void 0?i=this.handleTriangle3(e,n):i=this.handleTriangle2(n,s,e):s.sym.face===void 0?i=this.handleTriangle2(e,n,s):i=this.handleTriangle1(s,e,n):n.sym.face===void 0?s.sym.face===void 0?i=this.handleTriangle2(s,e,n):i=this.handleTriangle1(e,n,s):s.sym.face===void 0?i=this.handleTriangle1(n,s,e):i=this.handleTriangle0(e,n,s),t.data=i}updateFacePositionAt(t,e){let n=t.start,s=n.lnext,i=s.lnext;this.updateEdgePositionAt(n,e),this.updateEdgePositionAt(s,e),this.updateEdgePositionAt(i,e)}updateVerticesCcw(t,e){let n=t;do n.data=e,n=n.onext;while(n!==t)}updateVerticesCw(t,e){let n=t;do n.data=e,n=n.oprev;while(n!==t)}};function Eo(r){let{inputElements:t}=r.readData("app-input"),e=new B("time","0","500","50");e.setStyle("width: 200px"),t.push(e),r.writeData({dataId:"app-part-main",inputTime:e})}function bp(r){r.writeData({dataId:"app-part-remote",mesh:K.createEmpty(),meshOriginal:K.createEmpty(),skeleton:new Ie})}function hi(r){let{inputTime:t}=r.readData("app-part-main"),e={dataId:"app-part-state",time:t.getInt()};r.writeData(e),r.getChannel("remote").queueData(e)}function Mo(r){let{time:t}=r.readData("app-part-state"),{seed:e,generator:n}=r.readData("app-state"),s=r.getPlugin("app-context"),i=q.fromSeedLcg(e),[o,a]=s.getSize(!1),p=new Q(0,0,o,a),c=t,l=qi(i,p,n,1,0).toPath().toMesh(0),d=l.clone();l.triangulate(!1);let m=new Ie;m.initializeMesh(l),m.createStraightSkeleton(l,c),r.writeData({dataId:"app-part-remote",mesh:l,meshOriginal:d,skeleton:m})}function Co(r){let{skeleton:t,meshOriginal:e,mesh:n}=r.readData("app-part-remote"),s=r.getPlugin("app-context");s.clear(),s.drawEdges(t.getVertexEdges(),"#FF0000"),s.drawMeshEdges(e,"#000000"),s.drawMeshEdges(n,"#00FF00")}var fi=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Eo,hi]}),t.addSystems({stage:"update",fns:[hi]}),t.addDependency({stage:"start",seq:[Eo,hi]})}},bi=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[bp]}),t.addSystems({stage:"update",fns:[Mo,Co]}),t.addDependency({stage:"update",seq:[Mo,Co]})}},Io={id:"main",modules:[new k,new fi],schedules:T},Ao={id:"remote",modules:[new L,new bi],schedules:T};function Do(r){let{inputElements:t}=r.readData("app-input"),e=new B("parameter","0","200","100");e.setStyle("width: 200px"),t.push(e);let n=new Y("boolOp","union");n.setOptionValues("union","intersection","exclusion","awithoutb","bwithouta"),t.push(n);let s=new Y("windA","nonzero");s.setOptionValues("nonzero","evenodd","positive","negative","absgeqtwo"),t.push(s);let i=new Y("windB","nonzero");i.setOptionValues("nonzero","evenodd","positive","negative","absgeqtwo"),t.push(i);let o=new Y("options","triangulate");o.setOptionValues("monotonize","triangulate","triangulateOpt"),t.push(o),r.writeData({dataId:"app-part-main",inputParameter:e,inputBoolOp:n,inputWindA:s,inputWindB:i,inputOptions:o})}function gp(r){r.writeData({dataId:"app-part-remote",polygonA:tt.createEmpty(),polygonB:tt.createEmpty(),error:w.createEmpty(),mesh:K.createEmpty()})}function gi(r){let{inputParameter:t,inputBoolOp:e,inputWindA:n,inputWindB:s,inputOptions:i}=r.readData("app-part-main"),o={dataId:"app-part-state",parameter:t.getInt(),boolOp:e.getValue(),windA:n.getValue(),windB:s.getValue(),options:i.getValue()};r.writeData(o),r.getChannel("remote").queueData(o)}function wo(r){let{parameter:t,boolOp:e,windA:n,windB:s,options:i}=r.readData("app-part-state"),{seed:o,generator:a}=r.readData("app-state"),p=r.getPlugin("app-context"),c=2*(t-100),u=q.fromSeedLcg(o),[l,d]=p.getSize(!1),[m,h]=ce(u,a,c,l,d),g=new mt(H);for(let P of m.getEdges())g.addEdge(P,0);for(let P of h.getEdges())g.addEdge(P,1);let y=K.createEmpty();switch(g.process(y,{booleanOperator:En(e),windingOperatorA:Qt(n),windingOperatorB:Qt(s)}),i){case"monotonize":{y.monotonize();break}case"triangulate":{y.triangulate(!1);break}case"triangulateOpt":{y.triangulate(!0);break}}y.validate();let v=w.createEmpty();for(let P of y.getFaces()){let M=P.getSignedArea();M<=0&&x.warn("Negative path area: {}",M),P.isMonotoneInX()||(P.writeToPath(v),x.error("Face not monotone"))}r.writeData({dataId:"app-part-remote",error:v,mesh:y,polygonA:m,polygonB:h})}function To(r){let{mesh:t,error:e}=r.readData("app-part-remote"),{seed:n}=r.readData("app-state"),s=r.getPlugin("app-context"),i=q.fromSeedLcg(n);s.clear(),s.fillMeshRandom(t,i);let o=s.createLinePattern(10,"#FF0000")??"#FF000022";s.fillPath(e,o),s.drawMeshEdges(t,"#AAAAAA",1.5)}var yi=class{moduleId="app-part-main";setup(t){t.registerData("app-part-main"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[Do,gi]}),t.addSystems({stage:"update",fns:[gi]}),t.addDependency({stage:"start",seq:[Do,gi]})}},vi=class{moduleId="app-part-remote";setup(t){t.addModules([new N]),t.registerData("app-part-remote"),t.registerData("app-part-state"),t.addSystems({stage:"start",fns:[gp]}),t.addSystems({stage:"update",fns:[wo,To]}),t.addDependency({stage:"update",seq:[wo,To]})}},Oo={id:"main",modules:[new k,new yi],schedules:T},Ro={id:"remote",modules:[new L,new vi],schedules:T};var jn=class{moduleId="app-launcher";appPartIds;appPartId;constructor(t,e){this.appPartIds=t,this.appPartId=e}setup(t){t.registerData("app-launcher"),t.writeData({dataId:"app-launcher",appPartIds:this.appPartIds,appPartId:this.appPartId})}};var Qn=class{context;entriesByParts;entriesByWorldGroups;constructor(t){this.context=t,this.entriesByParts=new Map,this.entriesByWorldGroups=new Map}addPart(t,...e){let n=t.id,s={partOptions:t,worldGroupOptions:e};this.entriesByParts.set(n,s);for(let i of e)this.entriesByWorldGroups.has(i.id)&&F("Duplicate world group id '{}' found",i.id,i.id),this.entriesByWorldGroups.set(i.id,s)}run(t){let e=this.getEntry(t),n=new Le(this.context),s=[...this.entriesByParts.keys()];for(let i of e.worldGroupOptions){if(i.parent===void 0)for(let o of i.worlds){let a=new jn(s,e.partOptions.id);o.modules.push(a)}n.addWorldGroup(i)}n.run(e.partOptions.runWorldId,e.partOptions.runScheduleId)}getEntry(t){if(this.context.isMain){let n=new URLSearchParams(window.location.search).get("app")??t,s=this.entriesByParts.get(n);return s===void 0&&(s=this.entriesByParts.get(t),s===void 0&&F("Default app part '{}' not found",t)),s}else{let e=this.context.selfName;e===void 0&&F("error",t);let n=this.entriesByWorldGroups.get(e);return n===void 0&&F("Entry '{}' not found",e),n}}};var yp=new Ve("index.js"),nt=new Qn(yp);nt.addPart({id:"bplus-tree",runWorldId:"main",runScheduleId:"start"},{id:"bplus-tree-main",parent:void 0,worlds:[Zi]},{id:"bplus-tree-remote",parent:"bplus-tree-main",worlds:[Hi]});nt.addPart({id:"ecs-bounce",runWorldId:"main",runScheduleId:"start"},{id:"ecs-bounce-main",parent:void 0,worlds:[nr]},{id:"ecs-bounce-remote",parent:"ecs-bounce-main",worlds:[sr]});nt.addPart({id:"gpu-cube",runWorldId:"main",runScheduleId:"start"},{id:"gpu-cube-main",parent:void 0,worlds:[hr]},{id:"gpu-cube-remote",parent:"gpu-cube-main",worlds:[fr]});nt.addPart({id:"image",runWorldId:"main",runScheduleId:"start"},{id:"image-main",parent:void 0,worlds:[xr]},{id:"image-remote",parent:"image-main",worlds:[Pr]});nt.addPart({id:"matrix",runWorldId:"main",runScheduleId:"start"},{id:"matrix-main",parent:void 0,worlds:[Cr]},{id:"matrix-remote",parent:"matrix-main",worlds:[Ir]});nt.addPart({id:"mesh",runWorldId:"main",runScheduleId:"start"},{id:"mesh-main",parent:void 0,worlds:[Tr]},{id:"mesh-remote",parent:"mesh-main",worlds:[Or]});nt.addPart({id:"path-area",runWorldId:"main",runScheduleId:"start"},{id:"path-area-main",parent:void 0,worlds:[Br]},{id:"path-area-remote",parent:"path-area-main",worlds:[Fr]});nt.addPart({id:"path-clip",runWorldId:"main",runScheduleId:"start"},{id:"path-clip-main",parent:void 0,worlds:[qr]},{id:"path-clip-remote",parent:"path-clip-main",worlds:[Nr]});nt.addPart({id:"path-intersection",runWorldId:"main",runScheduleId:"start"},{id:"path-intersection-main",parent:void 0,worlds:[Gr]},{id:"path-intersection-remote",parent:"path-intersection-main",worlds:[Yr]});nt.addPart({id:"path-operations",runWorldId:"main",runScheduleId:"start"},{id:"path-operations-main",parent:void 0,worlds:[Kr]},{id:"path-operations-remote",parent:"path-operations-main",worlds:[$r]});nt.addPart({id:"path-overlay",runWorldId:"main",runScheduleId:"start"},{id:"path-overlay-main",parent:void 0,worlds:[eo]},{id:"path-overlay-remote",parent:"path-overlay-main",worlds:[no]});nt.addPart({id:"playground",runWorldId:"main",runScheduleId:"start"},{id:"playground-main",parent:void 0,worlds:[oo]},{id:"playground-remote",parent:"playground-main",worlds:[ao]});nt.addPart({id:"sampling",runWorldId:"main",runScheduleId:"start"},{id:"sampling-main",parent:void 0,worlds:[mo]},{id:"sampling-remote",parent:"sampling-main",worlds:[ho]});nt.addPart({id:"snap-rounding",runWorldId:"main",runScheduleId:"start"},{id:"snap-rounding-main",parent:void 0,worlds:[Po]},{id:"snap-rounding-remote",parent:"snap-rounding-main",worlds:[So]});nt.addPart({id:"straight-skeleton",runWorldId:"main",runScheduleId:"start"},{id:"straight-skeleton-main",parent:void 0,worlds:[Io]},{id:"straight-skeleton-remote",parent:"straight-skeleton-main",worlds:[Ao]});nt.addPart({id:"triangulate",runWorldId:"main",runScheduleId:"start"},{id:"triangulate-main",parent:void 0,worlds:[Oo]},{id:"triangulate-remote",parent:"triangulate-main",worlds:[Ro]});nt.run("ecs-bounce");
